<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MWI Market Trends</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            /* Light Theme Definitions */
            --bg-color: #f6f8fa;
            --card-bg-color: #ffffff;
            --text-color-primary: #24292f;
            --text-color-secondary: #57606a;
            --muted-text-color: #57606a;
            --border-color: #d0d7de;
            --accent-color: #0969da;
            --accent-hover-color: #0550ae;
            --positive-color: #1a7f37;
            --negative-color: #cf222e;
            --info-color: #0969da; /* For general messages */
            --warning-color: #d29922; /* For warnings like pinning limit */
            --button-bg-color: #f6f8fa;
            --button-hover-bg-color: #f0f2f4;
            --button-border-color: rgba(27, 31, 36, 0.15);
            --button-hover-border-color: rgba(27, 31, 36, 0.35);
            --button-active-bg-color: var(--accent-color);
            --button-active-text-color: #ffffff;
            --button-active-border-color: var(--accent-color);
            --input-bg-color: var(--card-bg-color);
            --input-border-color: var(--border-color);
            --input-focus-border-color: var(--accent-color);
            --input-focus-shadow-color: rgba(9, 105, 218, 0.3);
            --table-header-bg: #f6f8fa;
            --table-row-even-bg: #fbfcfd;
            --table-row-hover-bg: #f6f8fa;
            --table-row-selected-bg: #ddf4ff;
            --link-color: var(--accent-color);
            --link-hover-color: var(--accent-hover-color);
            --code-font: SFMono-Regular, Consolas, "Liberation Mono", Menlo, Courier, monospace;
            --na-value-color: #cdd4de;
            --chart-placeholder-color: #b0b8c2;
            --pin-color: #d0d7de; /* Color for unpinned star */
            --pin-color-active: #ffab00; /* Color for pinned star (gold) */
            --message-bg-error: rgba(207, 34, 46, 0.1);
            --message-border-error: var(--negative-color);
            --message-text-error: var(--negative-color);
            --message-bg-warning: rgba(210, 153, 34, 0.1);
            --message-border-warning: var(--warning-color);
            --message-text-warning: #b08820; /* Darker warning text for light bg */
            --message-bg-info: rgba(9, 105, 218, 0.1);
            --message-border-info: var(--info-color);
            --message-text-info: var(--info-color);
            --indices-bg: var(--card-bg-color);
            --indices-border: var(--border-color);
            --indices-title-color: var(--text-color-secondary);
            --index-item-bg: var(--bg-color);
        }

        html[data-theme="dark"] {
             /* Dark Theme Overrides */
            --bg-color: #0d1117;
            --card-bg-color: #161b22;
            --text-color-primary: #c9d1d9;
            --text-color-secondary: #8b949e;
            --muted-text-color: #8b949e;
            --border-color: #30363d;
            --accent-color: #58a6ff;
            --accent-hover-color: #79c0ff;
            --positive-color: #3fb950;
            --negative-color: #f85149;
            --info-color: #58a6ff;
            --warning-color: #e3b341;
            --button-bg-color: #21262d;
            --button-hover-bg-color: #30363d;
            --button-border-color: #30363d;
            --button-hover-border-color: #8b949e;
            --button-active-bg-color: var(--accent-color);
            --button-active-text-color: #ffffff;
            --button-active-border-color: var(--accent-color);
            --input-bg-color: var(--card-bg-color);
            --input-border-color: var(--border-color);
            --input-focus-border-color: var(--accent-color);
            --input-focus-shadow-color: rgba(88, 166, 255, 0.3);
            --table-header-bg: #161b22;
            --table-row-even-bg: #1a1f27;
            --table-row-hover-bg: #21262d;
            --table-row-selected-bg: #1f6feb;
            --link-color: var(--accent-color);
            --link-hover-color: var(--accent-hover-color);
            --na-value-color: #484f58;
            --chart-placeholder-color: #6e7681;
            --pin-color: #484f58; /* Dark mode unpinned star */
            --pin-color-active: #f1e05a; /* Dark mode pinned star (lighter gold) */
            --message-bg-error: rgba(248, 81, 73, 0.15);
            --message-border-error: var(--negative-color);
            --message-text-error: var(--negative-color);
            --message-bg-warning: rgba(227, 179, 65, 0.15);
            --message-border-warning: var(--warning-color);
            --message-text-warning: var(--warning-color);
            --message-bg-info: rgba(88, 166, 255, 0.15);
            --message-border-info: var(--info-color);
            --message-text-info: var(--info-color);
            --indices-bg: var(--card-bg-color);
            --indices-border: var(--border-color);
            --indices-title-color: var(--text-color-secondary);
            --index-item-bg: var(--bg-color);
        }

        /* --- General Styles (Using Variables) --- */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif; margin: 0; padding: 0;
            background-color: var(--bg-color); color: var(--text-color-primary);
            line-height: 1.5; font-size: 14px;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .container { max-width: 1600px; margin: 25px auto; padding: 0 25px; }
        h1 { text-align: center; color: var(--text-color-primary); margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600; font-size: 1.8em; letter-spacing: -0.5px; }
        .subheader {
            text-align: center;
            color: var(--text-color-secondary);
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-size: 1.1em;
            font-weight: 400;
        }
        h2 { text-align: center; color: var(--text-color-secondary); margin-top: 1rem; margin-bottom: 1.5rem; font-weight: 500; font-size: 1.3em; }

        /* Container for the buttons under title */
        .title-button-container {
            text-align: center; margin-bottom: 15px;
            display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;
        }
        /* Style for action buttons */
        .action-button {
            padding: 6px 16px; font-size: 0.9em; font-weight: 500;
            background-color: var(--button-bg-color); color: var(--text-color-primary);
            border: 1px solid var(--button-border-color); border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .action-button:hover { background-color: var(--button-hover-bg-color); }
        /* Icon visibility styles */
        #theme-toggle-btn .fa-sun { display: none; }
        #theme-toggle-btn .fa-moon { display: inline-block; }
        html[data-theme="dark"] #theme-toggle-btn .fa-sun { display: inline-block; }
        html[data-theme="dark"] #theme-toggle-btn .fa-moon { display: none; }
        #toggle-indices-btn .fa-eye-slash { display: none; }
        #toggle-indices-btn.indices-hidden .fa-eye-slash { display: inline-block; }
        #toggle-indices-btn.indices-hidden .fa-eye { display: none; }

        /* NEW: Language Selector Style */
        #language-selector {
            padding: 5px 8px;
            font-size: 0.9em;
            border-radius: 6px;
            border: 1px solid var(--button-border-color);
            background-color: var(--button-bg-color);
            color: var(--text-color-primary);
            cursor: pointer;
        }


        /* Feedback Link */
        .feedback-link-container { text-align: center; margin-bottom: 20px; font-size: 0.9em; }
        .feedback-link-container a { color: var(--muted-text-color); text-decoration: none; border-bottom: 1px dashed var(--muted-text-color); transition: color 0.2s, border-color 0.2s; padding-bottom: 1px; }
        .feedback-link-container a:hover { color: var(--link-color); border-color: var(--link-color); }

        /* Message Area Styles */
        #message-area {
            padding: 10px 15px; margin-bottom: 20px; border-radius: 6px;
            font-size: 0.9em; font-weight: 500;
            border: 1px solid transparent;
            background-color: transparent;
            color: transparent;
            display: none; /* Hidden by default */
            transition: all 0.3s ease-in-out;
            text-align: center;
        }
        #message-area.visible { display: block; }
        #message-area.error {
            background-color: var(--message-bg-error);
            border-color: var(--message-border-error);
            color: var(--message-text-error);
        }
        #message-area.warning {
            background-color: var(--message-bg-warning);
            border-color: var(--message-border-warning);
            color: var(--message-text-warning);
        }
         #message-area.info {
            background-color: var(--message-bg-info);
            border-color: var(--message-border-info);
            color: var(--message-text-info);
        }

        /* Controls Bar */
        .controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 16px 20px; margin-bottom: 15px; gap: 15px; background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 6px; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;}
        .controls-left, .controls-right { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
        label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: var(--text-color-secondary); }
        input[type="text"], input[type="number"], select {
            display: block; width: 100%; padding: 0.5rem 0.75rem; font-size: 0.875rem;
            line-height: 1.5; color: var(--text-color-primary); background-color: var(--input-bg-color);
            background-clip: padding-box; border: 1px solid var(--input-border-color);
            appearance: none; border-radius: 0.375rem;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out, background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            color: var(--text-color-primary); background-color: var(--input-bg-color);
            border-color: var(--input-focus-border-color); outline: 0;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.075), 0 0 0 0.25rem var(--input-focus-shadow-color);
        }
        input[type="checkbox"], input[type="radio"] { margin-right: 0.3rem; vertical-align: middle; }
        .search-form input[type="text"] { min-width: 200px; }
        .category-filter select { min-width: 180px; }

        /* Sort Options */
        .sort-options span { font-weight: 600; color: var(--text-color-secondary); margin-right: 4px; font-size: 0.9em; }
        .sort-options button { padding: 5px 12px; background-color: var(--button-bg-color); color: var(--text-color-primary); border-radius: 6px; font-size: 0.9em; transition: background-color 0.1s ease-in-out, border-color 0.1s ease-in-out; border: 1px solid var(--button-border-color); box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04); cursor: pointer; font-weight: 500; line-height: 20px; }
        .sort-options button:hover { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .sort-options button.current-sort { background-color: var(--button-active-bg-color); color: var(--button-active-text-color); border-color: var(--button-active-border-color); font-weight: 600; }

        /* Market Indices Display Styles */
        .market-indices {
            background-color: var(--indices-bg);
            border: 1px solid var(--indices-border);
            border-radius: 6px;
            padding: 15px 20px;
            margin-bottom: 30px;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .market-indices h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--indices-title-color);
            text-align: center;
            border-bottom: 1px solid var(--indices-border);
            padding-bottom: 8px;
        }
        .market-indices-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .index-item {
            background-color: var(--index-item-bg);
            border: 1px solid var(--indices-border);
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 150px;
        }
        .index-item .category-name {
            font-weight: 500;
            color: var(--text-color-secondary);
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .index-item .trend-value-container {
           font-size: 1em;
           font-weight: 600;
           white-space: nowrap;
        }


        /* Main Layout */
        .main-layout { display: flex; flex-wrap: wrap; gap: 25px; }
        .item-table-container {
            flex: 2.5; /* User specified */
            min-width: 500px;
        }
        .chart-display-container {
            flex: 1.5; /* User specified */
            min-width: 380px;
        }

        /* Table Styles */
        .table-wrapper {
            max-height: 78vh;
            overflow-y: auto;
            overflow-x: auto; /* Allow horizontal scroll for table */
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--card-bg-color);
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        #item-table { width: 100%; border-collapse: collapse; }
        #item-table th, #item-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; font-size: 0.90em; }
        #item-table th { background-color: var(--table-header-bg); font-weight: 600; font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted-text-color); position: sticky; top: 0; z-index: 1; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;}
        #item-table th.pin-header { width: 35px; text-align: center; padding: 10px 5px;}
        #item-table td.pin-cell { text-align: center; padding: 10px 5px;}
        .pin-icon { cursor: pointer; color: var(--pin-color); font-size: 1.1em; transition: color 0.15s ease-in-out; }
        .pin-icon.pinned { color: var(--pin-color-active); }
        .pin-icon:hover { opacity: 0.7; }

        /* Table Row Styles */
        #item-table tbody tr { transition: background-color 0.15s ease; }
        #item-table tbody tr:nth-child(even) { background-color: var(--table-row-even-bg); }
        #item-table tbody tr:hover { background-color: var(--table-row-hover-bg); }
        #item-table tbody tr.selected-item { background-color: var(--table-row-selected-bg); font-weight: 500; }
        #item-table td { color: var(--text-color-primary); }
        #item-table td:nth-child(2) { font-weight: 500; /* Name */ }
        #item-table td:nth-child(2) .item-name-link { color: var(--link-color); cursor: pointer; text-decoration: none; }
        #item-table td:nth-child(2) .item-name-link:hover { text-decoration: underline; color: var(--link-hover-color); }
        #item-table td:nth-child(3) { font-size: 0.9em; color: var(--muted-text-color); max-width: 150px; overflow: hidden; text-overflow: ellipsis; } /* Category */
        #item-table td:nth-child(5) { text-align: right; font-family: var(--code-font); font-size: 0.90em; } /* Buy */
        #item-table td:nth-child(6) { text-align: right; font-family: var(--code-font); font-size: 0.90em; } /* Trend */
        #item-table td:nth-child(4) { text-align: right; font-family: var(--code-font); font-size: 0.90em; } /* Ask */
        #item-table td:nth-child(7) { text-align: right; font-family: var(--code-font); font-size: 0.90em; } /* Volatility */


        /* Trend Styles */
        .trend-value-container { display: flex; align-items: center; justify-content: flex-end; gap: 3px; }
        .trend-icon { width: 14px; height: 14px; vertical-align: text-bottom; }
        .trend-positive { color: var(--positive-color); }
        .trend-negative { color: var(--negative-color); }
        .na-value { color: var(--na-value-color); font-style: normal; }

        /* Chart Display Styles */
        .chart-display { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 20px; min-height: 450px; position: relative; display: flex; flex-direction: column; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;}
        .chart-controls-container { /* Container for all chart controls */
             display: flex;
             justify-content: center; /* Center inner divs */
             align-items: center;
             flex-wrap: wrap; /* Allow wrapping */
             gap: 15px; /* Space between control groups */
             margin-bottom: 15px;
        }
        .chart-controls { text-align: center; } /* Original class for time */
        .scale-controls { text-align: center; } /* New class for scale toggle */
        .chart-controls button, .scale-controls button { margin: 0 4px; padding: 5px 10px; font-size: 0.85em; background-color: var(--button-bg-color); border: 1px solid var(--button-border-color); box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04); border-radius: 6px; cursor: pointer; transition: background-color 0.1s ease-in-out, border-color 0.1s ease-in-out; font-weight: 500; color: var(--text-color-primary);}
        .chart-controls button:hover, .scale-controls button:hover { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .chart-controls button.active, .scale-controls button.active { background-color: var(--button-active-bg-color); color: var(--button-active-text-color); border-color: var(--button-active-border-color); font-weight: 600; }
        .chart-placeholder { text-align: center; color: var(--chart-placeholder-color); padding: 60px; font-size: 1.05em; flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        .chart-plot { flex-grow: 1; position: relative; min-height: 320px; }
        .chart-plot canvas { max-width: 100%; max-height: 380px; }

        /* Pagination */
        .pagination { text-align: center; margin-top: 20px; padding-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .pagination button { padding: 7px 14px; background-color: var(--button-bg-color); border: 1px solid var(--button-border-color); box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04); color: var(--accent-color); border-radius: 6px; transition: background-color 0.1s, border-color 0.1s; cursor: pointer; font-weight: 500; font-size: 0.9em; }
        .pagination button:hover:not(:disabled) { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .pagination button.current { background-color: var(--button-active-bg-color); color: var(--button-active-text-color); border-color: var(--button-active-border-color); font-weight: bold; cursor: default; }
        .pagination button:disabled { color: var(--muted-text-color); background-color: var(--button-bg-color); opacity: 0.6; cursor: not-allowed; border-color: transparent; }
        #page-info { font-size: 0.9em; color: var(--text-color-secondary); }

        /* Loading/Error Messages */
        .loading-message { text-align: center; padding: 40px; font-size: 1.1em; color: var(--muted-text-color); }
        .hidden { display: none; }

        /* Footer */
        footer { text-align: center; margin-top: 60px; padding: 25px 0; font-size: 0.8em; color: var(--muted-text-color); border-top: 1px solid var(--border-color); transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;}
        footer span, footer a { margin: 0 8px; color: var(--muted-text-color); text-decoration: none; }
        footer a:hover { text-decoration: underline; color: var(--link-hover-color); }

        /* Responsive Styles */
         @media (max-width: 768px) {
             .controls { flex-direction: column; align-items: stretch; }
             .controls-left, .controls-right { width: 100%; justify-content: center; }
             .search-form input[type="text"], .category-filter select { width: 100%; min-width: unset; }
             .main-layout { flex-direction: column; }
             .item-table-container, .chart-display-container { min-width: unset; }
             .table-wrapper { max-height: 60vh; }
             h1 { font-size: 1.5em; }
             .chart-controls-container { flex-direction: column; gap: 10px; }
             .market-indices-container { justify-content: flex-start; }
             #item-table th, #item-table td { font-size: 0.85em; padding: 8px 10px; }
        }
         @media (max-width: 480px) {
              .sort-options button { padding: 4px 8px; font-size: 0.8em;} /* Smaller sort buttons */
         }

    </style>
</head>
<body>

    <div class="container">
        <h1 data-translate-key="mainTitle">MWI Market Trends</h1>
        <p class="subheader" data-translate-key="subHeaderText">I can't read Chinese :/</p>
        <div class="title-button-container" >
             <button id="theme-toggle-btn" class="action-button" title="Toggle Theme">
                 <i class="fas fa-moon"></i><i class="fas fa-sun"></i>
                 <span class="toggle-text" data-translate-key="toggleTheme" style="margin-left: 6px;">Toggle Theme</span>
             </button>
             <button id="toggle-indices-btn" class="action-button" title="Toggle Market Indices">
                 <i class="fas fa-eye"></i><i class="fas fa-eye-slash"></i>
                 <span class="toggle-text" data-translate-key="toggleIndices" style="margin-left: 6px;">Hide Indices</span>
             </button>
             <select id="language-selector" title="Select Language">
                 <option value="en">English</option>
                 <option value="zh">中文</option>
             </select>
        </div>
        <div class="feedback-link-container">
            <a href="https://github.com/SporkSlinger/market-tracker-mwi/issues" target="_blank" rel="noopener noreferrer" data-translate-key="reportIssue">Report an Issue or Suggest a Feature</a>
        </div>

        <div id="message-area"></div>

        <div class="controls">
            <div class="controls-left">
                 <div class="search-form">
                     <label for="search-input" data-translate-key="searchLabel">Search</label>
                     <input type="text" id="search-input" data-translate-key-placeholder="searchPlaceholder" placeholder="Product Name...">
                 </div>
                 <div class="category-filter">
                      <label for="category-filter" data-translate-key="categoryLabel">Category</label>
                      <select id="category-filter">
                          <option value="All" data-translate-key="allCategories">All Categories</option>
                          </select>
                 </div>
            </div>
            <div class="controls-right">
                 <div class="sort-options" id="sort-options">
                     <span data-translate-key="sortBy">Sort By:</span>
                     <button data-sort="name" class="current-sort" data-translate-key="sortName">Name</button>
                     <button data-sort="category" data-translate-key="sortCategory">Category</button>
                     <button data-sort="ask" data-translate-key="sortAsk">Ask</button>
                     <button data-sort="buy" data-translate-key="sortBuy">Buy</button>
                     <button data-sort="trend" data-translate-key="sortTrend">Trend %</button>
                     <button data-sort="volatility" data-translate-key="sortVolatility">Volatility</button>
                 </div>
            </div>
        </div>

        <div id="market-indices-display" class="market-indices hidden">
            <h3 data-translate-key="indicesTitle">Market Indices (24h Trend Average)</h3>
            <div id="market-indices-container" class="market-indices-container">
                <span class="loading-message" data-translate-key="indicesLoading">Loading indices...</span>
            </div>
        </div>
        <div class="main-layout">
            <div class="item-table-container">
                <div id="loading-message" class="loading-message" data-translate-key="tableLoading">Loading market data...</div>
                <div class="table-wrapper hidden">
                    <table id="item-table">
                        <thead>
                            <tr>
                                <th class="pin-header" data-translate-key="colPin"><i class="fas fa-thumbtack"></i></th>
                                <th data-translate-key="colName">Name</th>
                                <th data-translate-key="colCategory">Category</th>
                                <th data-translate-key="colAsk">Ask</th>
                                <th data-translate-key="colBuy">Buy</th>
                                <th data-translate-key="colTrend">Trend (24h)</th>
                                <th data-translate-key="colVolatility">Volatility (7d)</th>
                            </tr>
                        </thead>
                        <tbody id="item-table-body"></tbody>
                    </table>
                </div>
                <div class="pagination" id="pagination" style="display: none;">
                    <button id="prev-page" disabled data-translate-key="prevPage">&laquo; Previous</button>
                    <span id="page-info">Page 1 of 1</span> <button id="next-page" disabled data-translate-key="nextPage">Next &raquo;</button>
                </div>
            </div>

            <div class="chart-display-container">
                <div class="chart-display" id="chart-display">
                     <div class="chart-controls-container" id="chart-controls-area" style="display: none;">
                          <div class="chart-controls" id="chart-time-controls">
                              <button data-range="24h">24h</button>
                              <button data-range="48h">48h</button>
                              <button data-range="7d">7d</button>
                              <button data-range="30d" class="active">30d</button>
                          </div>
                           <div class="scale-controls">
                               <button id="scale-toggle-btn">Switch to Linear Scale</button>
                           </div>
                     </div>
                     <div class="chart-placeholder" id="chart-placeholder" data-translate-key="chartPlaceholderSelect">Select an item name from the table to view its chart.</div>
                     <div class="chart-plot hidden">
                        <canvas id="single-chart-canvas"></canvas>
                     </div>
                     </div>
            </div>
        </div>

        <footer>
            <span data-translate-key="footerMadeBy">Made by Sporky with AI</span> |
            <span class="status"><span data-translate-key="footerStatus">Data Fetched:</span> <span id="last-update">N/A</span></span> |
            <a href="https://github.com/SporkSlinger/market-tracker-mwi" target="_blank" rel="noopener noreferrer" data-translate-key="footerRepo">GitHub Repo</a>
        </footer>

        </div> <script>
        // --- Global State ---
        let allMarketData = {};
        let marketSummary = [];
        let marketIndicesData = {};
        let gameData = { itemDetailMap: {} };
        let filteredAndSortedSummary = [];
        let currentChart = null;
        let currentPage = 1;
        const itemsPerPage = 20;
        let currentSort = 'name_asc';
        let currentSearch = '';
        let currentCategoryFilter = 'All';
        let selectedTableRow = null;
        let currentChartProduct = null;
        let currentChartTimeRange = '30d';
        let currentYScaleType = 'logarithmic';
        let pinnedItems = [];
        const PINNED_ITEMS_KEY = 'mwiPinnedItems';
        const MAX_PINNED_ITEMS = 10;
        let messageTimeout = null;
        let currentLanguage = 'en'; // Default language
        const LANG_STORAGE_KEY = 'mwiMarketLang';

        // --- DOM Elements ---
        const tableBodyEl = document.getElementById('item-table-body');
        const tableWrapperEl = document.querySelector('.table-wrapper');
        const paginationEl = document.getElementById('pagination');
        const pageInfoEl = document.getElementById('page-info');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        const searchInput = document.getElementById('search-input');
        const categoryFilterEl = document.getElementById('category-filter');
        const sortOptionsEl = document.getElementById('sort-options');
        const chartCanvas = document.getElementById('single-chart-canvas');
        const chartPlotContainer = document.querySelector('.chart-plot');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const chartTimeControlsEl = document.getElementById('chart-time-controls');
        const chartControlsArea = document.getElementById('chart-controls-area');
        const scaleToggleButton = document.getElementById('scale-toggle-btn');
        const loadingMessageEl = document.getElementById('loading-message');
        const messageAreaEl = document.getElementById('message-area');
        const themeToggleButton = document.getElementById('theme-toggle-btn');
        const lastUpdateEl = document.getElementById('last-update');
        const marketIndicesDisplayEl = document.getElementById('market-indices-display');
        const marketIndicesContainerEl = document.getElementById('market-indices-container');
        const toggleIndicesBtn = document.getElementById('toggle-indices-btn');
        const languageSelector = document.getElementById('language-selector'); // NEW: Language selector

        // --- Translations ---
        const translations = {
          'en': {
            'mainTitle': 'MWI Market Trends',
            'subHeaderText': 'I cant read chinese :/',
            'toggleTheme': 'Toggle Theme',
            'toggleIndices': 'Hide Indices',
            'toggleIndicesShow': 'Show Indices',
            'reportIssue': 'Report an Issue or Suggest a Feature',
            'searchLabel': 'Search',
            'searchPlaceholder': 'Product Name...',
            'categoryLabel': 'Category',
            'allCategories': 'All Categories',
            'sortBy': 'Sort By:',
            'sortName': 'Name',
            'sortCategory': 'Category',
            'sortAsk': 'Ask',
            'sortBuy': 'Buy',
            'sortTrend': 'Trend %',
            'sortVolatility': 'Volatility',
            'indicesTitle': 'Market Indices (24h Trend Average)',
            'indicesLoading': 'Loading indices...',
            'indicesError': 'Failed to load indices.',
            'indicesNoData': 'No index data available.',
            'tableLoading': 'Loading market data...',
            'colPin': '', // Icon, no text
            'colName': 'Name',
            'colCategory': 'Category',
            'colAsk': 'Ask',
            'colBuy': 'Buy',
            'colTrend': 'Trend (24h)',
            'colVolatility': 'Volatility (7d)',
            'pageInfo': 'Page {currentPage} of {totalPages}', // Placeholder format
            'prevPage': '« Previous',
            'nextPage': 'Next »',
            'chartPlaceholderSelect': 'Select an item name from the table to view its chart.',
            'chartPlaceholderNoData': 'No price history data available for {productName}.',
            'chartPlaceholderNoRange': 'No data available for {productName} in the selected time range ({range}).',
            'chartPlaceholderError': 'Error rendering chart.',
            'chartScaleLog': 'Switch to Log Scale',
            'chartScaleLinear': 'Switch to Linear Scale',
            'footerMadeBy': 'Made by Sporky with AI',
            'footerStatus': 'Data Fetched:',
            'footerRepo': 'GitHub Repo',
            'pinActionPin': 'Pin Item',
            'pinActionUnpin': 'Unpin',
            'pinLimitWarning': 'You can only pin up to {max} items.'
          },
          'zh': { // Chinese translations
            'mainTitle': 'MWI 市场趋势',
            'subHeaderText': '我看不懂中文',
            'toggleTheme': '切换主题',
            'toggleIndices': '隐藏指数',
            'toggleIndicesShow': '显示指数',
            'reportIssue': '报告问题或建议功能',
            'searchLabel': '搜索',
            'searchPlaceholder': '物品名称...',
            'categoryLabel': '类别',
            'allCategories': '所有类别',
            'sortBy': '排序方式:',
            'sortName': '名称',
            'sortCategory': '类别',
            'sortAsk': '卖价',
            'sortBuy': '买价',
            'sortTrend': '趋势 %',
            'sortVolatility': '波动率',
            'indicesTitle': '市场指数 (24小时趋势平均)',
            'indicesLoading': '正在加载指数...',
            'indicesError': '加载指数失败。',
            'indicesNoData': '无指数数据。',
            'tableLoading': '正在加载市场数据...',
            'colPin': '',
            'colName': '名称',
            'colCategory': '类别',
            'colAsk': '卖价',
            'colBuy': '买价',
            'colTrend': '趋势 (24h)',
            'colVolatility': '波动率 (7d)',
            'pageInfo': '第 {currentPage} 页 / 共 {totalPages} 页',
            'prevPage': '« 上一页',
            'nextPage': '下一页 »',
            'chartPlaceholderSelect': '请从表格中选择物品以查看图表。',
            'chartPlaceholderNoData': '物品 {productName} 无价格历史数据。',
            'chartPlaceholderNoRange': '在选定时间范围 ({range}) 内物品 {productName} 无数据。',
            'chartPlaceholderError': '图表渲染错误。',
            'chartScaleLog': '切换到对数刻度',
            'chartScaleLinear': '切换到线性刻度',
            'footerMadeBy': '由 Sporky 与 AI 制作',
            'footerStatus': '数据获取时间:',
            'footerRepo': 'GitHub 仓库',
            'pinActionPin': '钉选物品',
            'pinActionUnpin': '取消钉选',
            'pinLimitWarning': '最多只能钉选 {max} 个物品。'
          }
        };

        // --- Internationalization (i18n) Functions ---
        function getTranslation(key, lang = currentLanguage, replacements = {}) {
            const langDict = translations[lang] || translations['en'];
            let text = langDict[key] || translations['en'][key] || `[${key}]`; // Fallback chain

            // Replace placeholders like {placeholder}
            for (const placeholder in replacements) {
                text = text.replace(`{${placeholder}}`, replacements[placeholder]);
            }
            return text;
        }

        function translatePage() {
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.dataset.translateKey;
                element.textContent = getTranslation(key);
            });
            document.querySelectorAll('[data-translate-key-placeholder]').forEach(element => {
                 const key = element.dataset.translateKeyPlaceholder;
                 element.placeholder = getTranslation(key);
            });
             document.querySelectorAll('[data-translate-key-title]').forEach(element => {
                 const key = element.dataset.translateKeyTitle;
                 element.title = getTranslation(key);
            });
            // Special cases for dynamic text or elements needing updates
            document.title = getTranslation('mainTitle'); // Update page title
            // Update toggle indices button text based on state
            if (toggleIndicesBtn) {
                const isHidden = marketIndicesDisplayEl.classList.contains('hidden');
                toggleIndicesBtn.querySelector('.toggle-text').textContent = getTranslation(isHidden ? 'toggleIndicesShow' : 'toggleIndices');
            }
             // Update scale toggle button text
             if (scaleToggleButton) {
                 scaleToggleButton.textContent = getTranslation(currentYScaleType === 'logarithmic' ? 'chartScaleLinear' : 'chartScaleLog');
             }
             // Update pagination info (called from renderPagination)
             renderPagination(Math.ceil(filteredAndSortedSummary.length / itemsPerPage));
             // Update chart placeholder text (called from displayChart/loadData)
             if (chartPlaceholder.style.display !== 'none') {
                 if (chartPlaceholder.dataset.currentErrorKey) { // If showing an error message
                    const errorData = JSON.parse(chartPlaceholder.dataset.currentErrorData || '{}');
                    chartPlaceholder.textContent = getTranslation(chartPlaceholder.dataset.currentErrorKey, currentLanguage, errorData);
                 } else { // Default select message
                     chartPlaceholder.textContent = getTranslation('chartPlaceholderSelect');
                 }
             }
        }

        function setLanguage(lang) {
            if (translations[lang]) {
                currentLanguage = lang;
                localStorage.setItem(LANG_STORAGE_KEY, lang);
                document.documentElement.lang = lang; // Update HTML lang attribute
                if (languageSelector) languageSelector.value = lang; // Update dropdown
                translatePage(); // Apply translations
            } else {
                console.warn(`Language '${lang}' not supported.`);
            }
        }

        function getInitialLanguage() {
            const savedLang = localStorage.getItem(LANG_STORAGE_KEY);
            if (savedLang && translations[savedLang]) {
                return savedLang;
            }
            // Fallback to browser language (checking primary language part e.g., 'zh' from 'zh-CN')
            const browserLang = navigator.language.split('-')[0];
            if (translations[browserLang]) {
                return browserLang;
            }
            return 'en'; // Default to English
        }


        // --- SVG Icons for Trends ---
        const trendUpIcon = `<svg class="trend-icon" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true"><path fill="currentColor" d="M8.707 2.293a1 1 0 0 0-1.414 0l-4 4a1 1 0 1 0 1.414 1.414L8 4.414l3.293 3.293a1 1 0 0 0 1.414-1.414l-4-4Z"></path></svg>`;
        const trendDownIcon = `<svg class="trend-icon" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true"><path fill="currentColor" d="M7.293 13.707a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0-1.414-1.414L8 11.586 4.707 8.293a1 1 0 0 0-1.414 1.414l4 4Z"></path></svg>`;

        // --- Utility Functions ---
        function formatPrice(price) {
            if (price === null || price === undefined || isNaN(price)) return '<span class="na-value">--</span>';
            return price.toLocaleString(currentLanguage); // Use current language for number formatting
        }
        function formatTrend(trend) {
            if (trend === null || trend === undefined || isNaN(trend)) return '<span class="na-value">--</span>';
            const arrow = trend > 0 ? trendUpIcon : trend < 0 ? trendDownIcon : '';
            const trendClass = trend > 0 ? 'trend-positive' : trend < 0 ? 'trend-negative' : '';
            const trendValue = Number(trend);
            if (isNaN(trendValue)) return '<span class="na-value">--</span>';
            // Use current language formatting for numbers if needed, though toFixed is usually fine
            return `<span class="trend-value-container ${trendClass}">${arrow}<span>${trendValue.toFixed(2)}%</span></span>`;
        }
        function formatVolatilityNorm(value) {
             if (value === null || value === undefined || isNaN(value)) return '<span class="na-value">--</span>';
             const numValue = Number(value);
             if (isNaN(numValue)) return '<span class="na-value">--</span>';
             // Format as percentage with 1 decimal place
             return numValue.toLocaleString(currentLanguage, { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + '%';
        }
        function timeReadable(sec) {
             // This function doesn't have translatable strings, so it's okay
             if (sec === null || sec === undefined || isNaN(sec) || sec < 0) return "N/A";
             if (sec === Infinity) return "∞";
             const days = Math.floor(sec / 86400);
             const hours = Math.floor((sec % 86400) / 3600);
             const minutes = Math.floor((sec % 3600) / 60);
             const seconds = Math.floor(sec % 60);
             let parts = [];
             if (days > 0) parts.push(days + "d");
             if (hours > 0) parts.push(hours + "h");
             if (minutes > 0) parts.push(minutes + "m");
             if (seconds > 0 || parts.length === 0) parts.push(seconds + "s");
             return parts.join(" ");
        }

        /** Displays a message in the message area. */
        function showMessage(message, type = 'info', duration = 5000, replacements = {}) {
            // Allow passing translation keys to showMessage
            const translatedMessage = translations[currentLanguage]?.[message] ? getTranslation(message, currentLanguage, replacements) : message;

            if (!messageAreaEl) return;
            if (messageTimeout) { clearTimeout(messageTimeout); messageTimeout = null; }
            messageAreaEl.textContent = translatedMessage; // Use translated message
            messageAreaEl.className = 'visible ' + type;
            if (duration > 0) {
                messageTimeout = setTimeout(() => {
                    messageAreaEl.className = ''; messageTimeout = null;
                }, duration);
            }
        }
        /** Hides the message area immediately. */
        function hideMessage() {
            if (messageTimeout) { clearTimeout(messageTimeout); messageTimeout = null; }
             if (messageAreaEl) { messageAreaEl.className = ''; }
        }

        // --- Pinning Logic ---
        function getPinnedItems() {
            const stored = localStorage.getItem(PINNED_ITEMS_KEY);
            try { const parsed = JSON.parse(stored); return Array.isArray(parsed) ? parsed : []; }
            catch (e) { return []; }
        }
        function savePinnedItems(items) { localStorage.setItem(PINNED_ITEMS_KEY, JSON.stringify(items)); }
        function togglePin(itemName) {
            let currentPins = getPinnedItems(); const index = currentPins.indexOf(itemName);
            if (index > -1) { currentPins.splice(index, 1); }
            else {
                if (currentPins.length >= MAX_PINNED_ITEMS) {
                    // Use translation key for message
                    showMessage('pinLimitWarning', 'warning', 5000, { max: MAX_PINNED_ITEMS });
                    return;
                }
                currentPins.push(itemName);
            }
            savePinnedItems(currentPins); pinnedItems = currentPins; applyFiltersAndSort();
        }
        function handlePinClick(event) {
             event.stopPropagation(); const icon = event.currentTarget; const itemName = icon.dataset.itemName;
             if (itemName) { togglePin(itemName); } else { console.error("Could not find item name for pinning."); }
        }

        // --- Theme Switching Logic ---
        const THEME_KEY = 'mwi-market-theme';
        function applyTheme(theme) {
            console.log(`Applying theme: ${theme}`);
            if (theme === 'dark') { document.documentElement.setAttribute('data-theme', 'dark'); }
            else { document.documentElement.removeAttribute('data-theme'); }
            localStorage.setItem(THEME_KEY, theme);
            if (currentChart && currentChartProduct) {
                displayChart(currentChartProduct, selectedTableRow);
            }
        }
        function toggleTheme() {
            const currentTheme = document.documentElement.hasAttribute('data-theme') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        }
        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
            applyTheme(initialTheme);
        }
        if (themeToggleButton) { themeToggleButton.addEventListener('click', toggleTheme); }
        else { console.error("Theme toggle button (#theme-toggle-btn) not found!"); }


        // --- Data Fetching ---
        async function loadData() {
            // Reset UI state
            hideMessage();
            if(currentChart) { currentChart.destroy(); currentChart = null; }
            chartPlotContainer.classList.add('hidden'); chartControlsArea.style.display = 'none';
            chartPlaceholder.style.display = 'flex';
            chartPlaceholder.textContent = getTranslation('chartPlaceholderSelect'); // Translate placeholder
            marketIndicesDisplayEl.classList.add('hidden');
            marketIndicesContainerEl.innerHTML = `<span class="loading-message">${getTranslation('indicesLoading')}</span>`;
            currentChartProduct = null; if(selectedTableRow) selectedTableRow.classList.remove('selected-item'); selectedTableRow = null;
            loadingMessageEl.textContent = getTranslation('tableLoading'); // Translate loading message
            loadingMessageEl.style.display = 'block';
            tableWrapperEl.classList.add('hidden'); paginationEl.style.display = 'none';
            lastUpdateEl.textContent = 'Loading...'; // Keep simple or translate later

            try {
                pinnedItems = getPinnedItems(); console.log("Loaded pinned items:", pinnedItems);

                const dataUrls = [
                    './data/market_summary.json',
                    './data/market_history.json',
                    './data/market_indices.json',
                    'https://doh-nuts.github.io/Enhancelator/init_client_info.json'
                ];
                const fetchPromises = dataUrls.map(url => fetch(url + '?t=' + Date.now()).catch(e => {
                    console.error(`Failed to fetch ${url}:`, e);
                    return { error: true, url: url, status: 'fetch_error' };
                }));

                const responses = await Promise.all(fetchPromises);

                const summaryRes = responses[0];
                const historyRes = responses[1];
                const indicesRes = responses[2];
                const gameDataRes = responses[3];

                if (summaryRes.error || !summaryRes.ok) throw new Error(`Failed to fetch market_summary.json (Status: ${summaryRes.status || summaryRes.statusText || 'fetch_error'})`);
                marketSummary = await summaryRes.json();

                if (historyRes.error || !historyRes.ok) {
                    console.warn(`Failed to fetch market_history.json (Status: ${historyRes.status || historyRes.statusText || 'fetch_error'}). Charts may not work.`);
                    allMarketData = {};
                } else {
                    allMarketData = await historyRes.json();
                    console.log("Market history data loaded.");
                }

                if (indicesRes.error || !indicesRes.ok) {
                    console.warn(`Failed to fetch market_indices.json (Status: ${indicesRes.status || indicesRes.statusText || 'fetch_error'}). Indices will not be displayed.`);
                    marketIndicesData = {};
                    marketIndicesContainerEl.innerHTML = `<span class="na-value">${getTranslation('indicesError')}</span>`;
                    if (toggleIndicesBtn) { toggleIndicesBtn.disabled = true; }
                } else {
                    marketIndicesData = await indicesRes.json();
                    console.log("Market indices data loaded.");
                    displayMarketIndices(); // Display indices now that data is loaded
                    // Don't show automatically, respect toggle state (set by initLanguage)
                    // marketIndicesDisplayEl.classList.remove('hidden');
                    if (toggleIndicesBtn) { toggleIndicesBtn.disabled = false; }
                }

                 if (gameDataRes.error || !gameDataRes.ok) {
                    console.warn(`Failed to fetch init_client_info.json (Status: ${gameDataRes.status || gameDataRes.statusText || 'fetch_error'}). Item details might be missing.`);
                    gameData = { itemDetailMap: {} };
                 } else {
                    const fullGameData = await gameDataRes.json();
                    gameData.itemDetailMap = fullGameData.itemDetailMap || {};
                    console.log("Game data loaded (itemDetailMap).");
                 }

                populateCategoryFilter();
                applyFiltersAndSort(); // This calls renderCurrentPage which uses translated headers
                loadingMessageEl.style.display = 'none';
                tableWrapperEl.classList.remove('hidden');
                paginationEl.style.display = 'flex';
                lastUpdateEl.textContent = new Date().toLocaleString(currentLanguage); // Format date based on language

            } catch (error) {
                console.error("Error loading site data:", error);
                loadingMessageEl.style.display = 'none';
                showMessage(`Error loading site data: ${error.message}. Please try refreshing.`, 'error', 0);
                tableWrapperEl.classList.add('hidden');
                paginationEl.style.display = 'none';
                marketIndicesDisplayEl.classList.remove('hidden');
                marketIndicesContainerEl.innerHTML = `<span class="na-value">${getTranslation('indicesError')}</span>`;
                if (toggleIndicesBtn) { toggleIndicesBtn.disabled = true; }
                lastUpdateEl.textContent = 'Error';
            }
        }

        // --- Populate Category Filter ---
        function populateCategoryFilter() {
            if (!categoryFilterEl || !marketSummary) return;
            const categories = [...new Set(marketSummary.map(item => item.category).filter(Boolean))].sort();
            // Save current value if exists
            const currentValue = categoryFilterEl.value;
            categoryFilterEl.innerHTML = `<option value="All" data-translate-key="allCategories">${getTranslation('allCategories')}</option>`; // Translate default option
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                // NOTE: Category names themselves are from data, not translated here
                option.textContent = category;
                categoryFilterEl.appendChild(option);
            });
             // Restore previous value if possible
             if (categoryFilterEl.querySelector(`option[value="${currentValue}"]`)) {
                categoryFilterEl.value = currentValue;
            }
        }

        // --- Display Market Indices ---
        function displayMarketIndices() {
            if (!marketIndicesContainerEl || !marketIndicesData || Object.keys(marketIndicesData).length === 0) {
                marketIndicesContainerEl.innerHTML = `<span class="na-value">${getTranslation('indicesNoData')}</span>`;
                return;
            }
            marketIndicesContainerEl.innerHTML = '';
            const sortedCategories = Object.keys(marketIndicesData).sort();
            sortedCategories.forEach(category => {
                const trend = marketIndicesData[category];
                const indexItem = document.createElement('div');
                indexItem.classList.add('index-item');
                // NOTE: Category names themselves are from data, not translated here
                indexItem.innerHTML = `
                    <span class="category-name" title="${category}">${category}</span>
                    ${formatTrend(trend)}
                `;
                marketIndicesContainerEl.appendChild(indexItem);
            });
        }


        // --- Filtering and Sorting ---
        function applyFiltersAndSort() {
             let result = [...marketSummary];
             if (currentCategoryFilter !== 'All') { result = result.filter(item => item.category === currentCategoryFilter); }
             const searchTerm = currentSearch.toLowerCase();
             if (searchTerm) { result = result.filter(item => item.name.toLowerCase().includes(searchTerm)); }
             const currentPins = getPinnedItems();
             result.sort((a, b) => {
                 const isAPinned = currentPins.includes(a.name); const isBPinned = currentPins.includes(b.name);
                 if (isAPinned && !isBPinned) return -1; if (!isAPinned && isBPinned) return 1;
                 try {
                     const sortNum = (valA, valB, ascending = true) => {
                         const numA = (valA === null || valA === undefined || isNaN(valA)) ? (ascending ? Infinity : -Infinity) : valA;
                         const numB = (valB === null || valB === undefined || isNaN(valB)) ? (ascending ? Infinity : -Infinity) : valB;
                         if (numA === Infinity && numB === Infinity) return 0;
                         if (numA === -Infinity && numB === -Infinity) return 0;
                         if (numA === Infinity) return ascending ? 1 : -1;
                         if (numB === Infinity) return ascending ? -1 : 1;
                         if (numA === -Infinity) return ascending ? -1 : 1;
                         if (numB === -Infinity) return ascending ? 1 : -1;
                         return ascending ? numA - numB : numB - numA;
                     };
                     const sortStr = (valA, valB, ascending = true) => {
                         const strA = (valA ?? '').toLowerCase();
                         const strB = (valB ?? '').toLowerCase();
                         const compare = strA.localeCompare(strB);
                         return ascending ? compare : -compare;
                     };
                     switch (currentSort) {
                         case 'name_desc': return sortStr(a.name, b.name, false);
                         case 'category_asc': return sortStr(a.category, b.category, true);
                         case 'category_desc': return sortStr(a.category, b.category, false);
                         case 'ask_asc': return sortNum(a.ask, b.ask, true);
                         case 'ask_desc': return sortNum(a.ask, b.ask, false);
                         case 'buy_asc': return sortNum(a.buy, b.buy, true);
                         case 'buy_desc': return sortNum(a.buy, b.buy, false);
                         case 'trend_asc': return sortNum(a.trend, b.trend, true);
                         case 'trend_dec': return sortNum(a.trend, b.trend, false);
                         case 'volatility_asc': return sortNum(a.volatility_norm_7d, b.volatility_norm_7d, true);
                         case 'volatility_desc': return sortNum(a.volatility_norm_7d, b.volatility_norm_7d, false);
                         case 'name_asc': default: return sortStr(a.name, b.name, true);
                     }
                 } catch (e) { console.error("Sort comparison error:", e); return 0; }
             });
             filteredAndSortedSummary = result; currentPage = 1; renderCurrentPage();
        }

        // --- Rendering ---
        function renderCurrentPage() {
             tableBodyEl.innerHTML = '';
             if (selectedTableRow) { selectedTableRow.classList.remove('selected-item'); selectedTableRow = null; }

             const currentPins = getPinnedItems();
             const totalItems = filteredAndSortedSummary.length;
             const totalPages = Math.ceil(totalItems / itemsPerPage);
             currentPage = Math.max(1, Math.min(currentPage, totalPages || 1));
             const startIndex = (currentPage - 1) * itemsPerPage;
             const endIndex = startIndex + itemsPerPage;
             const itemsToDisplay = filteredAndSortedSummary.slice(startIndex, endIndex);

             if (itemsToDisplay.length === 0) {
                 const message = marketSummary.length === 0 ? getTranslation('tableLoading') : (currentSearch || currentCategoryFilter !== 'All' ? 'No items match your filters.' : 'No market data available.'); // TODO: Translate filter messages
                 const tr = document.createElement('tr'); const td = document.createElement('td');
                 td.colSpan = 7; // Reduced colspan
                 td.textContent = message; td.style.textAlign = 'center'; td.style.padding = '20px'; td.style.color = 'var(--muted-text-color)';
                 tr.appendChild(td); tableBodyEl.appendChild(tr);
             } else {
                 itemsToDisplay.forEach(item => {
                     const tr = document.createElement('tr');
                     tr.dataset.product = encodeURIComponent(item.name);
                     const isPinned = currentPins.includes(item.name);
                     const pinIconClass = isPinned ? 'fas fa-star pin-icon pinned' : 'far fa-star pin-icon';
                     const displayAsk = formatPrice(item.ask);
                     const displayBuy = formatPrice(item.buy);
                     const volatilityNormValue = item.volatility_norm_7d;
                     const pinTitle = getTranslation(isPinned ? 'pinActionUnpin' : 'pinActionPin'); // Translate pin title

                     tr.innerHTML = `
                         <td class="pin-cell"><i class="${pinIconClass}" data-item-name="${item.name}" title="${pinTitle}"></i></td>
                         <td><a class="item-name-link">${item.name}</a></td>
                         <td>${item.category || '<span class="na-value">N/A</span>'}</td>
                         <td class="ask-cell">${displayAsk}</td>
                         <td class="buy-cell">${displayBuy}</td>
                         <td>${formatTrend(item.trend)}</td>
                         <td>${formatVolatilityNorm(volatilityNormValue)}</td>
                     `;
                     tr.querySelector('.pin-icon').addEventListener('click', handlePinClick);
                     tr.querySelector('.item-name-link').addEventListener('click', handleProductClick);
                     tr.querySelector('.item-name-link').style.cursor = 'pointer';

                     tableBodyEl.appendChild(tr);
                     if (item.name === currentChartProduct) {
                         tr.classList.add('selected-item');
                         selectedTableRow = tr;
                     }
                 });
             }
             renderPagination(totalPages); // Update pagination text
        }
        function renderPagination(totalPages) {
             pageInfoEl.textContent = getTranslation('pageInfo', currentLanguage, { currentPage: currentPage, totalPages: totalPages || 1 });
             prevButton.disabled = currentPage <= 1;
             nextButton.disabled = currentPage >= totalPages;
             paginationEl.style.display = totalPages > 1 ? 'flex' : 'none';
        }

        // --- Charting ---
        function displayChart(productName, clickedTrElement) {
             hideMessage();
             chartPlaceholder.style.display = 'none';
             chartPlotContainer.classList.remove('hidden');
             chartControlsArea.style.display = 'flex';

             const currentTableRows = tableBodyEl.querySelectorAll('tr');
             selectedTableRow = null;
             currentTableRows.forEach(row => { row.classList.remove('selected-item'); if (row.dataset.product && decodeURIComponent(row.dataset.product) === productName) { row.classList.add('selected-item'); selectedTableRow = row; } });

             currentChartProduct = productName;
             let productHistoryData;
             if (allMarketData && allMarketData[productName]) { productHistoryData = allMarketData[productName]; }

             if (!productHistoryData || (!productHistoryData.buy?.length && !productHistoryData.ask?.length)) {
                 console.warn(`No chart data found or provided for ${productName}.`);
                 if (currentChart) { currentChart.destroy(); currentChart = null; }
                 chartPlotContainer.classList.add('hidden'); chartControlsArea.style.display = 'none';
                 // Translate placeholder
                 chartPlaceholder.textContent = getTranslation('chartPlaceholderNoData', currentLanguage, { productName: productName });
                 chartPlaceholder.dataset.currentErrorKey = 'chartPlaceholderNoData'; // Store key for re-translation
                 chartPlaceholder.dataset.currentErrorData = JSON.stringify({ productName: productName });
                 chartPlaceholder.style.display = 'flex';
                 return;
             }

             let filteredBuy = productHistoryData.buy || []; let filteredAsk = productHistoryData.ask || [];
             const now = new Date(); let startDate; let timeUnit = 'day';
             if (currentChartTimeRange === '24h') { startDate = new Date(now.getTime() - (24 * 3600 * 1000)); timeUnit = 'hour'; }
             else if (currentChartTimeRange === '48h') { startDate = new Date(now.getTime() - (48 * 3600 * 1000)); timeUnit = 'hour'; }
             else if (currentChartTimeRange === '7d') { startDate = new Date(now.getTime() - (7 * 24 * 3600 * 1000)); timeUnit = 'day'; }
             else { startDate = new Date(now.getTime() - (30 * 24 * 3600 * 1000)); timeUnit = 'day'; }
             if (startDate) { const filterPoints = (points) => points.filter(p => p.timestamp * 1000 >= startDate.getTime()); filteredBuy = filterPoints(filteredBuy); filteredAsk = filterPoints(filteredAsk); }

             if (filteredBuy.length < 1 && filteredAsk.length < 1) {
                  console.warn(`No chart data in range ${currentChartTimeRange} for ${productName}`);
                  if (currentChart) { currentChart.destroy(); currentChart = null; }
                  chartPlotContainer.classList.add('hidden'); chartControlsArea.style.display = 'none';
                  // Translate placeholder
                  chartPlaceholder.textContent = getTranslation('chartPlaceholderNoRange', currentLanguage, { productName: productName, range: currentChartTimeRange });
                  chartPlaceholder.dataset.currentErrorKey = 'chartPlaceholderNoRange'; // Store key for re-translation
                  chartPlaceholder.dataset.currentErrorData = JSON.stringify({ productName: productName, range: currentChartTimeRange });
                  chartPlaceholder.style.display = 'flex';
                  return;
             }
             // Clear error state if data is found
             chartPlaceholder.dataset.currentErrorKey = '';
             chartPlaceholder.dataset.currentErrorData = '';


             const parsePoints = (points) => points.map(p => { const price = (typeof p.price === 'number' && isFinite(p.price)) ? p.price : null; const timestamp = (typeof p.timestamp === 'number' && isFinite(p.timestamp)) ? new Date(p.timestamp * 1000) : null; if (timestamp === null) { console.warn("Invalid timestamp:", p); return null; } return { x: timestamp, y: price }; }).filter(p => p !== null);
             const buyData = parsePoints(filteredBuy); const askData = parsePoints(filteredAsk);

             if(scaleToggleButton) { scaleToggleButton.textContent = getTranslation(currentYScaleType === 'logarithmic' ? 'chartScaleLinear' : 'chartScaleLog'); }

             const isDarkMode = document.documentElement.hasAttribute('data-theme');
             const primaryTextColor = isDarkMode ? '#c9d1d9' : '#24292f';
             const secondaryTextColor = isDarkMode ? '#8b949e' : '#57606a';
             const gridColor = isDarkMode ? '#30363d' : '#d0d7de';
             const askColor = isDarkMode ? '#f85149' : '#cf222e';
             const buyColor = isDarkMode ? '#58a6ff' : '#0969da';

             const chartData = {
                 datasets: [
                     { label: getTranslation('colAsk'), data: askData, borderColor: askColor, backgroundColor: askColor + '1A', tension: 0, pointRadius: 2, pointHoverRadius: 5, spanGaps: false, borderWidth: 1.5 },
                     { label: getTranslation('colBuy'), data: buyData, borderColor: buyColor, backgroundColor: buyColor + '1A', tension: 0, pointRadius: 2, pointHoverRadius: 5, spanGaps: false, borderWidth: 1.5 }
                 ]
             };

             if (currentChart) { currentChart.destroy(); }

             try {
                 currentChart = new Chart(chartCanvas, {
                     type: 'line',
                     data: chartData,
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         plugins: {
                             title: { display: true, text: `${productName} (${currentChartTimeRange})`, font: { size: 15, weight: '600' }, padding: { bottom: 15 }, color: primaryTextColor },
                             legend: { position: 'top', labels: { font: { size: 12 }, color: primaryTextColor } },
                             tooltip: { mode: 'index', intersect: false, bodySpacing: 5, titleSpacing: 6, padding: 10, boxPadding: 4 },
                         },
                         scales: {
                             x: {
                                 type: 'time',
                                 adapters: { date: { locale: currentLanguage === 'zh' ? dateFnsZhCN : undefined } }, // Set locale for date-fns adapter if needed
                                 time: { unit: timeUnit, tooltipFormat: 'PPp', displayFormats: { hour: 'p', day: 'MMM d', week: 'PP' } }, // Adjust formats if needed
                                 title: { display: false },
                                 grid: { display: false },
                                 ticks: { font: { size: 11 }, color: secondaryTextColor, autoSkip: true, maxRotation: 0, minRotation: 0, maxTicksLimit: 8 }
                             },
                             y: {
                                 type: currentYScaleType,
                                 min: currentYScaleType === 'logarithmic' ? 1 : undefined,
                                 grace: '10%',
                                 title: { display: true, text: `Price (${currentYScaleType === 'logarithmic' ? 'Log' : 'Linear'} Scale)`, font: { size: 12 }, color: secondaryTextColor },
                                 grid: { color: gridColor },
                                 ticks: {
                                     font: { size: 11 },
                                     color: secondaryTextColor,
                                     callback: currentYScaleType === 'logarithmic'
                                          ? function(value, index, ticks) { /* ... log scale formatting ... */
                                              if (value <= 0) return null;
                                              const log10 = Math.log10(value);
                                              if (Math.abs(log10 - Math.round(log10)) < 0.01 || index === 0 || index === ticks.length - 1) {
                                                  if (value >= 1e9) return (value / 1e9).toFixed(0) + 'B';
                                                  if (value >= 1e6) return (value / 1e6).toFixed(0) + 'M';
                                                  if (value >= 1e3) return (value / 1e3).toFixed(0) + 'k';
                                                  return value.toLocaleString(currentLanguage); // Use locale
                                              }
                                              return null;
                                          }
                                          : function(value) { return value.toLocaleString(currentLanguage); } // Use locale
                                 }
                             }
                         },
                         interaction: { mode: 'index', axis: 'x', intersect: false },
                         animation: { duration: 0 }
                     }
                 });
             } catch(e) {
                 console.error("Error creating Chart.js instance:", e);
                 showMessage('chartPlaceholderError', 'error'); // Use translation key
                 chartPlotContainer.classList.add('hidden');
                 chartControlsArea.style.display = 'none';
                 chartPlaceholder.textContent = getTranslation('chartPlaceholderError');
                 chartPlaceholder.dataset.currentErrorKey = 'chartPlaceholderError';
                 chartPlaceholder.dataset.currentErrorData = '{}';
                 chartPlaceholder.style.display = 'flex';
             }
        }

        // --- Event Handlers ---
        function handleProductClick(event) {
             if (event.target.classList.contains('pin-icon')) { return; }
             const clickedLink = event.currentTarget;
             const clickedTr = clickedLink.closest('tr');
             if (!clickedTr || !clickedTr.dataset.product) return;
             const productName = decodeURIComponent(clickedTr.dataset.product);
             displayChart(productName, clickedTr);
        }
        let searchTimeout;
        searchInput.addEventListener('input', (event) => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { currentSearch = event.target.value; applyFiltersAndSort(); }, 300); });
        categoryFilterEl.addEventListener('change', (event) => { currentCategoryFilter = event.target.value; applyFiltersAndSort(); });

        // Event Listener for Sort Options
        sortOptionsEl.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON' && event.target.dataset.sort) {
                const sortBase = event.target.dataset.sort;
                let newSort;
                const toggleColumns = ['name', 'trend', 'volatility'];
                const defaultAscending = ['ask', 'category', 'volatility'];
                const defaultDescending = ['buy', 'trend'];

                if (toggleColumns.includes(sortBase)) {
                    const ascSort = sortBase + '_asc';
                    const descSort = sortBase + '_desc';
                    if (currentSort !== ascSort) {
                         newSort = ascSort;
                    } else {
                         newSort = descSort;
                    }
                     if (!currentSort.startsWith(sortBase + '_')) {
                         if (defaultDescending.includes(sortBase)) newSort = descSort;
                         if (defaultAscending.includes(sortBase)) newSort = ascSort;
                     }
                } else {
                    if (defaultAscending.includes(sortBase)) newSort = sortBase + '_asc';
                    else if (defaultDescending.includes(sortBase)) newSort = sortBase + '_desc';
                    else newSort = sortBase + '_asc';
                }
                currentSort = newSort;
                sortOptionsEl.querySelectorAll('button').forEach(btn => {
                    const btnSortBase = btn.dataset.sort;
                    const isCurrent = currentSort.startsWith(btnSortBase + '_') || currentSort === btnSortBase;
                    btn.classList.toggle('current-sort', isCurrent);
                });
                applyFiltersAndSort();
            }
        });


        prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderCurrentPage(); tableWrapperEl.scrollTop = 0; } });
        nextButton.addEventListener('click', () => { const totalPages = Math.ceil(filteredAndSortedSummary.length / itemsPerPage); if (currentPage < totalPages) { currentPage++; renderCurrentPage(); tableWrapperEl.scrollTop = 0; } });
        chartTimeControlsEl.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON' && event.target.dataset.range) {
                const newRange = event.target.dataset.range;
                if (newRange !== currentChartTimeRange) {
                    currentChartTimeRange = newRange;
                    chartTimeControlsEl.querySelectorAll('button').forEach(btn => { btn.classList.toggle('active', btn.dataset.range === newRange); });
                    if (currentChartProduct) { displayChart(currentChartProduct, selectedTableRow); }
                }
            }
        });
        if (scaleToggleButton) {
            scaleToggleButton.addEventListener('click', () => {
                currentYScaleType = (currentYScaleType === 'logarithmic') ? 'linear' : 'logarithmic';
                console.log(`Switched scale to: ${currentYScaleType}`);
                if (currentChartProduct) { displayChart(currentChartProduct, selectedTableRow); }
                // Update button text after scale change
                 scaleToggleButton.textContent = getTranslation(currentYScaleType === 'logarithmic' ? 'chartScaleLinear' : 'chartScaleLog');
            });
        } else { console.error("Scale toggle button not found!"); }

        // Event listener for Toggle Indices Button
        if (toggleIndicesBtn) {
            toggleIndicesBtn.addEventListener('click', () => {
                const isHidden = marketIndicesDisplayEl.classList.toggle('hidden');
                const buttonText = toggleIndicesBtn.querySelector('.toggle-text');
                buttonText.textContent = getTranslation(isHidden ? 'toggleIndicesShow' : 'toggleIndices');
                toggleIndicesBtn.classList.toggle('indices-hidden', isHidden); // Toggle class for icon styling
            });
        } else {
            console.error("Toggle indices button (#toggle-indices-btn) not found!");
        }

        // NEW: Event listener for Language Selector
        if (languageSelector) {
            languageSelector.addEventListener('change', (event) => {
                setLanguage(event.target.value);
            });
        } else {
             console.error("Language selector (#language-selector) not found!");
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const initialLang = getInitialLanguage();
            setLanguage(initialLang); // Set language and run initial translation
            initTheme();
            loadData(); // Load data after initial language is set
        });

    </script>

</body>
</html>
