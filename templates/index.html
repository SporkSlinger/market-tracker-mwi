<!DOCTYPE html>
<html lang="en" data-theme="light"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MWI Market Trends</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- CSS Variables for Theming --- */
        :root { /* Light Theme (Default) */
            --bg-color: #f8f9fa; --card-bg-color: #ffffff; --text-color-primary: #212529;
            --text-color-secondary: #6c757d; --border-color: #dee2e6; --accent-color: #007bff;
            --accent-hover-color: #0056b3; --positive-color: #28a745; --negative-color: #dc3545;
            --button-bg-color: #e9ecef; --button-hover-bg-color: #ced4da; --button-border-color: #ced4da;
            --button-hover-border-color: #adb5bd; --input-bg-color: #ffffff; --input-border-color: #ced4da;
            --input-focus-border-color: #86b7fe; --input-focus-shadow-color: rgba(0, 123, 255, 0.25);
            --table-header-bg: #e9ecef; --table-row-hover-bg: #f1f3f5; --table-row-selected-bg: #cfe2ff;
            --link-color: var(--accent-color); --link-hover-color: var(--accent-hover-color);
            --chart-grid-color: rgba(0, 0, 0, 0.1); --chart-tick-color: #6c757d; --chart-title-color: #212529;
            --chart-tooltip-bg: rgba(0, 0, 0, 0.8); --chart-tooltip-text-color: #ffffff; --shadow-color: rgba(0, 0, 0, 0.1);
        }
        html[data-theme="dark"] { /* Dark Theme Overrides */
            --bg-color: #1a1a1a; --card-bg-color: #2c2c2c; --text-color-primary: #e9ecef;
            --text-color-secondary: #adb5bd; --border-color: #495057; --accent-color: #4dabf7;
            --accent-hover-color: #74c0fc; --positive-color: #40c057; --negative-color: #fa5252;
            --button-bg-color: #495057; --button-hover-bg-color: #6c757d; --button-border-color: #6c757d;
            --button-hover-border-color: #adb5bd; --input-bg-color: #343a40; --input-border-color: #495057;
            --input-focus-border-color: #4dabf7; --input-focus-shadow-color: rgba(77, 171, 247, 0.25);
            --table-header-bg: #343a40; --table-row-hover-bg: #3e444a; --table-row-selected-bg: #364a6d;
            --link-color: var(--accent-color); --link-hover-color: var(--accent-hover-color);
            --chart-grid-color: rgba(255, 255, 255, 0.15); --chart-tick-color: #adb5bd; --chart-title-color: #e9ecef;
            --chart-tooltip-bg: rgba(255, 255, 255, 0.8); --chart-tooltip-text-color: #1a1a1a; --shadow-color: rgba(0, 0, 0, 0.3);
        }
        /* --- General Styles (mostly unchanged) --- */
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color-primary); line-height: 1.5; font-size: 14px; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
        .container { max-width: 1600px; margin: 25px auto; padding: 0 25px; }
        h1 { text-align: center; color: var(--text-color-primary); margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600; font-size: 1.8em; letter-spacing: -0.5px; }
        .feedback-link-container { text-align: center; margin-bottom: 25px; font-size: 0.9em; }
        .feedback-link-container a { color: var(--text-color-secondary); text-decoration: none; border-bottom: 1px dashed var(--text-color-secondary); transition: color 0.2s, border-color 0.2s; padding-bottom: 1px; }
        .feedback-link-container a:hover { color: var(--link-color); border-color: var(--link-color); }
        .controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 16px 20px; margin-bottom: 30px; gap: 15px; background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 2px 5px var(--shadow-color); transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        .controls-left, .controls-right { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
        .search-form input[type="text"], .category-filter select { padding: 8px 12px; border: 1px solid var(--input-border-color); border-radius: 6px; min-width: 200px; font-size: 0.95em; background-color: var(--input-bg-color); color: var(--text-color-primary); box-shadow: inset 0 1px 2px rgba(0,0,0,0.075); transition: border-color 0.1s ease-in-out, box-shadow 0.1s ease-in-out, background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
        .search-form input[type="text"]:focus, .category-filter select:focus { border-color: var(--input-focus-border-color); box-shadow: inset 0 1px 2px rgba(0,0,0,0.075), 0 0 0 3px var(--input-focus-shadow-color); outline: none; }
        .button, #theme-toggle { padding: 8px 15px; background-color: var(--button-bg-color); color: var(--text-color-primary); border: 1px solid var(--button-border-color); border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: 500; text-align: center; transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease; display: inline-flex; align-items: center; gap: 6px; }
        .button:hover, #theme-toggle:hover { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        #theme-toggle { min-width: 40px; justify-content: center; }
        #theme-toggle .fa-sun { display: none; } #theme-toggle .fa-moon { display: inline-block; }
        html[data-theme="dark"] #theme-toggle .fa-sun { display: inline-block; } html[data-theme="dark"] #theme-toggle .fa-moon { display: none; }
        .table-container { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px var(--shadow-color); margin-bottom: 25px; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: var(--table-header-bg); font-weight: 600; font-size: 0.9em; color: var(--text-color-secondary); text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; user-select: none; white-space: nowrap; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; position: sticky; top: 0; z-index: 1; /* Keep headers sticky */ }
        th .sort-icon { margin-left: 5px; color: var(--text-color-secondary); opacity: 0.6; }
        th.sorted .sort-icon { opacity: 1; color: var(--text-color-primary); }
        tbody tr { transition: background-color 0.15s ease; cursor: pointer; /* Indicate rows are clickable */ }
        tbody tr:hover { background-color: var(--table-row-hover-bg); }
        tbody tr.selected-row { background-color: var(--table-row-selected-bg); font-weight: 500; }
        tbody tr:last-child td { border-bottom: none; }
        td { color: var(--text-color-primary); font-size: 0.95em; transition: color 0.2s ease-in-out; white-space: nowrap; /* Prevent wrapping */ overflow: hidden; text-overflow: ellipsis; /* Add ellipsis for overflow */ }
        td:first-child { max-width: 250px; } /* Limit name column width */
        td:nth-child(2) { max-width: 180px; } /* Limit category column width */
        td.number { text-align: right; font-variant-numeric: tabular-nums; overflow: visible; /* Allow trend icon to show */ }
        td.trend { text-align: right; white-space: nowrap; overflow: visible; }
        .trend-icon { margin-left: 4px; font-size: 0.9em; }
        .trend-positive { color: var(--positive-color); } .trend-negative { color: var(--negative-color); } .trend-neutral { color: var(--text-color-secondary); }
        .na-value { color: var(--text-color-secondary); font-style: italic; } /* Style for N/A */
        .pagination { display: flex; justify-content: center; align-items: center; padding: 15px 0; gap: 8px; }
        .pagination button { padding: 6px 12px; background-color: var(--button-bg-color); color: var(--text-color-primary); border: 1px solid var(--button-border-color); border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: background-color 0.15s ease, border-color 0.15s ease; }
        .pagination button:hover:not(:disabled) { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination span { font-size: 0.9em; color: var(--text-color-secondary); margin: 0 5px; }
        .chart-container { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 30px; box-shadow: 0 2px 5px var(--shadow-color); transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; min-height: 450px; /* Ensure minimum height */ display: flex; flex-direction: column; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
        .chart-title { font-size: 1.1em; font-weight: 600; color: var(--text-color-primary); transition: color 0.2s ease-in-out; }
        .chart-controls button { padding: 5px 10px; background-color: var(--button-bg-color); color: var(--text-color-primary); border: 1px solid var(--button-border-color); border-radius: 4px; cursor: pointer; font-size: 0.85em; transition: background-color 0.15s ease, border-color 0.15s ease; }
        .chart-controls button:hover { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .chart-controls button.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        #priceChart { max-height: 400px; width: 100%; /* Ensure canvas takes width */ }
        .chart-placeholder { text-align: center; color: var(--text-color-secondary); padding: 60px; font-size: 1.05em; flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        footer { text-align: center; margin-top: 40px; padding: 20px; font-size: 0.85em; color: var(--text-color-secondary); border-top: 1px solid var(--border-color); transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        footer a { color: var(--link-color); text-decoration: none; } footer a:hover { text-decoration: underline; color: var(--link-hover-color); }
        .loading-indicator, .error-message, .no-results-message { text-align: center; padding: 40px; font-size: 1.1em; color: var(--text-color-secondary); }
        .error-message { color: var(--negative-color); }
        .hidden { display: none; }
        @media (max-width: 768px) {
            .controls { flex-direction: column; align-items: stretch; }
            .controls-left, .controls-right { width: 100%; justify-content: center; }
            .search-form input[type="text"], .category-filter select { width: 100%; min-width: unset; }
            .chart-header { flex-direction: column; align-items: flex-start; }
            th, td { padding: 8px 10px; font-size: 0.9em;}
            h1 { font-size: 1.5em; }
            td:first-child { max-width: 150px; } /* Adjust max-width for mobile */
            td:nth-child(2) { max-width: 100px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Milky Way Idle Market Trends</h1>
        <div class="feedback-link-container">
             <a href="https://github.com/sporky/market-tracker-mwi/issues" target="_blank" rel="noopener noreferrer">Report an Issue / Feedback</a>
        </div>

        <div class="controls">
            <div class="controls-left">
                <form class="search-form" id="search-form" onsubmit="event.preventDefault();">
                    <input type="text" id="search-input" placeholder="Search item name...">
                </form>
                <div class="category-filter">
                    <select id="category-select">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="controls-right">
                 <button id="theme-toggle" title="Toggle Theme">
                     <i class="fas fa-moon"></i><i class="fas fa-sun"></i>
                 </button>
            </div>
        </div>

        <div class="chart-container" id="chart-area">
            <div class="chart-header">
                <div id="chart-title" class="chart-title">Select an item to view price history</div>
                <div class="chart-controls" id="chart-controls">
                    <button data-range="24h" class="active">24h</button>
                    <button data-range="48h">48h</button>
                    <button data-range="7d">7d</button>
                    <button data-range="30d">30d</button>
                </div>
            </div>
            <div id="chart-placeholder" class="chart-placeholder">Select an item from the table below.</div>
            <canvas id="priceChart" class="hidden"></canvas> <div id="chart-loading" class="loading-indicator hidden">Loading chart data...</div>
            <div id="chart-error" class="error-message hidden">Could not load chart data.</div>
        </div>

        <div class="table-container">
            <table id="market-table">
                <thead>
                    <tr>
                        <th data-sort="name">Name <span class="sort-icon fas fa-sort"></span></th>
                        <th data-sort="category">Category <span class="sort-icon fas fa-sort"></span></th>
                        <th data-sort="buy" class="number">Buy Price <span class="sort-icon fas fa-sort"></span></th>
                        <th data-sort="ask" class="number">Ask Price <span class="sort-icon fas fa-sort"></span></th>
                        <th data-sort="vendor" class="number">Vendor <span class="sort-icon fas fa-sort"></span></th>
                        <th data-sort="trend" class="number">24h Trend <span class="sort-icon fas fa-sort"></span></th>
                    </tr>
                </thead>
                <tbody id="market-body">
                    </tbody>
            </table>
            <div id="table-loading" class="loading-indicator">Loading market data...</div>
            <div id="table-error" class="error-message hidden">Could not load market data.</div>
            <div id="no-results" class="no-results-message hidden">No items match your search/filter.</div>
        </div>

        <div class="pagination" id="pagination">
            </div>

        <footer>
            Data generated: <span id="last-update">{{ last_update }}</span> |
            Created by Sporky with AI |
            Data source: <a href="https://github.com/holychikenz/MWIApi" target="_blank" rel="noopener noreferrer">holychikenz/MWIApi</a>
        </footer>
    </div>

    <script>
        // --- Constants and State ---
        const ITEMS_PER_PAGE = 20;
        let marketSummary = []; // Holds data from market_summary.json
        let allHistoryData = []; // Holds ALL data from market_history.json (flat list)
        let filteredItems = []; // Holds summary items after search/filter
        let sortedItems = []; // Holds summary items after sorting
        let currentPage = 1;
        let currentSort = { column: 'name', direction: 'asc' };
        let selectedItemName = null; // Name of the item selected for charting
        let priceChart = null; // Chart.js instance
        let currentChartRange = '24h'; // Default chart range

        // --- DOM Elements ---
        const tableBody = document.getElementById('market-body');
        const paginationContainer = document.getElementById('pagination');
        const searchInput = document.getElementById('search-input');
        const categorySelect = document.getElementById('category-select');
        const tableLoading = document.getElementById('table-loading');
        const tableError = document.getElementById('table-error');
        const noResults = document.getElementById('no-results');
        const chartArea = document.getElementById('chart-area'); // Container for chart elements
        const chartCanvas = document.getElementById('priceChart');
        const chartCtx = chartCanvas.getContext('2d');
        const chartTitle = document.getElementById('chart-title');
        const chartControls = document.getElementById('chart-controls');
        const chartLoading = document.getElementById('chart-loading');
        const chartError = document.getElementById('chart-error');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const themeToggleButton = document.getElementById('theme-toggle');

        // --- Theme Switching Logic (Unchanged) ---
        const THEME_KEY = 'mwi-market-theme';
        function applyTheme(theme) { /* ... */ }
        function toggleTheme() { /* ... */ }
        function initTheme() { /* ... */ }
        themeToggleButton.addEventListener('click', toggleTheme);
        document.addEventListener('DOMContentLoaded', initTheme);
        // --- (Paste the applyTheme, toggleTheme, initTheme functions here from previous version) ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            localStorage.setItem(THEME_KEY, theme);
            if (priceChart) { // Update chart if it exists
                updateChartTheme();
            }
        }
        function toggleTheme() {
            const currentTheme = document.documentElement.hasAttribute('data-theme') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        }
        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
            applyTheme(initialTheme); // Apply theme immediately
        }


        // --- Data Fetching ---
        async function loadData() {
            showLoadingState(tableLoading, tableBody, paginationContainer);
            tableError.classList.add('hidden');
            noResults.classList.add('hidden');

            try {
                // Fetch both summary and history data concurrently
                const [summaryResponse, historyResponse] = await Promise.all([
                    fetch('./data/market_summary.json?t=' + Date.now()), // Cache bust
                    fetch('./data/market_history.json?t=' + Date.now())  // Cache bust
                ]);

                if (!summaryResponse.ok) throw new Error(`Market Summary fetch failed: ${summaryResponse.status}`);
                if (!historyResponse.ok) throw new Error(`Market History fetch failed: ${historyResponse.status}`);

                marketSummary = await summaryResponse.json();
                allHistoryData = await historyResponse.json(); // Store the flat list

                console.log(`Loaded ${marketSummary.length} summary items.`);
                console.log(`Loaded ${allHistoryData.length} historical records.`);

                // Initial processing & rendering
                filterAndSort(); // This calls renderTablePage and renderPagination
                hideLoadingState(tableLoading);

            } catch (error) {
                console.error("Failed to load data:", error);
                hideLoadingState(tableLoading);
                showErrorState(tableError, `Error loading data: ${error.message}. Please try refreshing.`);
            }
        }

        // --- UI State Helpers ---
        function showLoadingState(loader, ...elementsToHide) {
            loader.classList.remove('hidden');
            elementsToHide.forEach(el => el.classList.add('hidden'));
        }

        function hideLoadingState(loader) {
            loader.classList.add('hidden');
        }

        function showErrorState(errorElement, message) {
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        function hideErrorState(errorElement) {
             errorElement.classList.add('hidden');
        }


        // --- Data Filtering and Sorting (for Summary Table) ---
        function filterAndSort() {
            // 1. Filter by search term
            const searchTerm = searchInput.value.toLowerCase().trim();
            let tempItems = marketSummary; // Start with the full summary
            if (searchTerm) {
                tempItems = tempItems.filter(item => item.name.toLowerCase().includes(searchTerm));
            }

            // 2. Filter by category
            const selectedCategory = categorySelect.value;
            if (selectedCategory) {
                tempItems = tempItems.filter(item => item.category === selectedCategory);
            }
            filteredItems = tempItems;

            // 3. Sort
            sortSummaryItems(); // Renamed for clarity

            // 4. Reset to page 1 and re-render table
            currentPage = 1;
            renderTablePage();
            renderPagination();

            // Show 'no results' message if applicable
            noResults.classList.toggle('hidden', filteredItems.length > 0);
            // Hide/show table container based on results
            document.querySelector('.table-container').classList.toggle('hidden', filteredItems.length === 0);
            paginationContainer.classList.toggle('hidden', filteredItems.length === 0);
        }

        function sortSummaryItems() { // Renamed
            const { column, direction } = currentSort;
            // Sort the filteredItems array
            sortedItems = [...filteredItems].sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                if (valA === null || valA === undefined) valA = direction === 'asc' ? -Infinity : Infinity;
                if (valB === null || valB === undefined) valB = direction === 'asc' ? -Infinity : Infinity;

                if (typeof valA === 'number' && typeof valB === 'number') {
                    return direction === 'asc' ? valA - valB : valB - valA;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                }
            });
        }

        function handleSort(event) {
            const th = event.target.closest('th');
            if (!th || !th.dataset.sort) return;

            const newColumn = th.dataset.sort;
            let newDirection = 'asc';
            if (currentSort.column === newColumn && currentSort.direction === 'asc') {
                newDirection = 'desc';
            }

            currentSort = { column: newColumn, direction: newDirection };
            sortSummaryItems(); // Re-sort the currently filtered items
            currentPage = 1;
            renderTablePage();
            renderPagination();
            updateSortIcons();
        }

        function updateSortIcons() {
             document.querySelectorAll('#market-table th[data-sort]').forEach(th => {
                const column = th.dataset.sort;
                const icon = th.querySelector('.sort-icon');
                th.classList.remove('sorted');
                icon.className = 'sort-icon fas fa-sort'; // Reset

                if (column === currentSort.column) {
                    th.classList.add('sorted');
                    icon.className = `sort-icon fas ${currentSort.direction === 'asc' ? 'fa-sort-up' : 'fa-sort-down'}`;
                }
            });
        }

        // --- Rendering Table and Pagination ---
        function renderTablePage() {
            tableBody.innerHTML = ''; // Clear previous page
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            // Use sortedItems which is the filtered AND sorted list
            const pageItems = sortedItems.slice(start, end);

            if (pageItems.length === 0 && marketSummary.length > 0) {
                // This case is handled by the noResults message toggle in filterAndSort
                return;
            }

            const fragment = document.createDocumentFragment();
            pageItems.forEach(item => {
                const row = document.createElement('tr');
                row.dataset.itemName = item.name; // Store item name for chart selection
                row.classList.toggle('selected-row', item.name === selectedItemName);

                let trendHtml = '<span class="na-value">--</span>'; // Default: N/A
                if (typeof item.trend === 'number' && !isNaN(item.trend)) {
                    const trendClass = item.trend > 0 ? 'trend-positive' : (item.trend < 0 ? 'trend-negative' : 'trend-neutral');
                    const trendIcon = item.trend > 0 ? 'fa-arrow-up' : (item.trend < 0 ? 'fa-arrow-down' : '');
                    // Ensure trend is displayed with fixed decimal places
                    trendHtml = `<span class="${trendClass}">${item.trend.toFixed(1)}% ${trendIcon ? `<i class="fas ${trendIcon} trend-icon"></i>` : ''}</span>`;
                }

                const formatPrice = (price) => (price === null || price === undefined) ? '<span class="na-value">--</span>' : price.toLocaleString();

                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.category || '<span class="na-value">N/A</span>'}</td>
                    <td class="number">${formatPrice(item.buy)}</td>
                    <td class="number">${formatPrice(item.ask)}</td>
                    <td class="number">${item.vendor === null ? '<span class="na-value">--</span>' : formatPrice(item.vendor)}</td>
                    <td class="trend number">${trendHtml}</td>
                `;
                row.addEventListener('click', handleRowClick);
                fragment.appendChild(row);
            });
            tableBody.appendChild(fragment);
            // Ensure table container is visible if it was hidden by no-results
            document.querySelector('.table-container').classList.remove('hidden');
        }

        function renderPagination() {
            paginationContainer.innerHTML = ''; // Clear previous controls
            // Use sortedItems length for total pages calculation
            const totalPages = Math.ceil(sortedItems.length / ITEMS_PER_PAGE);

            if (totalPages <= 1) {
                 paginationContainer.classList.add('hidden'); // Hide if only one page
                 return;
            }
             paginationContainer.classList.remove('hidden'); // Show if more than one page

            const fragment = document.createDocumentFragment();
            // Previous Button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '&laquo; Prev';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderTablePage(); renderPagination(); } });
            fragment.appendChild(prevButton);
            // Page Info Span
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            fragment.appendChild(pageInfo);
            // Next Button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = 'Next &raquo;';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; renderTablePage(); renderPagination(); } });
            fragment.appendChild(nextButton);
            paginationContainer.appendChild(fragment);
        }

        // --- Charting ---

        // Get computed style for theme-aware colors
        function getCssVariable(varName) { return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }

        function getChartColors() {
            return {
                buyColor: getCssVariable('--positive-color') || 'rgba(40, 167, 69, 0.8)',
                askColor: getCssVariable('--negative-color') || 'rgba(220, 53, 69, 0.8)',
                gridColor: getCssVariable('--chart-grid-color') || 'rgba(0, 0, 0, 0.1)',
                tickColor: getCssVariable('--chart-tick-color') || '#6c757d',
                titleColor: getCssVariable('--chart-title-color') || '#212529',
                tooltipBgColor: getCssVariable('--chart-tooltip-bg') || 'rgba(0, 0, 0, 0.8)',
                tooltipTextColor: getCssVariable('--chart-tooltip-text-color') || '#ffffff'
            };
        }

        // **MODIFIED**: Processes data from the pre-loaded flat list
        function displayChart(itemName) {
            console.log(`Attempting to display chart for: ${itemName}`);
            chartPlaceholder.classList.add('hidden'); // Hide placeholder
            chartCanvas.classList.remove('hidden'); // Show canvas
            chartError.classList.add('hidden'); // Hide previous errors
            chartLoading.classList.remove('hidden'); // Show loading

            // 1. Filter the GLOBAL allHistoryData list for the specific item
            const itemHistory = allHistoryData.filter(record => record.product === itemName);

            if (itemHistory.length === 0) {
                console.warn(`No historical records found for ${itemName} in allHistoryData.`);
                chartTitle.textContent = `No history data available for ${itemName}`;
                showErrorState(chartError, `No historical data found for ${itemName}.`);
                chartCanvas.classList.add('hidden'); // Hide canvas again
                chartLoading.classList.add('hidden');
                if (priceChart) { priceChart.destroy(); priceChart = null; }
                return;
            }

            // 2. Apply Time Range Filter
            const now = new Date();
            let minTime;
            let timeUnit = 'day'; // Default unit

            switch (currentChartRange) {
                case '48h': minTime = new Date(now.getTime() - 48 * 60 * 60 * 1000); timeUnit = 'hour'; break;
                case '7d': minTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); timeUnit = 'day'; break;
                case '30d': minTime = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000); timeUnit = 'day'; break;
                case '24h': // fallthrough default
                default: minTime = new Date(now.getTime() - 24 * 60 * 60 * 1000); timeUnit = 'hour'; break;
            }

            const filteredRangeHistory = itemHistory.filter(record => {
                // IMPORTANT: Parse the ISO string timestamp from JSON into a Date object
                const recordDate = new Date(record.timestamp);
                return recordDate >= minTime;
            });

             if (filteredRangeHistory.length === 0) {
                console.warn(`No historical records found for ${itemName} within the ${currentChartRange} range.`);
                chartTitle.textContent = `No data for ${itemName} in the last ${currentChartRange}`;
                showErrorState(chartError, `No data available for ${itemName} in the selected time range (${currentChartRange}).`);
                chartCanvas.classList.add('hidden');
                chartLoading.classList.add('hidden');
                 if (priceChart) { priceChart.destroy(); priceChart = null; }
                return;
            }

            // 3. Prepare data for Chart.js
            // Ensure data is sorted by timestamp (important for line charts)
             filteredRangeHistory.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            const chartLabels = filteredRangeHistory.map(p => new Date(p.timestamp)); // Use Date objects directly
            const chartBuyData = filteredRangeHistory.map(p => p.buy); // Keep nulls as is
            const chartAskData = filteredRangeHistory.map(p => p.ask); // Keep nulls as is

            // 4. Create or Update Chart
            chartTitle.textContent = `Price History: ${itemName}`;
            const colors = getChartColors();

            const chartConfig = {
                type: 'line',
                data: {
                    labels: chartLabels, // Use the Date objects
                    datasets: [
                        { label: 'Buy Price', data: chartBuyData, borderColor: colors.buyColor, backgroundColor: colors.buyColor, tension: 0.1, pointRadius: 1, pointHoverRadius: 4, borderWidth: 1.5, spanGaps: false /* Don't connect gaps */ },
                        { label: 'Ask Price', data: chartAskData, borderColor: colors.askColor, backgroundColor: colors.askColor, tension: 0.1, pointRadius: 1, pointHoverRadius: 4, borderWidth: 1.5, spanGaps: false /* Don't connect gaps */ }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: timeUnit, tooltipFormat: 'MMM d, yyyy HH:mm', displayFormats: { hour: 'HH:mm', day: 'MMM d', } },
                            grid: { color: colors.gridColor }, ticks: { color: colors.tickColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 },
                            title: { display: false } // No need for x-axis title
                        },
                        y: {
                            type: 'logarithmic', grid: { color: colors.gridColor },
                            ticks: { color: colors.tickColor, callback: (val) => val > 0 ? (val >= 1e6 ? val / 1e6 + 'M' : val >= 1e3 ? val / 1e3 + 'k' : val.toLocaleString()) : '' }, // Format ticks, handle zero/neg on log
                            title: { display: true, text: 'Price (Log Scale)', color: colors.titleColor }
                        }
                    },
                    plugins: {
                        tooltip: { mode: 'index', intersect: false, backgroundColor: colors.tooltipBgColor, titleColor: colors.tooltipTextColor, bodyColor: colors.tooltipTextColor },
                        legend: { labels: { color: colors.titleColor } }
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false },
                    animation: { duration: 300 },
                }
            };

            if (priceChart) {
                priceChart.destroy(); // Destroy old chart before creating new one
            }
            priceChart = new Chart(chartCtx, chartConfig);
            chartLoading.classList.add('hidden'); // Hide loading indicator
            hideErrorState(chartError); // Hide any previous errors

        }

        // Helper to update chart colors on theme change
        function updateChartTheme() {
            if (!priceChart) return;
            const colors = getChartColors();
            // Update colors in options
            priceChart.options.scales.x.grid.color = colors.gridColor;
            priceChart.options.scales.x.ticks.color = colors.tickColor;
            priceChart.options.scales.y.grid.color = colors.gridColor;
            priceChart.options.scales.y.ticks.color = colors.tickColor;
            priceChart.options.scales.y.title.color = colors.titleColor;
            priceChart.options.plugins.tooltip.backgroundColor = colors.tooltipBgColor;
            priceChart.options.plugins.tooltip.titleColor = colors.tooltipTextColor;
            priceChart.options.plugins.tooltip.bodyColor = colors.tooltipTextColor;
            priceChart.options.plugins.legend.labels.color = colors.titleColor;
            // Update dataset colors
            priceChart.data.datasets[0].borderColor = colors.buyColor;
            priceChart.data.datasets[0].backgroundColor = colors.buyColor;
            priceChart.data.datasets[1].borderColor = colors.askColor;
            priceChart.data.datasets[1].backgroundColor = colors.askColor;
            priceChart.update();
        }

        // --- Event Handlers ---
        function handleRowClick(event) {
            const row = event.currentTarget;
            const itemName = row.dataset.itemName;

            if (selectedItemName === itemName) return; // Don't reload if clicking the same item

            // Update selected item state
            selectedItemName = itemName;

            // Update row highlighting
            document.querySelectorAll('#market-body tr.selected-row').forEach(r => r.classList.remove('selected-row'));
            row.classList.add('selected-row');

            // **MODIFIED**: Call displayChart directly
            displayChart(itemName);
        }

        function handleChartRangeChange(event) {
            if (event.target.tagName !== 'BUTTON') return;
            const newRange = event.target.dataset.range;
            if (newRange === currentChartRange) return;

            currentChartRange = newRange;
            // Update button active state
            chartControls.querySelectorAll('button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range === newRange);
            });

            // Re-render the chart for the currently selected item with the new range
            if (selectedItemName) {
                displayChart(selectedItemName);
            }
        }

        // Debounced search handler
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterAndSort, 300); // Apply filter after 300ms pause
        });

        // Category filter handler
        categorySelect.addEventListener('change', filterAndSort);

        // Table sort handler
        document.querySelector('#market-table thead').addEventListener('click', handleSort);

        // Chart range controls handler
        chartControls.addEventListener('click', handleChartRangeChange);

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData(); // Fetch summary and ALL history data
            initTheme(); // Initialize theme
            updateSortIcons(); // Set initial sort icons
        });

    </script>
</body>
</html>
