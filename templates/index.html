<!DOCTYPE html>
<html lang="en"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MWI Market Trends</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            /* Light Theme Definitions */
            --bg-color: #f6f8fa;
            --card-bg-color: #ffffff;
            --text-color-primary: #24292f;
            --text-color-secondary: #57606a;
            --muted-text-color: #57606a;
            --border-color: #d0d7de;
            --accent-color: #0969da;
            --accent-hover-color: #0550ae;
            --positive-color: #1a7f37;
            --negative-color: #cf222e;
            --button-bg-color: #f6f8fa;
            --button-hover-bg-color: #f0f2f4;
            --button-border-color: rgba(27, 31, 36, 0.15);
            --button-hover-border-color: rgba(27, 31, 36, 0.35);
            --button-active-bg-color: var(--accent-color);
            --button-active-text-color: #ffffff;
            --button-active-border-color: var(--accent-color);
            --input-bg-color: var(--card-bg-color);
            --input-border-color: var(--border-color);
            --input-focus-border-color: var(--accent-color);
            --input-focus-shadow-color: rgba(9, 105, 218, 0.3);
            --table-header-bg: #f6f8fa;
            --table-row-even-bg: #fbfcfd;
            --table-row-hover-bg: #f6f8fa;
            --table-row-selected-bg: #ddf4ff;
            --link-color: var(--accent-color);
            --link-hover-color: var(--accent-hover-color);
            --code-font: SFMono-Regular, Consolas, "Liberation Mono", Menlo, Courier, monospace;
            --na-value-color: #cdd4de;
            --vendor-price-color: var(--text-color-secondary);
            --chart-placeholder-color: #b0b8c2;
            --chart-title-color: var(--text-color-primary);
            --chart-legend-color: var(--text-color-primary);
            --chart-tick-color: var(--text-color-secondary);
            --chart-grid-color: var(--border-color);
            --chart-buy-color: var(--accent-color); /* Use accent for buy */
            --chart-ask-color: var(--negative-color); /* Use negative for ask */
            --chart-tooltip-bg: rgba(0, 0, 0, 0.8);
            --chart-tooltip-text-color: #ffffff;
            --pin-color: #d0d7de; /* Color for unpinned star */
            --pin-color-active: #ffab00; /* Color for pinned star (gold) */
        }

        html[data-theme="dark"] {
             /* Dark Theme Overrides */
            --bg-color: #0d1117;
            --card-bg-color: #161b22;
            --text-color-primary: #c9d1d9;
            --text-color-secondary: #8b949e;
            --muted-text-color: #8b949e;
            --border-color: #30363d;
            --accent-color: #58a6ff;
            --accent-hover-color: #79c0ff;
            --positive-color: #3fb950;
            --negative-color: #f85149;
            --button-bg-color: #21262d;
            --button-hover-bg-color: #30363d;
            --button-border-color: #30363d;
            --button-hover-border-color: #8b949e;
            --button-active-bg-color: var(--accent-color);
            --button-active-text-color: #ffffff;
            --button-active-border-color: var(--accent-color);
            --input-bg-color: var(--card-bg-color);
            --input-border-color: var(--border-color);
            --input-focus-border-color: var(--accent-color);
            --input-focus-shadow-color: rgba(88, 166, 255, 0.3);
            --table-header-bg: #161b22;
            --table-row-even-bg: #1a1f27;
            --table-row-hover-bg: #21262d;
            --table-row-selected-bg: #1f6feb;
            --link-color: var(--accent-color);
            --link-hover-color: var(--accent-hover-color);
            --na-value-color: #484f58;
            --vendor-price-color: var(--text-color-secondary);
            --chart-placeholder-color: #6e7681;
            --chart-title-color: var(--text-color-primary);
            --chart-legend-color: var(--text-color-primary);
            --chart-tick-color: var(--text-color-secondary);
            --chart-grid-color: #21262d;
            --chart-buy-color: var(--accent-color); /* Use accent for buy */
            --chart-ask-color: var(--negative-color); /* Use negative for ask */
            --chart-tooltip-bg: rgba(201, 209, 217, 0.9);
            --chart-tooltip-text-color: #0d1117;
            --pin-color: #484f58; /* Dark mode unpinned star */
            --pin-color-active: #f1e05a; /* Dark mode pinned star (lighter gold) */
        }

        /* --- General Styles (Using Variables) --- */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif; margin: 0; padding: 0;
            background-color: var(--bg-color); color: var(--text-color-primary);
            line-height: 1.5; font-size: 14px;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            /* Removed padding-bottom */
        }
        .container { max-width: 1600px; margin: 25px auto; padding: 0 25px; }
        h1 { text-align: center; color: var(--text-color-primary); margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600; font-size: 1.8em; letter-spacing: -0.5px; }

        /* Container for the buttons under title */
        .title-button-container {
            text-align: center; /* Center the buttons */
            margin-bottom: 25px; /* Space below buttons */
            display: flex; /* Use flexbox */
            justify-content: center; /* Center items horizontally */
            gap: 10px; /* Add space between buttons */
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        /* Style for the theme toggle button */
        #theme-toggle-btn, #show-test-graph-btn, #show-live-data-btn { /* Apply to all buttons */
            padding: 6px 16px; font-size: 0.9em; font-weight: 500;
            background-color: var(--button-bg-color); color: var(--text-color-primary);
            border: 1px solid var(--button-border-color); border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
            display: inline-flex; /* Align icon and text */
            align-items: center;
            gap: 6px; /* Space between icon and text */
        }
        #theme-toggle-btn:hover, #show-test-graph-btn:hover, #show-live-data-btn:hover { background-color: var(--button-hover-bg-color); }
        /* Icon visibility styles */
        #theme-toggle-btn .fa-sun { display: none; }
        #theme-toggle-btn .fa-moon { display: inline-block; }
        html[data-theme="dark"] #theme-toggle-btn .fa-sun { display: inline-block; }
        html[data-theme="dark"] #theme-toggle-btn .fa-moon { display: none; }


        .feedback-link-container { text-align: center; margin-bottom: 25px; font-size: 0.9em; }
        .feedback-link-container a { color: var(--muted-text-color); text-decoration: none; border-bottom: 1px dashed var(--muted-text-color); transition: color 0.2s, border-color 0.2s; padding-bottom: 1px; }
        .feedback-link-container a:hover { color: var(--link-color); border-color: var(--link-color); }
        .controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 16px 20px; margin-bottom: 30px; gap: 15px; background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 6px; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;}
        .controls-left, .controls-right { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
        .search-form input[type="text"], .category-filter select { padding: 8px 12px; border: 1px solid var(--input-border-color); border-radius: 6px; min-width: 200px; font-size: 0.95em; background-color: var(--input-bg-color); box-shadow: inset 0 1px 0 rgba(27,31,36,0.075); transition: border-color 0.1s ease-in-out, box-shadow 0.1s ease-in-out, background-color 0.2s ease-in-out, color 0.2s ease-in-out; color: var(--text-color-primary);}
        .search-form input[type="text"]:focus, .category-filter select:focus { border-color: var(--input-focus-border-color); box-shadow: inset 0 1px 0 rgba(27,31,36,0.075), 0 0 0 3px var(--input-focus-shadow-color); outline: none; }
        .sort-options span { font-weight: 600; color: var(--text-color-secondary); margin-right: 4px; font-size: 0.9em; }
        .sort-options button { padding: 5px 12px; background-color: var(--button-bg-color); color: var(--text-color-primary); border-radius: 6px; font-size: 0.9em; transition: background-color 0.1s ease-in-out, border-color 0.1s ease-in-out; border: 1px solid var(--button-border-color); box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04); cursor: pointer; font-weight: 500; line-height: 20px; }
        .sort-options button:hover { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .sort-options button.current-sort { background-color: var(--button-active-bg-color); color: var(--button-active-text-color); border-color: var(--button-active-border-color); font-weight: 600; }
        .main-layout { display: flex; flex-wrap: wrap; gap: 25px; }
        .item-table-container { flex: 3; min-width: 550px; }
        .chart-display-container { flex: 2; min-width: 400px; }
        .table-wrapper { max-height: 78vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--card-bg-color); transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;}
        #item-table { width: 100%; border-collapse: collapse; }
        #item-table th, #item-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; font-size: 0.95em; }
        #item-table th { background-color: var(--table-header-bg); font-weight: 600; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted-text-color); position: sticky; top: 0; z-index: 1; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;}
        #item-table th.pin-header { width: 40px; text-align: center; padding: 10px 5px;} /* Style for pin header */
        #item-table td.pin-cell { text-align: center; padding: 10px 5px;} /* Style for pin cell */
        .pin-icon { cursor: pointer; color: var(--pin-color); font-size: 1.1em; transition: color 0.15s ease-in-out; }
        .pin-icon.pinned { color: var(--pin-color-active); }
        .pin-icon:hover { opacity: 0.7; }

        #item-table tbody tr { transition: background-color 0.15s ease; }
        #item-table tbody tr:nth-child(even) { background-color: var(--table-row-even-bg); }
        #item-table tbody tr:hover { background-color: var(--table-row-hover-bg); }
        #item-table tbody tr.selected-item { background-color: var(--table-row-selected-bg); font-weight: 500; }
        #item-table td { color: var(--text-color-primary); } /* Added */
        #item-table td:nth-child(2) { font-weight: 500; cursor: pointer; color: var(--link-color); max-width: 220px; overflow: hidden; text-overflow: ellipsis; } /* Adjust column index for name */
        #item-table td:nth-child(2):hover { text-decoration: underline; color: var(--link-hover-color); } /* Adjust column index */
        #item-table td:nth-child(3) { font-size: 0.9em; color: var(--muted-text-color); max-width: 160px; overflow: hidden; text-overflow: ellipsis; } /* Adjust column index */
        /* Adjusted nth-child for swapped Ask/Buy */
        #item-table td:nth-child(n+5) { text-align: right; font-family: var(--code-font); font-size: 0.95em; } /* Vendor/Trend */
        #item-table td:nth-child(4) { text-align: right; font-family: var(--code-font); font-size: 0.95em; } /* Ask */
        #item-table td:nth-child(5) { text-align: right; font-family: var(--code-font); font-size: 0.95em; } /* Buy */


        .trend-value-container { display: flex; align-items: center; justify-content: flex-end; gap: 3px; }
        .trend-icon { width: 14px; height: 14px; vertical-align: text-bottom; }
        .trend-positive { color: var(--positive-color); }
        .trend-negative { color: var(--negative-color); }
        .vendor-price { color: var(--vendor-price-color); }
        .na-value { color: var(--na-value-color); font-style: normal; }
        .chart-display { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 20px; min-height: 450px; position: relative; display: flex; flex-direction: column; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;}

        .chart-controls-container { /* Container for all chart controls */
             display: flex;
             justify-content: center; /* Center inner divs */
             align-items: center;
             flex-wrap: wrap; /* Allow wrapping */
             gap: 15px; /* Space between control groups */
             margin-bottom: 15px;
        }
        .chart-controls { text-align: center; } /* Original class for time */
        .scale-controls { text-align: center; } /* New class for scale toggle */

        .chart-controls button, .scale-controls button { margin: 0 4px; padding: 5px 10px; font-size: 0.85em; background-color: var(--button-bg-color); border: 1px solid var(--button-border-color); box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04); border-radius: 6px; cursor: pointer; transition: background-color 0.1s ease-in-out, border-color 0.1s ease-in-out; font-weight: 500; color: var(--text-color-primary);}
        .chart-controls button:hover, .scale-controls button:hover { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .chart-controls button.active, .scale-controls button.active { background-color: var(--button-active-bg-color); color: var(--button-active-text-color); border-color: var(--button-active-border-color); font-weight: 600; }

        .chart-placeholder { text-align: center; color: var(--chart-placeholder-color); padding: 60px; font-size: 1.05em; flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        .chart-plot { flex-grow: 1; position: relative; min-height: 320px; }
        .chart-plot canvas { max-width: 100%; max-height: 380px; }
        .pagination { text-align: center; margin-top: 20px; padding-bottom: 20px; }
        .pagination button { margin: 0 3px; padding: 7px 14px; background-color: var(--button-bg-color); border: 1px solid var(--button-border-color); box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04); color: var(--accent-color); border-radius: 6px; transition: background-color 0.1s, border-color 0.1s; cursor: pointer; font-weight: 500; font-size: 0.9em; }
        .pagination button:hover:not(:disabled) { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .pagination button.current { background-color: var(--button-active-bg-color); color: var(--button-active-text-color); border-color: var(--button-active-border-color); font-weight: bold; cursor: default; }
        .pagination button:disabled { color: var(--muted-text-color); background-color: var(--button-bg-color); opacity: 0.6; cursor: not-allowed; border-color: transparent; }
        .loading-message, .error-message { text-align: center; padding: 40px; font-size: 1.1em; color: var(--muted-text-color); }
        .error-message { color: var(--negative-color); }
        .hidden { display: none; }
        footer { text-align: center; margin-top: 60px; padding: 25px 0; font-size: 0.8em; color: var(--muted-text-color); border-top: 1px solid var(--border-color); transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;}
        footer span, footer a { margin: 0 8px; color: var(--muted-text-color); text-decoration: none; }
        footer a:hover { text-decoration: underline; color: var(--link-hover-color); }
         @media (max-width: 768px) {
            .controls { flex-direction: column; align-items: stretch; }
            .controls-left, .controls-right { width: 100%; justify-content: center; }
            .search-form input[type="text"], .category-filter select { width: 100%; min-width: unset; }
            .main-layout { flex-direction: column; }
            .item-table-container, .chart-display-container { min-width: unset; }
            .table-wrapper { max-height: 60vh; }
            h1 { font-size: 1.5em; }
            /* Removed fixed button container styles */
            .chart-controls-container { flex-direction: column; gap: 10px; }
        }

        /* Removed dark mode override block - styles now use CSS variables */

        /* Removed fixed theme toggle button styles */

    </style>
</head>
<body>

    <div class="container">
        <h1>MWI Market Trends</h1>
        <div class="title-button-container" >
             <button id="theme-toggle-btn" title="Toggle Theme">
                 <i class="fas fa-moon"></i>
                 <i class="fas fa-sun"></i>
                 <span class="toggle-text" style="margin-left: 6px;">Toggle Theme</span>
             </button>
             <button id="show-test-graph-btn" title="Show Test Graph">Show Test Graph</button>
             <button id="show-live-data-btn" title="Show Live Data">Show Live Data</button>
        </div>
        <div class="feedback-link-container">
            <a href="https://github.com/SporkSlinger/market-tracker-mwi/issues" target="_blank" rel="noopener noreferrer">Report an Issue or Suggest a Feature</a>
        </div>

        <div class="controls">
            <div class="controls-left">
                 <div class="search-form">
                    <input type="text" id="search-input" placeholder="Search Product Name...">
                </div>
                <div class="category-filter">
                     <select id="category-filter">
                         <option value="All">All Categories</option>
                         {% for category in categories %}
                         <option value="{{ category }}">{{ category }}</option>
                         {% endfor %}
                     </select>
                </div>
            </div>
            <div class="controls-right">
                 <div class="sort-options" id="sort-options">
                    <span>Sort By:</span>
                    <button data-sort="name_asc" class="current-sort">Name</button>
                    <button data-sort="category_asc">Category</button>
                    <button data-sort="ask_asc">Ask</button>
                    <button data-sort="buy_desc">Buy</button>
                    <button data-sort="vendor_desc">Vendor</button>
                    <button data-sort="trend_dec">Trend %</button>
                 </div>
            </div>
        </div>

        <div class="main-layout">
            <div class="item-table-container">
                <div id="loading-message" class="loading-message">Loading market data...</div>
                <div id="error-message" class="error-message hidden"></div>
                <div class="table-wrapper hidden">
                    <table id="item-table">
                        <thead>
                            <tr>
                                <th class="pin-header"><i class="fas fa-thumbtack"></i></th> <th>Name</th>
                                <th>Category</th>
                                <th>Ask</th>
                                <th>Buy</th>
                                <th>Vendor</th>
                                <th>Trend (24h)</th>
                            </tr>
                        </thead>
                        <tbody id="item-table-body"></tbody>
                    </table>
                </div>
                <div class="pagination" id="pagination" style="display: none;">
                    <button id="prev-page" disabled>&laquo; Previous</button>
                    <span id="page-info">Page 1 of 1</span>
                    <button id="next-page" disabled>Next &raquo;</button>
                </div>
            </div>

            <div class="chart-display-container">
                <div class="chart-display" id="chart-display">
                     <div class="chart-controls-container" id="chart-controls-area" style="display: none;">
                         <div class="chart-controls" id="chart-time-controls">
                             <button data-range="24h">24h</button>
                             <button data-range="48h">48h</button>
                             <button data-range="7d">7d</button>
                             <button data-range="30d" class="active">30d</button>
                         </div>
                          <div class="scale-controls">
                             <button id="scale-toggle-btn">Switch to Linear Scale</button>
                         </div>
                     </div>
                    <div class="chart-placeholder" id="chart-placeholder">Select an item name from the table to view its chart.</div>
                    <div class="chart-plot hidden">
                        <canvas id="single-chart-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <footer>
        <span>Made by Sporky with AI</span> |
        <span class="status">Data Generated: <span id="last-update">{{ last_update }}</span></span> |
        <a href="https://github.com/SporkSlinger/market-tracker-mwi" target="_blank" rel="noopener noreferrer">GitHub Repo</a>
    </footer>

     <script>
        // --- Global State (Original + Scale Type + Pinned Items) ---
        let allMarketData = {}; // Expecting nested object: { "Product": { buy: [...], ask: [...] } }
        let marketSummary = []; // Array of { name, category, buy, ask, vendor, trend }
        let filteredAndSortedSummary = []; // Items currently displayed in table
        let currentChart = null;
        let currentPage = 1;
        const itemsPerPage = 20;
        let currentSort = 'name_asc';
        let currentSearch = '';
        let currentCategoryFilter = 'All';
        let selectedTableRow = null;
        let currentChartProduct = null;
        let currentChartTimeRange = '30d';
        let currentYScaleType = 'logarithmic';
        let pinnedItems = []; // Array to hold names of pinned items
        const PINNED_ITEMS_KEY = 'mwiPinnedItems'; // localStorage key
        const MAX_PINNED_ITEMS = 10; // Max number of items user can pin

        // --- DOM Elements (Original + New Buttons) ---
        const tableBodyEl = document.getElementById('item-table-body');
        const tableWrapperEl = document.querySelector('.table-wrapper');
        const paginationEl = document.getElementById('pagination');
        const pageInfoEl = document.getElementById('page-info');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        const searchInput = document.getElementById('search-input');
        const categoryFilterEl = document.getElementById('category-filter');
        const sortOptionsEl = document.getElementById('sort-options');
        const chartCanvas = document.getElementById('single-chart-canvas');
        const chartPlotContainer = document.querySelector('.chart-plot');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const chartTimeControlsEl = document.getElementById('chart-time-controls');
        const chartControlsArea = document.getElementById('chart-controls-area'); // Container for all chart controls
        const scaleToggleButton = document.getElementById('scale-toggle-btn'); // Scale toggle button
        const loadingMessageEl = document.getElementById('loading-message');
        const errorMessageEl = document.getElementById('error-message');
        const themeToggleButton = document.getElementById('theme-toggle-btn'); // Renamed reference for new toggle button
        const showTestGraphBtn = document.getElementById('show-test-graph-btn'); // Added test graph button
        const showLiveDataBtn = document.getElementById('show-live-data-btn'); // Added live data button


        // --- SVG Icons for Trends (Original) ---
        const trendUpIcon = `<svg class="trend-icon" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true"><path fill="currentColor" d="M8.707 2.293a1 1 0 0 0-1.414 0l-4 4a1 1 0 1 0 1.414 1.414L8 4.414l3.293 3.293a1 1 0 0 0 1.414-1.414l-4-4Z"></path></svg>`;
        const trendDownIcon = `<svg class="trend-icon" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true"><path fill="currentColor" d="M7.293 13.707a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0-1.414-1.414L8 11.586 4.707 8.293a1 1 0 0 0-1.414 1.414l4 4Z"></path></svg>`;

        // --- Utility Functions (Original) ---
        function formatPrice(price) {
            if (price === null || price === undefined || isNaN(price)) return '<span class="na-value">--</span>';
            return price.toLocaleString();
        }
        function formatTrend(trend) {
            if (trend === null || trend === undefined || isNaN(trend)) return '<span class="na-value">--</span>';
            const arrow = trend > 0 ? trendUpIcon : trend < 0 ? trendDownIcon : '';
            const trendClass = trend > 0 ? 'trend-positive' : trend < 0 ? 'trend-negative' : '';
            return `<span class="trend-value-container ${trendClass}">${arrow}<span>${trend.toFixed(2)}%</span></span>`;
        }

        // --- Pinning Logic ---
        function getPinnedItems() {
            const stored = localStorage.getItem(PINNED_ITEMS_KEY);
            try {
                const parsed = JSON.parse(stored);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                return [];
            }
        }

        function savePinnedItems(items) {
            localStorage.setItem(PINNED_ITEMS_KEY, JSON.stringify(items));
        }

        function togglePin(itemName) {
            let currentPins = getPinnedItems();
            const index = currentPins.indexOf(itemName);

            if (index > -1) {
                // Item is currently pinned, unpin it
                currentPins.splice(index, 1);
                console.log(`Unpinned: ${itemName}`);
            } else {
                // Item is not pinned, pin it (if limit not reached)
                if (currentPins.length >= MAX_PINNED_ITEMS) {
                    alert(`You can only pin up to ${MAX_PINNED_ITEMS} items.`); // Simple alert for limit
                    return; // Do nothing if limit reached
                }
                currentPins.push(itemName);
                console.log(`Pinned: ${itemName}`);
            }

            savePinnedItems(currentPins);
            pinnedItems = currentPins; // Update global state
            applyFiltersAndSort(); // Re-sort and re-render the table
        }

         function handlePinClick(event) {
             // Prevent click from triggering row selection/chart display if clicking the icon itself
             event.stopPropagation();
             const icon = event.currentTarget; // The icon element
             const itemName = icon.dataset.itemName;
             if (itemName) {
                 togglePin(itemName);
             } else {
                 console.error("Could not find item name for pinning.");
             }
         }


        // --- Theme Switching Logic (Simplified - No Chart Update) ---
        const THEME_KEY = 'mwi-market-theme';
        function applyTheme(theme) {
            // ONLY sets the attribute and saves to localStorage
            console.log(`Applying theme: ${theme}`); // Keep log for basic check
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            localStorage.setItem(THEME_KEY, theme);
            // NO direct chart manipulation here
        }

        function toggleTheme() { // Simple toggle logic
            console.log("toggleTheme called"); // Keep log
            const currentTheme = document.documentElement.hasAttribute('data-theme') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            console.log(`Switching to theme: ${newTheme}`); // Keep log
            applyTheme(newTheme);
        }

        function initTheme() { // Applies theme on load
            console.log("initTheme called"); // Keep log
            const savedTheme = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
            console.log(`Initializing with theme: ${initialTheme}`); // Keep log
            applyTheme(initialTheme);
        }
        // Add listener for the theme toggle button
        if (themeToggleButton) {
             themeToggleButton.addEventListener('click', toggleTheme);
        } else {
             console.error("Theme toggle button (#theme-toggle-btn) not found!");
        }

        // REMOVED updateChartTheme, getChartColors, getCssVariable


        // --- Data Fetching (Restored Live Fetching) ---
        async function loadData() {
            // Reset chart view state before loading
            if(currentChart) { currentChart.destroy(); currentChart = null; }
            chartPlotContainer.classList.add('hidden');
            chartControlsArea.style.display = 'none';
            chartPlaceholder.style.display = 'flex';
            chartPlaceholder.textContent = 'Select an item name from the table to view its chart.'; // Reset placeholder text
            currentChartProduct = null;
            if(selectedTableRow) selectedTableRow.classList.remove('selected-item');
            selectedTableRow = null;

            // Show loading indicators
            loadingMessageEl.style.display = 'block';
            errorMessageEl.classList.add('hidden');
            tableWrapperEl.classList.add('hidden');
            paginationEl.style.display = 'none';

            try {
                // Load pinned items initially
                pinnedItems = getPinnedItems();
                console.log("Loaded pinned items:", pinnedItems);

                const summaryRes = await fetch('./data/market_summary.json?t=' + Date.now());
                if (!summaryRes.ok) throw new Error(`Failed to fetch market_summary.json (Status: ${summaryRes.status})`);
                marketSummary = await summaryRes.json();

                applyFiltersAndSort(); // Process summary data first
                loadingMessageEl.style.display = 'none';
                tableWrapperEl.classList.remove('hidden');
                paginationEl.style.display = 'flex'; // Show pagination based on results later

                // Fetch history data
                const historyRes = await fetch('./data/market_history.json?t=' + Date.now());
                if (!historyRes.ok) {
                    console.warn(`Failed to fetch market_history.json (Status: ${historyRes.status}). Charts may not work.`);
                    allMarketData = {}; // Set to empty object if fetch fails
                } else {
                    allMarketData = await historyRes.json(); // Assumes nested structure
                    console.log("Market history data loaded.");
                }

            } catch (error) {
                console.error("Error loading data:", error); // Keep generic error log
                loadingMessageEl.style.display = 'none';
                // Show generic error message for ANY load failure
                errorMessageEl.textContent = `Error loading market data: ${error.message}. Check console (F12) & data files.`;
                errorMessageEl.classList.remove('hidden');
                tableWrapperEl.classList.add('hidden'); // Ensure table is hidden on error
                paginationEl.style.display = 'none'; // Ensure pagination is hidden on error
            }
        }


        // --- Filtering and Sorting (MODIFIED for Pinning) ---
        function applyFiltersAndSort() {
            let result = [...marketSummary]; // Use live or sample marketSummary
            // Apply category filter
            if (currentCategoryFilter !== 'All') {
                result = result.filter(item => item.category === currentCategoryFilter);
            }
            // Apply search term filter
            const searchTerm = currentSearch.toLowerCase();
            if (searchTerm) {
                result = result.filter(item => item.name.toLowerCase().includes(searchTerm));
            }

            // Get current pinned items for sorting
            const currentPins = getPinnedItems();

            // Apply sorting (pinning takes priority)
            result.sort((a, b) => {
                const isAPinned = currentPins.includes(a.name);
                const isBPinned = currentPins.includes(b.name);

                // Rule 1: Pinned items come before unpinned items
                if (isAPinned && !isBPinned) return -1;
                if (!isAPinned && isBPinned) return 1;

                // Rule 2: If both are pinned or both unpinned, use selected sort
                try {
                    const sortNum = (valA, valB, ascending = true) => {
                        const numA = valA ?? (ascending ? Infinity : -Infinity);
                        const numB = valB ?? (ascending ? Infinity : -Infinity);
                        if (isNaN(numA)) return ascending ? 1 : -1;
                        if (isNaN(numB)) return ascending ? -1 : 1;
                        return ascending ? numA - numB : numB - numA;
                    };
                    const sortStr = (valA, valB, ascending = true) => {
                        const strA = (valA ?? '').toLowerCase(); const strB = (valB ?? '').toLowerCase();
                        const compare = strA.localeCompare(strB);
                        return ascending ? compare : -compare;
                    };
                    switch (currentSort) {
                        case 'name_desc': return sortStr(a.name, b.name, false);
                        case 'category_asc': return sortStr(a.category, b.category, true);
                        case 'buy_desc': return sortNum(a.buy, b.buy, false);
                        case 'ask_asc': return sortNum(a.ask, b.ask, true);
                        case 'vendor_desc': return sortNum(a.vendor, b.vendor, false);
                        case 'trend_inc': return sortNum(a.trend, b.trend, true);
                        case 'trend_dec': return sortNum(a.trend, b.trend, false);
                        case 'name_asc': default: return sortStr(a.name, b.name, true);
                    }
                } catch (e) { console.error("Sort comparison error:", e); return 0; }
            });

            filteredAndSortedSummary = result;
            currentPage = 1; // Reset to first page after filtering/sorting
            renderCurrentPage(); // Render the table and update pagination
        }

        // --- Rendering (MODIFIED for Pinning) ---
        function renderCurrentPage() {
            tableBodyEl.innerHTML = '';
            // Deselect previous row visually if any (keep this)
            if (selectedTableRow) {
                selectedTableRow.classList.remove('selected-item');
                selectedTableRow = null;
            }

            const currentPins = getPinnedItems(); // Get pinned items for styling icons

            const totalItems = filteredAndSortedSummary.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            currentPage = Math.max(1, Math.min(currentPage, totalPages || 1));
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const itemsToDisplay = filteredAndSortedSummary.slice(startIndex, endIndex);

            if (itemsToDisplay.length === 0) {
                 // Adjust message slightly if marketSummary itself is empty (initial state or true empty)
                 const message = marketSummary.length === 0 ? 'Loading data or no data available.' :
                                 (currentSearch || currentCategoryFilter !== 'All' ? 'No items match your filters.' : 'No market data available.');
                 const tr = document.createElement('tr');
                 const td = document.createElement('td');
                 td.colSpan = 7; // Adjusted colspan for new pin column
                 td.textContent = message; td.style.textAlign = 'center';
                 td.style.padding = '20px'; td.style.color = 'var(--muted-text-color)';
                 tr.appendChild(td); tableBodyEl.appendChild(tr);
            } else {
                itemsToDisplay.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.dataset.product = encodeURIComponent(item.name); // Keep this for chart click
                    // tr.style.cursor = 'pointer'; // Cursor applied to name cell now

                    const isPinned = currentPins.includes(item.name);
                    const pinIconClass = isPinned ? 'fas fa-star pin-icon pinned' : 'far fa-star pin-icon';

                    // Create cells, including the new pin cell
                    // ** Swapped Ask/Buy Order **
                    tr.innerHTML = `
                        <td class="pin-cell"><i class="${pinIconClass}" data-item-name="${item.name}" title="${isPinned ? 'Unpin' : 'Pin'} Item"></i></td>
                        <td><a class="item-name-link">${item.name}</a></td>
                        <td>${item.category || '<span class="na-value">N/A</span>'}</td>
                        <td>${formatPrice(item.ask)}</td>
                        <td>${formatPrice(item.buy)}</td>
                        <td><span class="vendor-price">${formatPrice(item.vendor)}</span></td>
                        <td>${formatTrend(item.trend)}</td>
                    `;
                    // Add listener to the pin icon
                    tr.querySelector('.pin-icon').addEventListener('click', handlePinClick);
                    // Add listener to the item name for showing the chart
                    tr.querySelector('.item-name-link').addEventListener('click', handleProductClick); // Use handleProductClick for name
                    tr.querySelector('.item-name-link').style.cursor = 'pointer'; // Make name look clickable

                    tableBodyEl.appendChild(tr);
                    if (item.name === currentChartProduct) {
                         tr.classList.add('selected-item');
                         selectedTableRow = tr;
                    }
                });
            }
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            pageInfoEl.textContent = `Page ${currentPage} of ${totalPages || 1}`;
            prevButton.disabled = currentPage <= 1;
            nextButton.disabled = currentPage >= totalPages;
            paginationEl.style.display = totalPages > 1 ? 'flex' : 'none';
        }

        // --- Charting (Reverted to Original Colors, Kept Scale Toggle/Refinements) ---
        function displayChart(productName, clickedTrElement) { // clickedTrElement might be null if called manually
            chartPlaceholder.style.display = 'none';
            chartPlotContainer.classList.remove('hidden');
            chartControlsArea.style.display = 'flex';

            // Update selection visuals only if triggered by a click
            // Find the actual TR element in the current table view to select it
            const currentTableRows = tableBodyEl.querySelectorAll('tr');
            selectedTableRow = null; // Reset first
            currentTableRows.forEach(row => {
                row.classList.remove('selected-item'); // Deselect all rows
                // Check if row has the dataset.product before decoding
                if (row.dataset.product && decodeURIComponent(row.dataset.product) === productName) {
                    row.classList.add('selected-item'); // Select the matching row
                    selectedTableRow = row;
                }
            });
            // If triggered manually (no clickedTrElement), selectedTableRow might remain null if item not on current page

            currentChartProduct = productName;

            let productHistoryData;
             // Use the globally stored (live or sample) data
            if (allMarketData && allMarketData[productName]) {
                 productHistoryData = allMarketData[productName];
            }

            if (!productHistoryData || (!productHistoryData.buy?.length && !productHistoryData.ask?.length)) {
                console.warn(`No chart data found or provided for ${productName}.`);
                if (currentChart) { currentChart.destroy(); currentChart = null; }
                chartPlotContainer.classList.add('hidden');
                chartControlsArea.style.display = 'none';
                chartPlaceholder.textContent = `No price history data available for ${productName}.`;
                chartPlaceholder.style.display = 'flex';
                return;
            }

            let filteredBuy = productHistoryData.buy || [];
            let filteredAsk = productHistoryData.ask || [];
            const now = new Date();
            let startDate;
            let timeUnit = 'day';

            if (currentChartTimeRange === '24h') { startDate = new Date(now.getTime() - (24 * 60 * 60 * 1000)); timeUnit = 'hour'; }
            else if (currentChartTimeRange === '48h') { startDate = new Date(now.getTime() - (2 * 24 * 60 * 60 * 1000)); timeUnit = 'hour'; }
            else if (currentChartTimeRange === '7d') { startDate = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000)); timeUnit = 'day'; }

            if (startDate) {
                const filterPoints = (points) => points.filter(p => (p.timestamp * 1000) >= startDate.getTime());
                filteredBuy = filterPoints(filteredBuy);
                filteredAsk = filterPoints(filteredAsk);
            }

            if (filteredBuy.length < 1 && filteredAsk.length < 1) {
                 console.warn(`No chart data in range ${currentChartTimeRange} for ${productName}`);
                 if (currentChart) { currentChart.destroy(); currentChart = null; }
                 chartPlotContainer.classList.add('hidden');
                 chartControlsArea.style.display = 'none';
                 chartPlaceholder.textContent = `No data available for ${productName} in the selected time range (${currentChartTimeRange}).`;
                 chartPlaceholder.style.display = 'flex';
                 return;
            }

            // Robust data parsing
            const parsePoints = (points) => points
                .map(p => {
                    const price = (typeof p.price === 'number' && isFinite(p.price)) ? p.price : null;
                    const timestamp = (typeof p.timestamp === 'number' && isFinite(p.timestamp)) ? new Date(p.timestamp * 1000) : null;
                    if (timestamp === null) { console.warn("Invalid timestamp:", p); return null; }
                    return { x: timestamp, y: price };
                })
                .filter(p => p !== null);

            const buyData = parsePoints(filteredBuy);
            const askData = parsePoints(filteredAsk);

            // Update scale toggle button text
            if(scaleToggleButton) {
                scaleToggleButton.textContent = currentYScaleType === 'logarithmic' ? 'Switch to Linear Scale' : 'Switch to Log Scale';
            }

            // ** CORRECTED Dataset Order **
            const chartData = {
                datasets: [
                     // Ask is first for tooltip order
                    { label: 'Ask', data: askData, borderColor: '#cf222e', backgroundColor: 'rgba(207, 34, 46, 0.1)', tension: 0, pointRadius: 2, pointHoverRadius: 5, spanGaps: false, borderWidth: 1.5 },
                    // Buy is second
                    { label: 'Buy', data: buyData, borderColor: '#0969da', backgroundColor: 'rgba(9, 105, 218, 0.1)', tension: 0, pointRadius: 2, pointHoverRadius: 5, spanGaps: false, borderWidth: 1.5 }
                ]
            };

            if (currentChart) { currentChart.destroy(); }

            try {
                // ** REVERTED options colors to original hardcoded values **
                currentChart = new Chart(chartCanvas, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: `${productName} (${currentChartTimeRange})`, font: { size: 15, weight: '600' }, padding: { bottom: 15 }, color: '#24292f' }, // Hardcoded
                            legend: { position: 'top', labels: { font: { size: 12 }, color: '#24292f' } }, // Hardcoded
                            tooltip: { mode: 'index', intersect: false, bodySpacing: 5, titleSpacing: 6, padding: 10, boxPadding: 4 } // Default tooltip
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: timeUnit, tooltipFormat: 'PPp', displayFormats: { hour: 'h:mm a', day: 'MMM d', week: 'MMM d yy' } },
                                title: { display: false },
                                grid: { display: false }, // Keep X grid off
                                ticks: { font: { size: 11 }, color: '#57606a', autoSkip: true, maxRotation: 0, minRotation: 0, maxTicksLimit: 8 } // Hardcoded
                            },
                            y: {
                                type: currentYScaleType, // Keep dynamic scale type
                                min: currentYScaleType === 'logarithmic' ? 1 : undefined,
                                grace: '10%', // Keep grace
                                title: { display: true, text: `Price (${currentYScaleType === 'logarithmic' ? 'Log' : 'Linear'} Scale)`, font: { size: 12 }, color: '#57606a' }, // Hardcoded
                                grid: { color: '#d0d7de' }, // Hardcoded
                                ticks: {
                                    font: { size: 11 }, color: '#57606a', // Hardcoded
                                    // Keep refined tick formatting
                                    callback: currentYScaleType === 'logarithmic'
                                      ? function(value) {
                                          if (value <= 0) return null;
                                          if (value < 1000) return value.toLocaleString();
                                          if (value >= 1e9) return (value / 1e9).toFixed(1) + 'B';
                                          if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
                                          if (value >= 1e3) return (value / 1e3).toFixed(1) + 'k';
                                          const log10 = Math.log10(value);
                                          if (Math.abs(log10 - Math.round(log10)) < 0.01) { return value.toLocaleString(); }
                                          return null;
                                        }
                                      : function(value) { return value.toLocaleString(); }
                                }
                            }
                        },
                        interaction: { mode: 'index', axis: 'x', intersect: false },
                         animation: { duration: 0 }
                    }
                });
            } catch(e) {
                console.error("Error creating Chart.js instance:", e);
                chartPlotContainer.classList.add('hidden');
                chartControlsArea.style.display = 'none';
                chartPlaceholder.textContent = 'Error rendering chart.';
                chartPlaceholder.style.display = 'flex';
            }
        }

        // ** ADDED: Function to display a test graph **
        function displayTestGraph() {
             console.log("Displaying Test Graph...");
             // Define sample data in the nested format
             const nowSec = Math.floor(Date.now() / 1000);
             const sampleTimestamp1 = nowSec - 36 * 3600; // ~36h ago
             const sampleTimestamp2 = nowSec - 12 * 3600; // ~12h ago
             const sampleTimestamp3 = nowSec - 1 * 3600;  // ~1h ago
             const testHistoryData = {
                 "Test Item Alpha": {
                     "buy": [
                         { "timestamp": sampleTimestamp1, "price": 140 },
                         { "timestamp": sampleTimestamp2, "price": 142 },
                         { "timestamp": sampleTimestamp3, "price": 150 }
                     ],
                     "ask": [
                         { "timestamp": sampleTimestamp1, "price": 155 },
                         { "timestamp": sampleTimestamp2, "price": 162 },
                         { "timestamp": sampleTimestamp3, "price": 160 }
                     ]
                 },
                 "Test Item Beta": {
                      "buy": [
                         { "timestamp": nowSec - 48 * 3600, "price": 2100 },
                         { "timestamp": nowSec - 24 * 3600, "price": 2050 },
                         { "timestamp": nowSec - 1 * 3600, "price": 2000 }
                     ],
                     "ask": [ // Sample with nulls
                         { "timestamp": nowSec - 48 * 3600, "price": 2200 },
                         { "timestamp": nowSec - 24 * 3600, "price": null },
                         { "timestamp": nowSec - 1 * 3600, "price": null }
                     ]
                 }
             };
             const testSummaryData = [
                 { name: "Test Item Alpha", category: "Test Cat A", buy: 150, ask: 160, vendor: 10, trend: 5.5 },
                 { name: "Test Item Beta", category: "Test Cat B", buy: 2000, ask: null, vendor: 500, trend: -2.1 }
             ];

             // Assign test data and render
             marketSummary = testSummaryData;
             allMarketData = testHistoryData;
             pinnedItems = getPinnedItems(); // Load pins even in test mode

             applyFiltersAndSort(); // Render table with test summary
             loadingMessageEl.style.display = 'none';
             tableWrapperEl.classList.remove('hidden');
             paginationEl.style.display = 'flex';

             // Display chart for the first test item
             displayChart("Test Item Alpha", null);
        }


        // --- Event Handlers (Original + Scale Toggle + Pinning) ---
        function handleProductClick(event) {
            // If the click target is the pin icon, let handlePinClick manage it
             if (event.target.classList.contains('pin-icon')) {
                 return;
             }
            // Otherwise, proceed with showing the chart
            const clickedLink = event.currentTarget; // This should be the link now
            const clickedTr = clickedLink.closest('tr'); // Get the parent TR
            if (!clickedTr) return; // Should not happen
            const productName = decodeURIComponent(clickedTr.dataset.product);
            displayChart(productName, clickedTr);
        }
        let searchTimeout;
        searchInput.addEventListener('input', (event) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = event.target.value;
                applyFiltersAndSort();
            }, 300);
        });
        categoryFilterEl.addEventListener('change', (event) => {
             currentCategoryFilter = event.target.value;
             applyFiltersAndSort();
        });
        sortOptionsEl.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON' && event.target.dataset.sort) {
                const newSort = event.target.dataset.sort;
                if (newSort === currentSort) {
                    if (currentSort === 'name_asc') currentSort = 'name_desc';
                    else if (currentSort === 'name_desc') currentSort = 'name_asc';
                    // Add toggles for other columns if desired, e.g., buy_desc -> buy_asc
                } else { currentSort = newSort; }
                sortOptionsEl.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('current-sort', btn.dataset.sort === currentSort);
                });
                applyFiltersAndSort();
            }
        });
        prevButton.addEventListener('click', () => {
            if (currentPage > 1) { currentPage--; renderCurrentPage(); }
        });
        nextButton.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredAndSortedSummary.length / itemsPerPage);
            if (currentPage < totalPages) { currentPage++; renderCurrentPage(); }
        });
        chartTimeControlsEl.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON' && event.target.dataset.range) {
                const newRange = event.target.dataset.range;
                if (newRange !== currentChartTimeRange) {
                    currentChartTimeRange = newRange;
                    chartTimeControlsEl.querySelectorAll('button').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.range === newRange);
                    });
                    if (currentChartProduct) {
                        displayChart(currentChartProduct, selectedTableRow); // Re-render chart
                    }
                }
            }
        });
        // Listener for the new scale toggle button
        if (scaleToggleButton) {
            scaleToggleButton.addEventListener('click', () => {
                currentYScaleType = (currentYScaleType === 'logarithmic') ? 'linear' : 'logarithmic';
                console.log(`Switched scale to: ${currentYScaleType}`);
                if (currentChartProduct) {
                    // Redraw the current chart with the new scale
                    displayChart(currentChartProduct, selectedTableRow);
                }
            });
        } else {
            console.error("Scale toggle button not found!");
        }
        // Listener for the test graph button
        if (showTestGraphBtn) {
             showTestGraphBtn.addEventListener('click', displayTestGraph);
        } else {
             console.error("Show Test Graph button not found!");
        }
        // Listener for the show live data button
        if (showLiveDataBtn) {
             showLiveDataBtn.addEventListener('click', loadData); // Re-call loadData
        } else {
             console.error("Show Live Data button not found!");
        }


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme(); // Initialize theme based on localStorage/preference
            loadData(); // Load data
        });

    </script>

</body>
</html>
