<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MWI Market Trends</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Professional Styling Overhaul --- */
        :root {
            --bg-color: #f6f8fa; /* Lighter, neutral background */
            --card-bg-color: #ffffff;
            --text-color-primary: #24292f; /* Darker primary text */
            --text-color-secondary: #57606a; /* Softer secondary text */
            --border-color: #d0d7de; /* GitHub-like border */
            --accent-color: #0969da; /* GitHub blue */
            --accent-hover-color: #0550ae;
            --positive-color: #1a7f37; /* GitHub green */
            --negative-color: #cf222e; /* GitHub red */
            --button-bg-color: #f6f8fa;
            --button-hover-bg-color: #f0f2f4;
            --button-border-color: rgba(27, 31, 36, 0.15);
            --button-hover-border-color: rgba(27, 31, 36, 0.35);
            --button-active-bg-color: #e9ecef;
            --shadow-color-light: rgba(140, 149, 159, 0.15);
            --shadow-color-medium: rgba(140, 149, 159, 0.2);
            --table-header-bg: #f6f8fa;
            --table-row-hover-bg: #f6f8fa;
            --table-row-selected-bg: #ddf4ff; /* Light blue selection */
            --link-color: var(--accent-color);
            --link-hover-color: var(--accent-hover-color);
            --code-font: SFMono-Regular, Consolas, "Liberation Mono", Menlo, Courier, monospace;
            --chart-grid-color: #d0d7de;
            --chart-tick-color: #57606a;
            --chart-title-color: #24292f;
            --pin-color: #6e7781;
            --pin-active-color: #ffab00; /* Yellow/Gold for pinned */
            --motd-bg-color: #ddf4ff; /* Use selection color */
            --motd-text-color: var(--accent-color);
            --motd-border-color: var(--accent-color);
        }

        [data-theme="dark"] {
            --bg-color: #0d1117; --card-bg-color: #161b22; --text-color-primary: #c9d1d9;
            --text-color-secondary: #8b949e; --border-color: #30363d; --accent-color: #58a6ff;
            --accent-hover-color: #79c0ff; --positive-color: #3fb950; --negative-color: #f85149;
            --button-bg-color: #21262d; --button-hover-bg-color: #30363d; --button-border-color: #30363d;
            --button-hover-border-color: #8b949e; --shadow-color-light: rgba(0, 0, 0, 0.2);
            --shadow-color-medium: rgba(0, 0, 0, 0.3); --table-header-bg: #161b22;
            --table-row-hover-bg: #21262d; --table-row-selected-bg: #1f6feb;
            --link-color: var(--accent-color); --link-hover-color: var(--accent-hover-color);
            --chart-grid-color: #21262d; --chart-tick-color: #8b949e; --chart-title-color: #c9d1d9;
            --pin-color: #8b949e; --pin-active-color: #f1e05a;
            --motd-bg-color: #1f6feb; /* Darker blue background */
            --motd-text-color: #c9d1d9; /* Lighter text */
            --motd-border-color: #58a6ff;
        }

        [data-theme="grey"] {
            --bg-color: #e1e4e8; --card-bg-color: #f6f8fa; --text-color-primary: #24292f;
            --text-color-secondary: #57606a; --border-color: #b1b8c0; --accent-color: #0366d6;
            --accent-hover-color: #005cc5; --positive-color: #1a7f37; --negative-color: #cf222e;
            --button-bg-color: #f6f8fa; --button-hover-bg-color: #e1e4e8; --button-border-color: #b1b8c0;
            --button-hover-border-color: #8c959f; --shadow-color-light: rgba(140, 149, 159, 0.15);
            --shadow-color-medium: rgba(140, 149, 159, 0.2); --table-header-bg: #f6f8fa;
            --table-row-hover-bg: #e1e4e8; --table-row-selected-bg: #ccebff;
            --link-color: var(--accent-color); --link-hover-color: var(--accent-hover-color);
            --chart-grid-color: #b1b8c0; --chart-tick-color: #57606a; --chart-title-color: #24292f;
            --pin-color: #6e7781; --pin-active-color: #f9a825;
            --motd-bg-color: #e9ecef;
            --motd-text-color: #0366d6;
            --motd-border-color: #adb5bd;
        }


        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color-primary);
            line-height: 1.5; font-size: 14px; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .container { max-width: 1600px; margin: 25px auto; padding: 0 25px; }
        h1 { text-align: center; color: var(--text-color-primary); margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600; font-size: 1.8em; letter-spacing: -0.5px; }
        .feedback-link-container { text-align: center; margin-bottom: 15px; font-size: 0.9em; } /* Reduced margin */
        .feedback-link-container a { color: var(--muted-text-color); text-decoration: none; border-bottom: 1px dashed var(--muted-text-color); transition: color 0.2s, border-color 0.2s; padding-bottom: 1px; }
        .feedback-link-container a:hover { color: var(--link-color); border-color: var(--link-color); }

        /* Message of the Day Styling */
        .motd {
            text-align: center;
            padding: 10px 15px;
            background-color: var(--motd-bg-color);
            color: var(--motd-text-color);
            border: 1px solid var(--motd-border-color);
            border-radius: 6px;
            margin-bottom: 30px; /* Space before controls */
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }

        /* Controls Area */
        .controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 16px 20px; margin-bottom: 30px; gap: 15px; background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 6px; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        .controls-left, .controls-right { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
        .search-form input[type="text"], .category-filter select { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; min-width: 200px; font-size: 0.95em; background-color: var(--card-bg-color); color: var(--text-color-primary); box-shadow: inset 0 1px 0 rgba(27,31,36,0.075); transition: border-color 0.1s ease-in-out, box-shadow 0.1s ease-in-out, background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
        .search-form input[type="text"]:focus, .category-filter select:focus { border-color: var(--accent-color); box-shadow: inset 0 1px 0 rgba(27,31,36,0.075), 0 0 0 3px rgba(9, 105, 218, 0.3); outline: none; }
        .sort-options span { font-weight: 600; color: var(--text-color-secondary); margin-right: 4px; font-size: 0.9em; }
        .sort-options button { padding: 5px 12px; background-color: var(--button-bg-color); color: var(--text-color-primary); border-radius: 6px; font-size: 0.9em; transition: background-color 0.1s ease-in-out, border-color 0.1s ease-in-out, color 0.2s ease-in-out; border: 1px solid var(--button-border-color); box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04); cursor: pointer; font-weight: 500; line-height: 20px; }
        .sort-options button:hover { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .sort-options button.current-sort { background-color: var(--accent-color); color: white; border-color: var(--accent-color); font-weight: 600; }

        /* Theme Switcher */
        .theme-switcher { display: flex; gap: 5px; }
        .theme-switcher button { font-size: 0.8em; padding: 4px 8px; }

        /* Layout for Table and Chart */
        .main-layout { display: flex; flex-wrap: wrap; gap: 25px; }
        .item-table-container { flex: 3; min-width: 550px; }
        .chart-display-container { flex: 2; min-width: 400px; }

        /* Item Table Styling */
        .table-wrapper { max-height: 78vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--card-bg-color); transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        #item-table { width: 100%; border-collapse: collapse; }
        #item-table th, #item-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; font-size: 0.95em; transition: border-color 0.2s ease-in-out; }
        #item-table th { background-color: var(--table-header-bg); font-weight: 600; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted-text-color); position: sticky; top: 0; z-index: 1; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
        #item-table tbody tr { transition: background-color 0.1s ease-in-out; }
        #item-table tbody tr:nth-child(even) { background-color: rgba(0,0,0,0.015); }
        [data-theme="dark"] #item-table tbody tr:nth-child(even) { background-color: rgba(255,255,255,0.03); }
        #item-table tbody tr:hover { background-color: var(--table-row-hover-bg); }
        #item-table tbody tr.selected-item { background-color: var(--table-row-selected-bg); font-weight: 500; }
        #item-table td:nth-child(1) { width: 30px; padding-right: 5px; } /* Pin column */
        #item-table td:nth-child(2) { font-weight: 500; cursor: pointer; color: var(--link-color); max-width: 220px; overflow: hidden; text-overflow: ellipsis; padding-left: 5px;} /* Product Name */
        #item-table td:nth-child(2):hover { text-decoration: underline; color: var(--link-hover-color); }
        #item-table td:nth-child(3) { font-size: 0.9em; color: var(--muted-text-color); max-width: 160px; overflow: hidden; text-overflow: ellipsis; } /* Category */
        #item-table td:nth-child(n+4) { text-align: right; font-family: var(--code-font); font-size: 0.95em; } /* Numeric columns */
        .trend-value-container { display: flex; align-items: center; justify-content: flex-end; gap: 3px; }
        .trend-icon { width: 14px; height: 14px; vertical-align: text-bottom; }
        .trend-positive { color: var(--positive-color); }
        .trend-negative { color: var(--negative-color); }
        .vendor-price { color: var(--text-color-secondary); }
        .na-value { color: #cdd4de; font-style: normal; }
        [data-theme="dark"] .na-value { color: #444c56; }

        /* Pin Button */
        .pin-button { background: none; border: none; padding: 2px 5px; cursor: pointer; opacity: 0.5; transition: opacity 0.2s, color 0.2s; color: var(--pin-color); vertical-align: middle; }
        .pin-button:hover { opacity: 1; }
        .pin-button.pinned { color: var(--pin-active-color); opacity: 1; }
        .pin-icon { width: 14px; height: 14px; fill: currentColor; }


        /* Chart Area Styling */
        .chart-display { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 20px; min-height: 450px; position: relative; display: flex; flex-direction: column; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        .chart-controls { text-align: center; margin-bottom: 15px; }
        .chart-controls button { margin: 0 4px; padding: 5px 10px; font-size: 0.85em; background-color: var(--button-bg-color); border: 1px solid var(--button-border-color); box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04); border-radius: 6px; cursor: pointer; transition: background-color 0.1s ease-in-out, border-color 0.1s ease-in-out; font-weight: 500;}
        .chart-controls button:hover { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .chart-controls button.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); font-weight: 600; }
        .chart-placeholder { text-align: center; color: #b0b8c2; padding: 60px; font-size: 1.05em; flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        .chart-plot { flex-grow: 1; position: relative; min-height: 320px; }
        .chart-plot canvas { max-width: 100%; max-height: 380px; }

        /* Pagination styling */
        .pagination { text-align: center; margin-top: 20px; padding-bottom: 20px; }
        .pagination button { margin: 0 3px; padding: 7px 14px; background-color: var(--button-bg-color); border: 1px solid var(--button-border-color); box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04); color: var(--accent-color); border-radius: 6px; transition: background-color 0.1s, border-color 0.1s; cursor: pointer; font-weight: 500; font-size: 0.9em; }
        .pagination button:hover:not(:disabled) { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .pagination button.current { background-color: var(--accent-color); color: white; border-color: var(--accent-color); font-weight: bold; cursor: default; }
        .pagination button:disabled { color: #8c959f; background-color: var(--button-bg-color); cursor: not-allowed; border-color: transparent; opacity: 0.6; }

        .loading-message, .error-message { text-align: center; padding: 40px; font-size: 1.1em; color: var(--muted-text-color); }
        .error-message { color: var(--negative-color); }

        /* Footer */
        footer { text-align: center; margin-top: 60px; padding: 25px 0; font-size: 0.85em; /* Slightly larger footer */ color: var(--muted-text-color); border-top: 1px solid var(--border-color); transition: border-color 0.2s ease-in-out; }
        footer span, footer a { margin: 0 10px; /* More spacing */ color: var(--muted-text-color); text-decoration: none; }
        footer a:hover { text-decoration: underline; color: var(--link-hover-color); }

    </style>
</head>
<body data-theme="light"> <div class="container">
        <h1>MWI Market Trends</h1>
        <div class="feedback-link-container">
            <a href="https://github.com/SporkSlinger/market-tracker-mwi/issues" target="_blank" rel="noopener noreferrer">Report an Issue or Suggest a Feature</a>
        </div>
        <div class="motd">
            Now with dark mode
        </div>

        <div class="controls">
            <div class="controls-left">
                 <div class="search-form">
                    <input type="text" id="search-input" placeholder="Search Product Name...">
                </div>
                <div class="category-filter">
                     <select id="category-filter">
                         <option value="All">All Categories</option>
                         {% for category in categories %}
                         <option value="{{ category }}">{{ category }}</option>
                         {% endfor %}
                     </select>
                </div>
            </div>
            <div class="controls-right">
                <div class="sort-options" id="sort-options">
                    <span>Sort By:</span>
                    <button data-sort="name_asc" class="current-sort">Name</button>
                    <button data-sort="category_asc">Category</button>
                    <button data-sort="buy_desc">Buy</button>
                    <button data-sort="ask_asc">Ask</button>
                    <button data-sort="vendor_desc">Vendor</button>
                    <button data-sort="trend_dec">Trend %</button>
                </div>
                 <div class="theme-switcher" id="theme-switcher">
                    <button data-theme="light" title="Light Mode">‚òÄÔ∏è</button>
                    <button data-theme="grey" title="Grey Mode">‚ö™</button>
                    <button data-theme="dark" title="Dark Mode">üåô</button>
                </div>
            </div>
        </div>

        <div class="main-layout">
            <div class="item-table-container">
                <div id="loading-message" class="loading-message">Loading market data...</div>
                <div id="error-message" class="error-message" style="display: none;"></div>
                <div class="table-wrapper" style="display: none;">
                    <table id="item-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;">Pin</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Buy</th>
                                <th>Ask</th>
                                <th>Vendor</th>
                                <th>Trend (24h)</th>
                            </tr>
                        </thead>
                        <tbody id="item-table-body"></tbody>
                    </table>
                </div>
                <div class="pagination" id="pagination" style="display: none;">
                    <button id="prev-page" disabled>&laquo; Previous</button>
                    <span id="page-info">Page 1 of 1</span>
                    <button id="next-page" disabled>Next &raquo;</button>
                </div>
            </div>

            <div class="chart-display-container">
                <div class="chart-display" id="chart-display">
                     <div class="chart-controls" id="chart-time-controls" style="display: none;">
                         <button data-range="24h">24h</button>
                         <button data-range="48h">48h</button>
                         <button data-range="7d">7d</button>
                         <button data-range="30d" class="active">30d</button>
                     </div>
                    <div class="chart-placeholder" id="chart-placeholder">Select an item name from the table to view its chart.</div>
                    <div class="chart-plot" style="display: none;">
                        <canvas id="single-chart-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <footer>
        <span>Made by Sporky with AI</span> |
        <span class="status">Data Generated: <span id="last-update">{{ last_update }}</span></span> |
        <a href="https://github.com/SporkSlinger/market-tracker-mwi" target="_blank" rel="noopener noreferrer">GitHub Repo</a>
        </footer>

    <script>
        // --- Global State ---
        let allMarketData = []; let marketSummary = []; let filteredAndSortedSummary = [];
        let currentChart = null; let currentPage = 1; const itemsPerPage = 20;
        let currentSort = 'name_asc'; let currentSearch = ''; let currentCategoryFilter = 'All';
        let selectedTableRow = null; let currentChartProduct = null; let currentChartTimeRange = '30d';
        let currentTheme = 'light'; let pinnedItems = [];

        // --- DOM Elements ---
        const tableBodyEl = document.getElementById('item-table-body');
        const tableWrapperEl = document.querySelector('.table-wrapper');
        const paginationEl = document.getElementById('pagination');
        const pageInfoEl = document.getElementById('page-info');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        const searchInput = document.getElementById('search-input');
        const categoryFilterEl = document.getElementById('category-filter');
        const sortOptionsEl = document.getElementById('sort-options');
        const chartCanvas = document.getElementById('single-chart-canvas');
        const chartPlotContainer = document.querySelector('.chart-plot');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const chartTimeControlsEl = document.getElementById('chart-time-controls');
        const themeSwitcherEl = document.getElementById('theme-switcher');
        const loadingMessageEl = document.getElementById('loading-message');
        const errorMessageEl = document.getElementById('error-message');

        // --- SVG Icons ---
        const trendUpIcon = `<svg class="trend-icon" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true"><path fill="currentColor" d="M8.707 2.293a1 1 0 0 0-1.414 0l-4 4a1 1 0 1 0 1.414 1.414L8 4.414l3.293 3.293a1 1 0 0 0 1.414-1.414l-4-4Z"></path></svg>`;
        const trendDownIcon = `<svg class="trend-icon" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true"><path fill="currentColor" d="M7.293 13.707a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0-1.414-1.414L8 11.586 4.707 8.293a1 1 0 0 0-1.414 1.414l4 4Z"></path></svg>`;
        const pinIconEmpty = `<svg class="pin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Zm0 2.445L6.615 5.506l-2.867.417 2.074 2.021L5.28 10.82l2.72-1.431 2.72 1.432-.543-2.878 2.074-2.02-2.868-.417L8 2.695Z"/></svg>`;
        const pinIconFilled = `<svg class="pin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"/></svg>`;

        // --- Utility Functions ---
        function formatPrice(price) { if (price === null || price === undefined || isNaN(price)) return '<span class="na-value">--</span>'; return price.toLocaleString(); }
        function formatTrend(trend) { if (trend === null || trend === undefined || isNaN(trend)) return '<span class="na-value">--</span>'; const arrow = trend > 0 ? trendUpIcon : trend < 0 ? trendDownIcon : ''; const trendClass = trend > 0 ? 'trend-positive' : trend < 0 ? 'trend-negative' : ''; return `<span class="trend-value-container ${trendClass}">${arrow}<span>${trend.toFixed(2)}%</span></span>`; }

        // --- Theme Handling ---
        function applyTheme(theme) { document.body.dataset.theme = theme; currentTheme = theme; themeSwitcherEl.querySelectorAll('button').forEach(btn => { btn.classList.toggle('current-sort', btn.dataset.theme === theme); }); if (currentChart) { updateChartTheme(); } }
        function loadTheme() { const savedTheme = localStorage.getItem('marketTrackerTheme'); const preferredTheme = savedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); applyTheme(preferredTheme); }
        function saveTheme(theme) { localStorage.setItem('marketTrackerTheme', theme); applyTheme(theme); }

        // --- Pinned Items Handling ---
        function loadPinnedItems() { const savedPins = localStorage.getItem('marketTrackerPinnedItems'); pinnedItems = savedPins ? JSON.parse(savedPins) : []; }
        function savePinnedItems() { localStorage.setItem('marketTrackerPinnedItems', JSON.stringify(pinnedItems)); }
        function isPinned(productName) { return pinnedItems.includes(productName); }
        function togglePin(productName) { if (isPinned(productName)) { pinnedItems = pinnedItems.filter(p => p !== productName); } else { pinnedItems.push(productName); } savePinnedItems(); applyFiltersAndSort(); }

        // --- Data Fetching ---
        async function loadData() { /* ... unchanged ... */ }

        // --- Filtering and Sorting (with Pinning) ---
        function applyFiltersAndSort() { /* ... unchanged ... */ }

        // --- Rendering ---
        function renderCurrentPage() { /* ... updated to include pin button/state ... */
            tableBodyEl.innerHTML = ''; selectedTableRow = null;
            const totalItems = filteredAndSortedSummary.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            currentPage = Math.max(1, Math.min(currentPage, totalPages || 1));
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const itemsToDisplay = filteredAndSortedSummary.slice(startIndex, endIndex);
            if (itemsToDisplay.length === 0) {
                 const message = currentSearch || currentCategoryFilter !== 'All' ? 'No items match filters.' : 'No data.';
                 const tr = document.createElement('tr'); const td = document.createElement('td');
                 td.colSpan = 7; td.textContent = message; td.style.textAlign = 'center';
                 td.style.padding = '20px'; td.style.color = 'var(--muted-text-color)';
                 tr.appendChild(td); tableBodyEl.appendChild(tr);
            } else {
                itemsToDisplay.forEach(item => {
                    const tr = document.createElement('tr'); const productName = item.name;
                    const isCurrentlyPinned = isPinned(productName);
                    tr.dataset.product = encodeURIComponent(productName); tr.style.cursor = 'pointer';
                    tr.innerHTML = `
                        <td><button class="pin-button ${isCurrentlyPinned ? 'pinned' : ''}" data-pin-product="${encodeURIComponent(productName)}" title="${isCurrentlyPinned ? 'Unpin' : 'Pin'}">${isCurrentlyPinned ? pinIconFilled : pinIconEmpty}</button></td>
                        <td><a>${productName}</a></td>
                        <td>${item.category || '<span class="na-value">N/A</span>'}</td>
                        <td>${formatPrice(item.buy)}</td>
                        <td>${formatPrice(item.ask)}</td>
                        <td><span class="vendor-price">${formatPrice(item.vendor)}</span></td>
                        <td>${formatTrend(item.trend)}</td>
                    `;
                    tr.querySelector('td:nth-child(2)').addEventListener('click', handleProductClick); // Listener on name cell
                    tr.querySelector('.pin-button').addEventListener('click', handlePinClick);
                    tableBodyEl.appendChild(tr);
                });
            }
            renderPagination(totalPages);
        }
        function renderPagination(totalPages) { /* ... unchanged ... */ }

        // --- Chart Theming ---
        function getChartColors(theme) { /* ... unchanged ... */ }
        function updateChartTheme() { /* ... unchanged ... */ }

        // --- Charting ---
        function displayChart(productName, clickedTrElement) { /* ... unchanged ... */ }

        // --- Event Handlers ---
        function handleProductClick(event) { /* ... updated to get TR from name cell parent */
            const clickedCell = event.currentTarget;
            const clickedTr = clickedCell.closest('tr');
            const productName = decodeURIComponent(clickedTr.dataset.product);
            displayChart(productName, clickedTr);
        }
        function handlePinClick(event) { /* ... unchanged ... */ }
        // ... other handlers unchanged ...

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme(); loadData(); // Load theme before data
        });
    </script>

</body>
</html>
```
