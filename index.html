<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MWI Market Trends & Enhancer Sim (Refactored v2 - SRI Fix)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.2/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js" integrity="sha512-Hn1w6YiiFw6p6S2lXv6yKeqTk0PLVzeCwWY9n32beuPjQ5HLcvz5l2QsP+KilEr1ws37rCTw3bZpvfvVIeTh0Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            /* Light Theme Definitions */
            --bg-color: #f6f8fa;
            --card-bg-color: #ffffff;
            --text-color-primary: #24292f;
            --text-color-secondary: #57606a;
            --muted-text-color: #57606a;
            --border-color: #d0d7de;
            --accent-color: #0969da;
            --accent-hover-color: #0550ae;
            --positive-color: #1a7f37;
            --negative-color: #cf222e;
            --button-bg-color: #f6f8fa;
            --button-hover-bg-color: #f0f2f4;
            --button-border-color: rgba(27, 31, 36, 0.15);
            --button-hover-border-color: rgba(27, 31, 36, 0.35);
            --button-active-bg-color: var(--accent-color);
            --button-active-text-color: #ffffff;
            --button-active-border-color: var(--accent-color);
            --input-bg-color: var(--card-bg-color);
            --input-border-color: var(--border-color);
            --input-focus-border-color: var(--accent-color);
            --input-focus-shadow-color: rgba(9, 105, 218, 0.3);
            --table-header-bg: #f6f8fa;
            --table-row-even-bg: #fbfcfd;
            --table-row-hover-bg: #f6f8fa;
            --table-row-selected-bg: #ddf4ff;
            --link-color: var(--accent-color);
            --link-hover-color: var(--accent-hover-color);
            --code-font: SFMono-Regular, Consolas, "Liberation Mono", Menlo, Courier, monospace;
            --na-value-color: #cdd4de;
            --vendor-price-color: var(--text-color-secondary);
            --chart-placeholder-color: #b0b8c2;
            /* Chart element colors are hardcoded in JS options */
            --pin-color: #d0d7de; /* Color for unpinned star */
            --pin-color-active: #ffab00; /* Color for pinned star (gold) */
            --calc-border-color: #e1e4e8; /* Specific border for calc sections */
            --simulated-cost-color: #57606a; /* Color for simulated cost text */
            --error-display-bg: #ffebe9;
            --error-display-border: var(--negative-color);
            --error-display-text: var(--negative-color);
        }

        html[data-theme="dark"] {
             /* Dark Theme Overrides */
            --bg-color: #0d1117;
            --card-bg-color: #161b22;
            --text-color-primary: #c9d1d9;
            --text-color-secondary: #8b949e;
            --muted-text-color: #8b949e;
            --border-color: #30363d;
            --accent-color: #58a6ff;
            --accent-hover-color: #79c0ff;
            --positive-color: #3fb950;
            --negative-color: #f85149;
            --button-bg-color: #21262d;
            --button-hover-bg-color: #30363d;
            --button-border-color: #30363d;
            --button-hover-border-color: #8b949e;
            --button-active-bg-color: var(--accent-color);
            --button-active-text-color: #ffffff;
            --button-active-border-color: var(--accent-color);
            --input-bg-color: var(--card-bg-color);
            --input-border-color: var(--border-color);
            --input-focus-border-color: var(--accent-color);
            --input-focus-shadow-color: rgba(88, 166, 255, 0.3);
            --table-header-bg: #161b22;
            --table-row-even-bg: #1a1f27;
            --table-row-hover-bg: #21262d;
            --table-row-selected-bg: #1f6feb;
            --link-color: var(--accent-color);
            --link-hover-color: var(--accent-hover-color);
            --na-value-color: #484f58;
            --vendor-price-color: var(--text-color-secondary);
            --chart-placeholder-color: #6e7681;
            /* Chart element colors are hardcoded in JS options */
            --pin-color: #484f58; /* Dark mode unpinned star */
            --pin-color-active: #f1e05a; /* Dark mode pinned star (lighter gold) */
            --calc-border-color: #30363d;
            --simulated-cost-color: #8b949e; /* Dark mode simulated cost text */
            --error-display-bg: #2d1f1f;
            --error-display-border: var(--negative-color);
            --error-display-text: #ffacac;
        }

        /* --- General Styles (Using Variables) --- */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif; margin: 0; padding: 0;
            background-color: var(--bg-color); color: var(--text-color-primary);
            line-height: 1.5; font-size: 14px;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .container { max-width: 1600px; margin: 25px auto; padding: 0 25px; }
        h1 { text-align: center; color: var(--text-color-primary); margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600; font-size: 1.8em; letter-spacing: -0.5px; }
        h2 { text-align: center; color: var(--text-color-secondary); margin-top: 1rem; margin-bottom: 1.5rem; font-weight: 500; font-size: 1.3em; }
        h3 { font-size: 1.1em; font-weight: 600; margin-bottom: 0; /* Adjusted margin */ color: var(--text-color-primary); padding-bottom: 0;} /* Adjusted padding */

        /* Container for the buttons under title */
        .title-button-container {
            text-align: center; margin-bottom: 25px; display: flex;
            justify-content: center; gap: 10px; flex-wrap: wrap;
        }
        /* Style for the theme toggle button */
        #theme-toggle-btn {
            padding: 6px 16px; font-size: 0.9em; font-weight: 500;
            background-color: var(--button-bg-color); color: var(--text-color-primary);
            border: 1px solid var(--button-border-color); border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
            display: inline-flex; align-items: center; gap: 6px;
        }
        #theme-toggle-btn:hover { background-color: var(--button-hover-bg-color); }
        /* Icon visibility styles */
        #theme-toggle-btn .fa-sun { display: none; }
        #theme-toggle-btn .fa-moon { display: inline-block; }
        html[data-theme="dark"] #theme-toggle-btn .fa-sun { display: inline-block; }
        html[data-theme="dark"] #theme-toggle-btn .fa-moon { display: none; }


        .feedback-link-container { text-align: center; margin-bottom: 25px; font-size: 0.9em; }
        .feedback-link-container a { color: var(--muted-text-color); text-decoration: none; border-bottom: 1px dashed var(--muted-text-color); transition: color 0.2s, border-color 0.2s; padding-bottom: 1px; }
        .feedback-link-container a:hover { color: var(--link-color); border-color: var(--link-color); }
        .controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 16px 20px; margin-bottom: 20px; gap: 15px; background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 6px; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;}
        .controls-left, .controls-right { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
        /* Explicit label styling */
        label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: var(--text-color-secondary); }
        input[type="text"], input[type="number"], select {
            display: block; width: 100%; padding: 0.5rem 0.75rem; font-size: 0.875rem;
            line-height: 1.5; color: var(--text-color-primary); background-color: var(--input-bg-color);
            background-clip: padding-box; border: 1px solid var(--input-border-color);
            appearance: none; border-radius: 0.375rem;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out, background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            color: var(--text-color-primary); background-color: var(--input-bg-color);
            border-color: var(--input-focus-border-color); outline: 0;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.075), 0 0 0 0.25rem var(--input-focus-shadow-color);
        }
        input[type="checkbox"] { border-radius: 0.25rem; border-color: var(--input-border-color); margin-right: 0.3rem; vertical-align: middle; cursor: pointer;}
        .checkbox-label { display: inline-flex; align-items: center; font-weight: normal; color: var(--text-color-primary); font-size: 0.9em; cursor: pointer; } /* Style for checkbox labels */

        .sort-options span { font-weight: 600; color: var(--text-color-secondary); margin-right: 4px; font-size: 0.9em; }
        .sort-options button { padding: 5px 12px; background-color: var(--button-bg-color); color: var(--text-color-primary); border-radius: 6px; font-size: 0.9em; transition: background-color 0.1s ease-in-out, border-color 0.1s ease-in-out; border: 1px solid var(--button-border-color); box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04); cursor: pointer; font-weight: 500; line-height: 20px; }
        .sort-options button:hover { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .sort-options button.current-sort { background-color: var(--button-active-bg-color); color: var(--button-active-text-color); border-color: var(--button-active-border-color); font-weight: 600; }

        /* Simulation Settings Section */
        .simulation-settings {
            background-color: var(--card-bg-color); border: 1px solid var(--border-color);
            border-radius: 6px; padding: 16px 20px; margin-bottom: 30px;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .sim-settings-header {
            display: flex; flex-wrap: wrap; /* Allow wrapping on small screens */
            align-items: center; gap: 15px; /* Spacing between elements */
            margin-bottom: 1rem;
            padding-bottom: 0.8rem; border-bottom: 1px solid var(--border-color);
        }
        .sim-settings-header h3 { border-bottom: none; margin-bottom: 0; padding-bottom: 0; flex-grow: 1; /* Allow title to take space */ min-width: 200px; /* Prevent excessive shrinking */}
        #toggle-sim-details-btn {
             padding: 4px 10px; font-size: 0.85em; margin-left: auto; /* Push button to the right */
             /* Use standard button styles */
             background-color: var(--button-bg-color); color: var(--text-color-primary);
             border: 1px solid var(--button-border-color); border-radius: 6px; cursor: pointer;
             transition: background-color 0.15s ease, border-color 0.15s ease;
        }
        #toggle-sim-details-btn:hover { background-color: var(--button-hover-bg-color); }
        .sim-controls-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px 20px; /* Row and column gap */
            transition: opacity 0.2s ease-in-out; /* Transition for dimming */
            margin-top: 1rem; /* Add space below header */
        }
        /* Class added by JS to hide the grid */
        .sim-controls-grid.hidden-by-default {
             display: none;
        }
        /* Style for dimming controls when custom settings are off AND grid is visible */
        .simulation-settings:not(.custom-settings-active) .sim-controls-grid:not(.hidden-by-default) {
            opacity: 0.5;
            pointer-events: none; /* Disable interaction with dimmed controls */
        }
        .simulation-settings:not(.custom-settings-active) .sim-controls-grid:not(.hidden-by-default) input,
        .simulation-settings:not(.custom-settings-active) .sim-controls-grid:not(.hidden-by-default) select,
        .simulation-settings:not(.custom-settings-active) .sim-controls-grid:not(.hidden-by-default) .checkbox-label {
             cursor: not-allowed;
        }

        .sim-control-group label { margin-bottom: 0.3rem; }
        .sim-control-group input[type="number"], .sim-control-group select {
            width: 100%; /* Make inputs fill grid cell */
            max-width: 200px; /* Optional max width */
        }
        .sim-control-group--checkbox { grid-column: span 1; /* Allow checkboxes to take less space if needed */ display: flex; align-items: center; padding-top: 1.5rem; /* Align with input tops */}

        /* Simulation Error Display */
        #simulation-error-display {
            background-color: var(--error-display-bg);
            border: 1px solid var(--error-display-border);
            color: var(--error-display-text);
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .main-layout { display: flex; flex-wrap: wrap; gap: 25px; }
        .item-table-container { flex: 3; min-width: 550px; }
        .chart-display-container { flex: 2; min-width: 400px; }
        .table-wrapper { max-height: 70vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--card-bg-color); transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;}
        #item-table { width: 100%; border-collapse: collapse; }
        #item-table th, #item-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; font-size: 0.95em; }
        #item-table th { background-color: var(--table-header-bg); font-weight: 600; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted-text-color); position: sticky; top: 0; z-index: 1; transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; cursor: pointer; } /* Added cursor pointer for sort */
        #item-table th .sort-indicator { margin-left: 5px; font-size: 0.9em; color: var(--muted-text-color); display: inline-block; width: 1em; text-align: center;} /* For sort arrows */
        #item-table th.pin-header { width: 40px; text-align: center; padding: 10px 5px; cursor: default;} /* No sorting on pin header */
        #item-table td.pin-cell { text-align: center; padding: 10px 5px;}
        .pin-icon { cursor: pointer; color: var(--pin-color); font-size: 1.1em; transition: color 0.15s ease-in-out; }
        .pin-icon.pinned { color: var(--pin-color-active); }
        .pin-icon:hover { opacity: 0.7; }
        /* Styles for Enhancer Level Controls in Table */
        .enh-level-control { display: inline-flex; align-items: center; gap: 4px; white-space: nowrap; margin-left: 8px; vertical-align: middle;}
        .enh-level-btn { padding: 1px 4px; font-size: 0.8em; line-height: 1; cursor: pointer; border: 1px solid var(--button-border-color); background-color: var(--button-bg-color); border-radius: 4px; color: var(--text-color-secondary); }
        .enh-level-btn:hover:not(:disabled) { background-color: var(--button-hover-bg-color); }
        .enh-level-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .enh-level-display { font-size: 0.9em; min-width: 2.5em; text-align: center; font-family: var(--code-font); color: var(--text-color-secondary); padding: 0 2px; }


        #item-table tbody tr { transition: background-color 0.15s ease; }
        #item-table tbody tr:nth-child(even) { background-color: var(--table-row-even-bg); }
        #item-table tbody tr:hover { background-color: var(--table-row-hover-bg); }
        #item-table tbody tr.selected-item { background-color: var(--table-row-selected-bg); font-weight: 500; }
        #item-table td { color: var(--text-color-primary); }
        #item-table td.col-name { font-weight: 500; /* Name */ }
        #item-table td.col-name .item-name-link { color: var(--link-color); cursor: pointer; text-decoration: none; }
        #item-table td.col-name .item-name-link:hover { text-decoration: underline; color: var(--link-hover-color); }
        #item-table td.col-category { font-size: 0.9em; color: var(--muted-text-color); max-width: 160px; overflow: hidden; text-overflow: ellipsis; } /* Category */
        #item-table td.col-ask,
        #item-table td.col-buy,
        #item-table td.col-vendor,
        #item-table td.col-trend { text-align: right; font-family: var(--code-font); font-size: 0.95em; } /* Numeric/Trend columns */

        /* Simulated Cost Style */
        .simulated-cost { font-style: italic; opacity: 0.8; color: var(--simulated-cost-color); }


        .trend-value-container { display: flex; align-items: center; justify-content: flex-end; gap: 3px; }
        .trend-icon { width: 14px; height: 14px; vertical-align: text-bottom; }
        .trend-positive { color: var(--positive-color); }
        .trend-negative { color: var(--negative-color); }
        .vendor-price { color: var(--vendor-price-color); }
        .na-value { color: var(--na-value-color); font-style: normal; }
        .chart-display { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 20px; min-height: 450px; position: relative; display: flex; flex-direction: column; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;}

        .chart-controls-container { /* Container for all chart controls */
             display: flex;
             justify-content: center; /* Center inner divs */
             align-items: center;
             flex-wrap: wrap; /* Allow wrapping */
             gap: 15px; /* Space between control groups */
             margin-bottom: 15px;
        }
        .chart-controls { text-align: center; } /* Original class for time */
        .scale-controls { text-align: center; } /* New class for scale toggle */

        .chart-controls button, .scale-controls button { margin: 0 4px; padding: 5px 10px; font-size: 0.85em; background-color: var(--button-bg-color); border: 1px solid var(--button-border-color); box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04); border-radius: 6px; cursor: pointer; transition: background-color 0.1s ease-in-out, border-color 0.1s ease-in-out; font-weight: 500; color: var(--text-color-primary);}
        .chart-controls button:hover, .scale-controls button:hover { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .chart-controls button.active, .scale-controls button.active { background-color: var(--button-active-bg-color); color: var(--button-active-text-color); border-color: var(--button-active-border-color); font-weight: 600; }

        .chart-placeholder { text-align: center; color: var(--chart-placeholder-color); padding: 60px; font-size: 1.05em; flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        .chart-plot { flex-grow: 1; position: relative; min-height: 320px; }
        .chart-plot canvas { max-width: 100%; max-height: 380px; }
        .pagination { text-align: center; margin-top: 20px; padding-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 10px;} /* Use flex for better alignment */
        .pagination button { margin: 0 3px; padding: 7px 14px; background-color: var(--button-bg-color); border: 1px solid var(--button-border-color); box-shadow: 0 1px 0 rgba(27, 31, 36, 0.04); color: var(--accent-color); border-radius: 6px; transition: background-color 0.1s, border-color 0.1s; cursor: pointer; font-weight: 500; font-size: 0.9em; }
        .pagination button:hover:not(:disabled) { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .pagination button.current { background-color: var(--button-active-bg-color); color: var(--button-active-text-color); border-color: var(--button-active-border-color); font-weight: bold; cursor: default; }
        .pagination button:disabled { color: var(--muted-text-color); background-color: var(--button-bg-color); opacity: 0.6; cursor: not-allowed; border-color: transparent; }
        .loading-message, .error-message { text-align: center; padding: 40px; font-size: 1.1em; color: var(--muted-text-color); }
        .error-message { color: var(--negative-color); }
        .hidden { display: none; }
        footer { text-align: center; margin-top: 60px; padding: 25px 0; font-size: 0.8em; color: var(--muted-text-color); border-top: 1px solid var(--border-color); transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;}
        footer span, footer a { margin: 0 8px; color: var(--muted-text-color); text-decoration: none; }
        footer a:hover { text-decoration: underline; color: var(--link-hover-color); }

         @media (max-width: 992px) { /* Adjusted breakpoint for sim settings */
            .sim-controls-grid { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); } /* Adjust grid for smaller screens */
         }

         @media (max-width: 768px) {
             .controls { flex-direction: column; align-items: stretch; }
             .controls-left, .controls-right { width: 100%; justify-content: center; }
             .search-form input[type="text"], .category-filter select { width: 100%; min-width: unset; } /* Adjusted for label */
             .search-form, .category-filter { width: 100%; } /* Ensure controls take full width */
             .main-layout { flex-direction: column; }
             .item-table-container, .chart-display-container { min-width: unset; }
             .table-wrapper { max-height: 60vh; }
             h1 { font-size: 1.5em; }
             .chart-controls-container { flex-direction: column; gap: 10px; }
             .sim-controls-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px 15px; }
             .sim-control-group--checkbox { padding-top: 0.5rem; }
             .sim-settings-header { flex-direction: column; align-items: flex-start; gap: 10px; } /* Stack header items */
             #toggle-sim-details-btn { margin-left: 0; /* Align left on small screens */ }
         }

    </style>
</head>
<body>

    <div class="container">
        <h1>MWI Market Trends</h1>
        <div class="title-button-container" >
             <button id="theme-toggle-btn" title="Toggle Theme">
                 <i class="fas fa-moon"></i><i class="fas fa-sun"></i>
                 <span class="toggle-text" style="margin-left: 6px;">Toggle Theme</span>
             </button>
        </div>
        <div class="feedback-link-container">
            <a href="https://github.com/SporkSlinger/market-tracker-mwi/issues" target="_blank" rel="noopener noreferrer">Report an Issue or Suggest a Feature</a>
        </div>

        <div class="controls">
            <div class="controls-left">
                 <div class="search-form">
                     <label for="search-input">Search</label>
                     <input type="text" id="search-input" placeholder="Product Name...">
                 </div>
                 <div class="category-filter">
                      <label for="category-filter">Category</label>
                      <select id="category-filter">
                          <option value="All">All Categories</option>
                          
                          <option value="Books">Books</option>
                          
                          <option value="Consumables">Consumables</option>
                          
                          <option value="Currencies">Currencies</option>
                          
                          <option value="Equipment / Back">Equipment / Back</option>
                          
                          <option value="Equipment / Body">Equipment / Body</option>
                          
                          <option value="Equipment / Feet">Equipment / Feet</option>
                          
                          <option value="Equipment / Hands">Equipment / Hands</option>
                          
                          <option value="Equipment / Head">Equipment / Head</option>
                          
                          <option value="Equipment / Legs">Equipment / Legs</option>
                          
                          <option value="Equipment / Main Hand">Equipment / Main Hand</option>
                          
                          <option value="Equipment / Off Hand">Equipment / Off Hand</option>
                          
                          <option value="Equipment / Pouch">Equipment / Pouch</option>
                          
                          <option value="Jewelry">Jewelry</option>
                          
                          <option value="Keys">Keys</option>
                          
                          <option value="Loots">Loots</option>
                          
                          <option value="Resources">Resources</option>
                          
                          <option value="Tools / Alchemy">Tools / Alchemy</option>
                          
                          <option value="Tools / Brewing">Tools / Brewing</option>
                          
                          <option value="Tools / Cheesesmithing">Tools / Cheesesmithing</option>
                          
                          <option value="Tools / Cooking">Tools / Cooking</option>
                          
                          <option value="Tools / Crafting">Tools / Crafting</option>
                          
                          <option value="Tools / Enhancing">Tools / Enhancing</option>
                          
                          <option value="Tools / Foraging">Tools / Foraging</option>
                          
                          <option value="Tools / Milking">Tools / Milking</option>
                          
                          <option value="Tools / Tailoring">Tools / Tailoring</option>
                          
                          <option value="Tools / Woodcutting">Tools / Woodcutting</option>
                          
                          <option value="Trinket">Trinket</option>
                          
                      </select>
                 </div>
            </div>
            <div class="controls-right">
                 <div class="sort-options" id="sort-options">
                     <span>Sort By:</span>
                     <button data-sort="name_asc" class="current-sort">Name</button>
                     <button data-sort="category_asc">Category</button>
                     <button data-sort="ask_asc">Ask</button>
                     <button data-sort="buy_desc">Buy</button>
                     <button data-sort="vendor_desc">Vendor</button>
                     <button data-sort="trend_dec">Trend %</button>
                 </div>
            </div>
        </div>

        <div class="simulation-settings"> <div class="sim-settings-header">
                 <h3>Enhancement Simulation Settings</h3>
                 <div class="sim-control-group--checkbox"> <input type="checkbox" id="use-custom-sim-settings" checked>
                    <label for="use-custom-sim-settings" class="checkbox-label">Use Custom Settings</label>
                 </div>
                 <button id="toggle-sim-details-btn" aria-expanded="false">Show Details</button> </div>
            <div class="sim-controls-grid hidden-by-default"> <div class="sim-control-group">
                    <label for="sim-enhancing-level">Enhancing Level</label>
                    <input type="number" id="sim-enhancing-level" min="0" step="1" value="100">
                </div>
                <div class="sim-control-group">
                    <label for="sim-observatory-level">Observatory Level</label>
                    <input type="number" id="sim-observatory-level" min="0" max="4" step="1" value="4">
                </div>
                <div class="sim-control-group">
                    <label for="sim-enhancer-level">Enhancer Potion</label>
                    <select id="sim-enhancer-level">
                        <option value="0">None</option>
                        <option value="1">Tier 1</option>
                        <option value="2">Tier 2</option>
                        <option value="3">Tier 3</option>
                        <option value="4">Tier 4</option>
                        <option value="5">Tier 5</option>
                        <option value="6">Tier 6</option>
                        <option value="7">Tier 7</option>
                        <option value="8">Tier 8</option>
                        <option value="9">Tier 9</option>
                        <option value="10" selected>Tier 10</option>
                        </select>
                </div>
                <div class="sim-control-group">
                    <label for="sim-ask-bid-ratio">Price Basis (1=Ask, 0=Bid)</label>
                    <input type="number" id="sim-ask-bid-ratio" min="0" max="1" step="0.1" value="1.0">
                </div>
                 <div class="sim-control-group--checkbox">
                    <input type="checkbox" id="sim-tea-blessed" checked>
                    <label for="sim-tea-blessed" class="checkbox-label">Blessed Tea</label>
                </div>
                 <div class="sim-control-group--checkbox">
                    <input type="checkbox" id="sim-tea-ultra" checked>
                    <label for="sim-tea-ultra" class="checkbox-label">Ultra Enh. Tea</label>
                </div>
                 </div>
            <div id="simulation-error-display" class="hidden"></div>
        </div>


        <div class="main-layout">
            <div class="item-table-container">
                <div id="loading-message" class="loading-message">Loading market data...</div>
                <div id="error-message" class="error-message hidden"></div> <div class="table-wrapper hidden">
                    <table id="item-table">
                        <thead>
                            <tr>
                                <th scope="col" class="pin-header"><i class="fas fa-thumbtack" title="Pinned Status"></i></th>
                                <th scope="col" data-sort-key="name" aria-sort="ascending">Name <span class="sort-indicator">â–²</span></th>
                                <th scope="col" data-sort-key="category" aria-sort="none">Category <span class="sort-indicator"></span></th>
                                <th scope="col" data-sort-key="ask" aria-sort="none">Ask <span class="sort-indicator"></span></th>
                                <th scope="col" data-sort-key="buy" aria-sort="none">Buy <span class="sort-indicator"></span></th>
                                <th scope="col" data-sort-key="vendor" aria-sort="none">Vendor <span class="sort-indicator"></span></th>
                                <th scope="col" data-sort-key="trend" aria-sort="none">Trend (24h) <span class="sort-indicator"></span></th>
                            </tr>
                        </thead>
                        <tbody id="item-table-body">
                            </tbody>
                    </table>
                </div>
                <div class="pagination" id="pagination" style="display: none;">
                    <button id="prev-page" disabled>&laquo; Previous</button>
                    <span id="page-info">Page 1 of 1</span>
                    <button id="next-page" disabled>Next &raquo;</button>
                </div>
            </div>

            <div class="chart-display-container">
                <div class="chart-display" id="chart-display">
                     <div class="chart-controls-container" id="chart-controls-area" style="display: none;">
                          <div class="chart-controls" id="chart-time-controls">
                              <button data-range="24h">24h</button>
                              <button data-range="48h">48h</button>
                              <button data-range="7d">7d</button>
                              <button data-range="30d" class="active">30d</button>
                          </div>
                           <div class="scale-controls">
                              <button id="scale-toggle-btn">Switch to Linear Scale</button>
                          </div>
                     </div>
                    <div class="chart-placeholder" id="chart-placeholder">Select an item name from the table to view its chart.</div>
                    <div class="chart-plot hidden">
                        <canvas id="single-chart-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <span>Made by Sporky with AI</span> |
            <span class="status">Data Generated: <span id="last-update">2025-04-13 05:36:58</span></span> | <a href="https://github.com/SporkSlinger/market-tracker-mwi" target="_blank" rel="noopener noreferrer">GitHub Repo</a>
        </footer>
    </div>

    <script>
        // --- Application State & Configuration ---
        const marketApp = {
            // Data
            allMarketData: {},
            marketSummary: [],
            gameData: { itemDetailMap: {} },
            filteredAndSortedSummary: [],
            simulatedLevels: {},
            pinnedItems: [],

            // UI State
            currentPage: 1,
            currentSort: { key: 'name', ascending: true },
            currentSearch: '',
            currentCategoryFilter: 'All',
            selectedTableRow: null,
            currentChart: null,
            currentChartProduct: null,
            currentChartTimeRange: '30d',
            currentYScaleType: 'logarithmic',
            currentTheme: 'light',
            useCustomSimSettings: true, // Default to using custom settings

            // Configuration
            itemsPerPage: 20,
            maxPinnedItems: 10,
            pinnedItemsKey: 'mwiPinnedItems',
            themeKey: 'mwi-market-theme',
            searchDebounceTimeout: null,

            // Constants
            ITEM_HRIDS: { /* ... */ },
            MAX_ENHANCE_LEVEL: 30,
            enhance_bonus: [ /* ... */ ],
            success_rate: [ /* ... */ ],

            // Default Player Stats (Used when custom settings are off)
            defaultPlayerStats: {
              enhancing_level: 100, observatory_level: 4, enhancer_level: 10,
              use_enchanted: true, enchanted_level: 5, use_enhancer_top: false,
              enhancer_top_level: 0, use_enhancer_bot: false, enhancer_bot_level: 0,
              use_guzzling: true, guzzling_level: 0, tea_enhancing: false,
              tea_super_enhancing: false, tea_ultra_enhancing: true, tea_blessed: true,
              tea_wisdom: false, priceAskBidRatio: 1.0, hourly_rate: 0
            },

            // DOM Elements
            elements: {},

            // Simulation Parameters (read from UI or defaults)
            simulationParams: {}
        };
        // --- Constants Definition ---
        marketApp.ITEM_HRIDS = {
            COIN: "/items/coin",
            MIRROR_OF_PROTECTION: "/items/mirror_of_protection",
            GUZZLING_POUCH: "/items/guzzling_pouch",
            ENCHANTED_GLOVES: "/items/enchanted_gloves",
            ENHANCERS_TOP: "/items/enhancers_top",
            ENHANCERS_BOTTOMS: "/items/enhancers_bottoms",
        };
        marketApp.enhance_bonus = [ 1, 1.02, 1.042, 1.066, 1.092, 1.12, 1.15, 1.182, 1.216, 1.252, 1.29, 1.33, 1.372, 1.416, 1.462, 1.51, 1.56, 1.612, 1.666, 1.722, 1.78 ];
        marketApp.success_rate = [ 50, 45, 45, 40, 40, 40, 35, 35, 35, 35, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 25, 25, 25, 25, 25, 20, 20, 20, 20, 20 ];


        // --- DOM Element Caching ---
        function cacheDOMElements() {
            console.log("Caching DOM elements..."); // Debug log
            marketApp.elements = {
                tableBodyEl: document.getElementById('item-table-body'),
                tableWrapperEl: document.querySelector('.table-wrapper'),
                paginationEl: document.getElementById('pagination'),
                pageInfoEl: document.getElementById('page-info'),
                prevButton: document.getElementById('prev-page'),
                nextButton: document.getElementById('next-page'),
                searchInput: document.getElementById('search-input'),
                categoryFilterEl: document.getElementById('category-filter'),
                sortOptionsEl: document.getElementById('sort-options'),
                tableHeaderRow: document.querySelector('#item-table thead tr'),
                chartCanvas: document.getElementById('single-chart-canvas'),
                chartPlotContainer: document.querySelector('.chart-plot'),
                chartPlaceholder: document.getElementById('chart-placeholder'),
                chartTimeControlsEl: document.getElementById('chart-time-controls'),
                chartControlsArea: document.getElementById('chart-controls-area'),
                scaleToggleButton: document.getElementById('scale-toggle-btn'),
                loadingMessageEl: document.getElementById('loading-message'),
                errorMessageEl: document.getElementById('error-message'),
                themeToggleButton: document.getElementById('theme-toggle-btn'),
                // Simulation UI Elements
                simulationSettingsDiv: document.querySelector('.simulation-settings'),
                useCustomSimSettingsCheckbox: document.getElementById('use-custom-sim-settings'), // Checkbox
                toggleSimDetailsButton: document.getElementById('toggle-sim-details-btn'),       // Toggle Button
                simControlsGrid: document.querySelector('.sim-controls-grid'),                   // Grid container
                simEnhancingLevelInput: document.getElementById('sim-enhancing-level'),
                simObservatoryLevelInput: document.getElementById('sim-observatory-level'),
                simEnhancerLevelSelect: document.getElementById('sim-enhancer-level'),
                simAskBidRatioInput: document.getElementById('sim-ask-bid-ratio'),
                simTeaBlessedCheckbox: document.getElementById('sim-tea-blessed'),
                simTeaUltraCheckbox: document.getElementById('sim-tea-ultra'),
                simulationErrorDisplay: document.getElementById('simulation-error-display'),
            };
             // Check if any essential elements are null
             for (const key in marketApp.elements) {
                 if (marketApp.elements[key] === null && key !== 'sortOptionsEl') { // sortOptionsEl is decorative now
                     console.error(`DOM Caching Error: Element for key "${key}" not found! Check HTML ID/Selector.`);
                     // Optional: Throw an error here to halt execution if a critical element is missing
                     // throw new Error(`Critical DOM element not found: ${key}`);
                 }
             }
            console.log("DOM elements cached."); // Debug log
        }

        // --- SVG Icons for Trends --- (remain the same)
        const trendUpIcon = `<svg class="trend-icon" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true"><path fill="currentColor" d="M8.707 2.293a1 1 0 0 0-1.414 0l-4 4a1 1 0 1 0 1.414 1.414L8 4.414l3.293 3.293a1 1 0 0 0 1.414-1.414l-4-4Z"></path></svg>`;
        const trendDownIcon = `<svg class="trend-icon" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true"><path fill="currentColor" d="M7.293 13.707a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0-1.414-1.414L8 11.586 4.707 8.293a1 1 0 0 0-1.414 1.414l4 4Z"></path></svg>`;

        // --- Utility Functions --- (remain the same)
        function formatPrice(price) { /* ... */ }
        function formatPriceSimulated(price) { /* ... */ }
        function formatTrend(trend) { /* ... */ }
        function timeReadable(sec) { /* ... */ }
        function isEnhanceableItem(item) { /* ... */ }
        function getItemHridByName(itemName) { /* ... */ }
        function showSimulationError(message) { /* ... */ }
        function hideSimulationError() { /* ... */ }

        // --- Pinning Logic --- (remain the same)
        function getPinnedItems() { /* ... */ }
        function savePinnedItems(items) { /* ... */ }
        function togglePin(itemName) { /* ... uses showSimulationError ... */ }
        function handlePinClick(itemName) { /* ... */ }

        // --- Theme Switching Logic --- (remain the same)
        function applyTheme(theme) { /* ... */ }
        function toggleTheme() { /* ... */ }
        function initTheme() { /* ... */ }

        // --- Data Fetching --- (remain the same)
        async function loadData() { /* ... */ }

        // --- Filtering and Sorting ---
        function applyFiltersAndSort() {
            console.log("Applying filters and sort..."); // Debug log
            try { // Add try-catch around sorting/filtering
                let result = [...marketApp.marketSummary]; // Use state data

                // Filter by Category
                if (marketApp.currentCategoryFilter !== 'All') {
                    result = result.filter(item => item.category === marketApp.currentCategoryFilter);
                }
                // Filter by Search Term
                const searchTerm = marketApp.currentSearch.toLowerCase();
                if (searchTerm) {
                    result = result.filter(item => item.name.toLowerCase().includes(searchTerm));
                }
                console.log(`Filtered down to ${result.length} items.`); // Debug log

                // Sort
                const currentPins = marketApp.pinnedItems; // Use state data
                const sortKey = marketApp.currentSort.key;
                const sortAsc = marketApp.currentSort.ascending;

                result.sort((a, b) => {
                    const isAPinned = currentPins.includes(a.name);
                    const isBPinned = currentPins.includes(b.name);
                    if (isAPinned && !isBPinned) return -1;
                    if (!isAPinned && isBPinned) return 1;

                    // Inner try-catch for comparison logic specifically
                    try {
                        let valA, valB;
                        switch(sortKey) {
                            case 'name': valA = a.name; valB = b.name; break;
                            case 'category': valA = a.category; valB = b.category; break;
                            case 'ask': valA = a.ask; valB = b.ask; break;
                            case 'buy': valA = a.buy; valB = b.buy; break;
                            case 'vendor': valA = a.vendor; valB = b.vendor; break;
                            case 'trend': valA = a.trend; valB = b.trend; break;
                            default: valA = a.name; valB = b.name; // Default to name
                        }

                        if (typeof valA === 'number' || typeof valB === 'number' || valA === null || valB === null) {
                            const numA = valA ?? (sortAsc ? Infinity : -Infinity);
                            const numB = valB ?? (sortAsc ? Infinity : -Infinity);
                            if (isNaN(numA) && isNaN(numB)) return 0;
                            if (isNaN(numA)) return sortAsc ? 1 : -1;
                            if (isNaN(numB)) return sortAsc ? -1 : 1;
                            return sortAsc ? numA - numB : numB - numA;
                        } else {
                            const strA = (valA ?? '').toLowerCase();
                            const strB = (valB ?? '').toLowerCase();
                            const compare = strA.localeCompare(strB);
                            return sortAsc ? compare : -compare;
                        }
                    } catch (e) {
                        console.error("Sort comparison error:", e, "Data A:", a, "Data B:", b); // Log data causing error
                        return 0;
                    }
                });
                console.log("Sorting complete."); // Debug log

                marketApp.filteredAndSortedSummary = result; // Update state
                marketApp.currentPage = 1; // Reset to first page
                renderCurrentPage(); // Call render
                updateSortIndicators(); // Update visual indicators on headers
            } catch (error) {
                console.error("Error during applyFiltersAndSort:", error);
                // Optionally show error to user
                marketApp.elements.errorMessageEl.textContent = `Error processing data: ${error.message}`;
                marketApp.elements.errorMessageEl.classList.remove('hidden');
                marketApp.elements.loadingMessageEl.style.display = 'none'; // Ensure loading is hidden
                marketApp.elements.tableWrapperEl.classList.add('hidden'); // Hide potentially broken table
            }
        }
        function updateSortIndicators() { /* ... */ }

        // --- Rendering (Using DOM Manipulation) ---
        function renderCurrentPage() {
            console.log("Rendering current page..."); // Debug log
            const tableBody = marketApp.elements.tableBodyEl;
            if (!tableBody) {
                 console.error("Cannot render: Table body element not found.");
                 return;
            }
            tableBody.innerHTML = ''; // Clear previous content

            if (marketApp.selectedTableRow) {
                marketApp.selectedTableRow.classList.remove('selected-item');
                marketApp.selectedTableRow = null;
            }

            const currentPins = marketApp.pinnedItems;
            const totalItems = marketApp.filteredAndSortedSummary.length;
            const totalPages = Math.ceil(totalItems / marketApp.itemsPerPage);
            marketApp.currentPage = Math.max(1, Math.min(marketApp.currentPage, totalPages || 1));

            const startIndex = (marketApp.currentPage - 1) * marketApp.itemsPerPage;
            const endIndex = startIndex + marketApp.itemsPerPage;
            const itemsToDisplay = marketApp.filteredAndSortedSummary.slice(startIndex, endIndex);
            console.log(`Rendering ${itemsToDisplay.length} items for page ${marketApp.currentPage}.`); // Debug log

            const fragment = document.createDocumentFragment();

            if (itemsToDisplay.length === 0 && totalItems === 0) { // Only show "no items" if filtering didn't cause it
                const message = marketApp.marketSummary.length === 0 ? 'Loading data or no data available.'
                              : (marketApp.currentSearch || marketApp.currentCategoryFilter !== 'All' ? 'No items match your filters.' : 'No market data available.');
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 7;
                td.textContent = message;
                td.style.textAlign = 'center'; td.style.padding = '20px'; td.style.color = 'var(--muted-text-color)';
                tr.appendChild(td);
                fragment.appendChild(tr);
            } else {
                 // Add try-catch around the loop for row creation
                 try {
                    itemsToDisplay.forEach((item, index) => {
                        // Inner try-catch for individual row errors
                        try {
                            const tr = document.createElement('tr');
                            tr.dataset.product = item.name;

                            const isPinned = currentPins.includes(item.name);
                            const itemHrid = item.hrid || getItemHridByName(item.name);
                            // Defensive check for itemDetail
                            const itemDetail = itemHrid ? marketApp.gameData.itemDetailMap[itemHrid] : null;
                            // Use !! to ensure boolean conversion for isEnhanceable check
                            const isEnhanceable = !!(itemDetail && Array.isArray(itemDetail.enhancementCosts) && itemDetail.enhancementCosts.length > 0);

                            const currentSimLevel = marketApp.simulatedLevels[item.name]?.level || 0;
                            const simulatedCostValue = marketApp.simulatedLevels[item.name]?.cost;

                            // 1. Pin Cell
                            const tdPin = document.createElement('td');
                            tdPin.className = 'pin-cell';
                            const pinIcon = document.createElement('i');
                            pinIcon.className = isPinned ? 'fas fa-star pin-icon pinned' : 'far fa-star pin-icon';
                            pinIcon.dataset.itemName = item.name;
                            pinIcon.title = isPinned ? 'Unpin Item' : 'Pin Item';
                            pinIcon.setAttribute('aria-label', `${isPinned ? 'Unpin' : 'Pin'} ${item.name}`);
                            tdPin.appendChild(pinIcon);
                            tr.appendChild(tdPin);

                            // 2. Name Cell
                            const tdName = document.createElement('td');
                            tdName.className = 'col-name';
                            const nameLink = document.createElement('a');
                            nameLink.className = 'item-name-link'; nameLink.href = '#'; nameLink.dataset.itemName = item.name; nameLink.textContent = item.name;
                            tdName.appendChild(nameLink);
                            if (isEnhanceable) {
                                 const enhControlSpan = document.createElement('span');
                                 enhControlSpan.className = 'enh-level-control';
                                 const btnMinus = document.createElement('button');
                                 btnMinus.className = 'enh-level-btn'; btnMinus.dataset.itemName = item.name; btnMinus.dataset.hrid = itemHrid || ''; btnMinus.dataset.change = '-1'; btnMinus.textContent = '-'; btnMinus.disabled = currentSimLevel <= 0; btnMinus.setAttribute('aria-label', `Decrease enhancement level for ${item.name}`);
                                 const levelDisplay = document.createElement('span');
                                 levelDisplay.className = 'enh-level-display'; levelDisplay.id = `level-display-${(itemHrid || item.name).replace(/[\s/]/g, '_')}`; levelDisplay.textContent = currentSimLevel >= 0 ? `+${currentSimLevel}` : '+0'; levelDisplay.setAttribute('aria-live', 'polite');
                                 const btnPlus = document.createElement('button');
                                 btnPlus.className = 'enh-level-btn'; btnPlus.dataset.itemName = item.name; btnPlus.dataset.hrid = itemHrid || ''; btnPlus.dataset.change = '1'; btnPlus.textContent = '+'; btnPlus.disabled = currentSimLevel >= marketApp.MAX_ENHANCE_LEVEL; btnPlus.setAttribute('aria-label', `Increase enhancement level for ${item.name}`);
                                 enhControlSpan.appendChild(btnMinus); enhControlSpan.appendChild(levelDisplay); enhControlSpan.appendChild(btnPlus);
                                 tdName.appendChild(enhControlSpan);
                             }
                            tr.appendChild(tdName);

                            // 3. Category Cell
                            const tdCategory = document.createElement('td');
                            tdCategory.className = 'col-category'; tdCategory.innerHTML = item.category || '<span class="na-value">N/A</span>';
                            tr.appendChild(tdCategory);

                            // 4. Ask Cell
                            const tdAsk = document.createElement('td');
                            tdAsk.className = 'col-ask ask-cell'; tdAsk.innerHTML = currentSimLevel > 0 ? formatPriceSimulated(simulatedCostValue) : formatPrice(item.ask);
                            tr.appendChild(tdAsk);

                            // 5. Buy Cell
                            const tdBuy = document.createElement('td');
                            tdBuy.className = 'col-buy buy-cell'; tdBuy.innerHTML = currentSimLevel > 0 ? formatPriceSimulated(simulatedCostValue) : formatPrice(item.buy);
                            tr.appendChild(tdBuy);

                            // 6. Vendor Cell
                            const tdVendor = document.createElement('td');
                            tdVendor.className = 'col-vendor'; tdVendor.innerHTML = `<span class="vendor-price">${formatPrice(item.vendor)}</span>`;
                            tr.appendChild(tdVendor);

                            // 7. Trend Cell
                            const tdTrend = document.createElement('td');
                            tdTrend.className = 'col-trend'; tdTrend.innerHTML = formatTrend(item.trend);
                            tr.appendChild(tdTrend);

                            if (item.name === marketApp.currentChartProduct) { tr.classList.add('selected-item'); marketApp.selectedTableRow = tr; }
                            fragment.appendChild(tr);
                        } catch (rowError) {
                             console.error(`Error rendering row ${index} for item:`, item, rowError);
                             // Optionally skip this row or render an error row
                        }
                    });
                 } catch (loopError) {
                     console.error("Error during itemsToDisplay loop:", loopError);
                     // Show error message to user
                     marketApp.elements.errorMessageEl.textContent = `Error rendering table data: ${loopError.message}`;
                     marketApp.elements.errorMessageEl.classList.remove('hidden');
                     marketApp.elements.loadingMessageEl.style.display = 'none';
                     marketApp.elements.tableWrapperEl.classList.add('hidden');
                 }
            }
            tableBody.appendChild(fragment);
            renderPagination(totalPages);
            console.log("Page rendering complete."); // Debug log
        }
        function renderPagination(totalPages) { /* ... */ }

        // --- Charting --- (remain the same)
        function displayChart(productName, clickedTrElement) { /* ... */ }
        function yAxisLogCallback(value, index, ticks) { /* ... */ }


        // --- Enhancement Simulation Logic --- (remain the same)
        function handleLevelChange(itemName, itemHrid, change) { /* ... */ }
        function updateTableRowCost(itemName, level, cost) { /* ... */ }
        function Enhancelate(input_data, protect_at) { /* ... */ }
        function getCosts(hrid, priceAskBidRatio) { /* ... */ }
        function getRealisticBaseItemPrice(hrid, priceAskBidRatio) { /* ... */ }
        function getItemMarketPrice(hrid, priceAskBidRatio) { /* ... */ }
        async function findBestEnhanceStrat(input_data) { /* ... */ }
        function readSimulationParameters() { /* ... */ }
        function loadSampleDataForTesting() { /* ... */ }
        function toggleSimDetailsVisibility() { /* ... */ }
        function applySimSettingsActiveState() { /* ... */ }

        // --- Event Handlers Setup ---
        function setupEventListeners() { /* ... */ }


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => { /* ... */ });

    </script>

</body>
</html>