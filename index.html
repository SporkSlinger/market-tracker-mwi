<!DOCTYPE html>
<html lang="en"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MWI Market Trends</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            /* Light Theme (Default) */
            --bg-color: #f8f9fa; /* Slightly off-white */
            --card-bg-color: #ffffff;
            --text-color-primary: #212529; /* Dark grey */
            --text-color-secondary: #6c757d; /* Medium grey */
            --border-color: #dee2e6; /* Light grey border */
            --accent-color: #007bff; /* Standard blue */
            --accent-hover-color: #0056b3;
            --positive-color: #28a745; /* Green */
            --negative-color: #dc3545; /* Red */
            --button-bg-color: #e9ecef;
            --button-hover-bg-color: #ced4da;
            --button-border-color: #ced4da;
            --button-hover-border-color: #adb5bd;
            --input-bg-color: #ffffff;
            --input-border-color: #ced4da;
            --input-focus-border-color: #86b7fe;
            --input-focus-shadow-color: rgba(0, 123, 255, 0.25);
            --table-header-bg: #e9ecef;
            --table-row-hover-bg: #f1f3f5;
            --table-row-selected-bg: #cfe2ff; /* Light blue selection */
            --link-color: var(--accent-color);
            --link-hover-color: var(--accent-hover-color);
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --chart-tick-color: #6c757d;
            --chart-title-color: #212529;
            --chart-tooltip-bg: rgba(0, 0, 0, 0.8);
            --chart-tooltip-text-color: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        html[data-theme="dark"] {
            /* Dark Theme Overrides */
            --bg-color: #1a1a1a; /* Very dark grey */
            --card-bg-color: #2c2c2c; /* Dark grey card */
            --text-color-primary: #e9ecef; /* Light grey text */
            --text-color-secondary: #adb5bd; /* Medium grey text */
            --border-color: #495057; /* Darker border */
            --accent-color: #4dabf7; /* Lighter blue */
            --accent-hover-color: #74c0fc;
            --positive-color: #40c057; /* Lighter green */
            --negative-color: #fa5252; /* Lighter red */
            --button-bg-color: #495057;
            --button-hover-bg-color: #6c757d;
            --button-border-color: #6c757d;
            --button-hover-border-color: #adb5bd;
            --input-bg-color: #343a40;
            --input-border-color: #495057;
            --input-focus-border-color: #4dabf7;
            --input-focus-shadow-color: rgba(77, 171, 247, 0.25);
            --table-header-bg: #343a40;
            --table-row-hover-bg: #3e444a;
            --table-row-selected-bg: #364a6d; /* Darker blue selection */
            --link-color: var(--accent-color);
            --link-hover-color: var(--accent-hover-color);
            --chart-grid-color: rgba(255, 255, 255, 0.15);
            --chart-tick-color: #adb5bd;
            --chart-title-color: #e9ecef;
            --chart-tooltip-bg: rgba(255, 255, 255, 0.8);
            --chart-tooltip-text-color: #1a1a1a;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        /* --- General Styles --- */
        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color-primary);
            line-height: 1.5; font-size: 14px;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; /* Smooth theme transition */
        }

        .container { max-width: 1600px; margin: 25px auto; padding: 0 25px; }

        h1 { text-align: center; color: var(--text-color-primary); margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600; font-size: 1.8em; letter-spacing: -0.5px; }

        .feedback-link-container { text-align: center; margin-bottom: 25px; font-size: 0.9em; }
        .feedback-link-container a { color: var(--text-color-secondary); text-decoration: none; border-bottom: 1px dashed var(--text-color-secondary); transition: color 0.2s, border-color 0.2s; padding-bottom: 1px; }
        .feedback-link-container a:hover { color: var(--link-color); border-color: var(--link-color); }

        /* --- Controls Area --- */
        .controls {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            padding: 16px 20px; margin-bottom: 30px; gap: 15px;
            background-color: var(--card-bg-color); border: 1px solid var(--border-color);
            border-radius: 8px; /* Slightly larger radius */
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .controls-left, .controls-right { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }

        /* Search and Filter Inputs */
        .search-form input[type="text"], .category-filter select {
            padding: 8px 12px; border: 1px solid var(--input-border-color); border-radius: 6px;
            min-width: 200px; font-size: 0.95em; background-color: var(--input-bg-color);
            color: var(--text-color-primary); box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
            transition: border-color 0.1s ease-in-out, box-shadow 0.1s ease-in-out, background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .search-form input[type="text"]:focus, .category-filter select:focus {
            border-color: var(--input-focus-border-color);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.075), 0 0 0 3px var(--input-focus-shadow-color);
            outline: none;
        }

        /* Buttons (General & Theme Toggle) */
        .button, #theme-toggle {
            padding: 8px 15px; background-color: var(--button-bg-color); color: var(--text-color-primary);
            border: 1px solid var(--button-border-color); border-radius: 6px; cursor: pointer;
            font-size: 0.95em; font-weight: 500; text-align: center;
            transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
            display: inline-flex; align-items: center; gap: 6px; /* For icon + text */
        }
        .button:hover, #theme-toggle:hover {
            background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color);
        }
        #theme-toggle {
            /* Specific styles for theme toggle if needed, e.g., fixed width */
             min-width: 40px; /* Ensure enough space for icon */
             justify-content: center;
        }
        #theme-toggle .fa-sun { display: none; } /* Hide sun icon by default */
        #theme-toggle .fa-moon { display: inline-block; } /* Show moon icon by default */
        html[data-theme="dark"] #theme-toggle .fa-sun { display: inline-block; } /* Show sun in dark mode */
        html[data-theme="dark"] #theme-toggle .fa-moon { display: none; } /* Hide moon in dark mode */


        /* --- Table Styles --- */
        .table-container {
            background-color: var(--card-bg-color); border: 1px solid var(--border-color);
            border-radius: 8px; overflow: hidden; /* Needed for border-radius on table */
            box-shadow: 0 2px 5px var(--shadow-color); margin-bottom: 25px;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th {
            background-color: var(--table-header-bg); font-weight: 600; font-size: 0.9em;
            color: var(--text-color-secondary); text-transform: uppercase; letter-spacing: 0.5px;
            cursor: pointer; user-select: none; white-space: nowrap;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            position: sticky; top: 0; /* Sticky header */
            z-index: 1;
        }
        th .sort-icon { margin-left: 5px; color: var(--text-color-secondary); opacity: 0.6; }
        th.sorted .sort-icon { opacity: 1; color: var(--text-color-primary); }
        tbody tr { transition: background-color 0.15s ease; cursor: pointer; } /* Make rows clickable */
        tbody tr:hover { background-color: var(--table-row-hover-bg); }
        tbody tr.selected-row { background-color: var(--table-row-selected-bg); font-weight: 500; }
        tbody tr:last-child td { border-bottom: none; }
        td { color: var(--text-color-primary); font-size: 0.95em; transition: color 0.2s ease-in-out; }
        td.number { text-align: right; font-variant-numeric: tabular-nums; /* Align numbers */ }
        td.trend { text-align: right; white-space: nowrap; }
        .trend-icon { margin-left: 4px; font-size: 0.9em; }
        .trend-positive { color: var(--positive-color); }
        .trend-negative { color: var(--negative-color); }
        .trend-neutral { color: var(--text-color-secondary); }
        .na-value { color: var(--text-color-secondary); font-style: italic; } /* Style for N/A */


        /* --- Pagination --- */
        .pagination { display: flex; justify-content: center; align-items: center; padding: 15px 0; gap: 8px; }
        .pagination button {
             padding: 6px 12px; background-color: var(--button-bg-color); color: var(--text-color-primary);
             border: 1px solid var(--button-border-color); border-radius: 4px; cursor: pointer;
             font-size: 0.9em; transition: background-color 0.15s ease, border-color 0.15s ease;
        }
        .pagination button:hover:not(:disabled) { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination span { font-size: 0.9em; color: var(--text-color-secondary); margin: 0 5px; }

        /* --- Chart Area --- */
        .chart-container {
            background-color: var(--card-bg-color); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 20px; margin-bottom: 30px;
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            min-height: 450px; /* Give chart area min height */
            display: flex; flex-direction: column; /* Allow placeholder to center */
        }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
        .chart-title { font-size: 1.1em; font-weight: 600; color: var(--text-color-primary); transition: color 0.2s ease-in-out; }
        .chart-controls button {
             padding: 5px 10px; background-color: var(--button-bg-color); color: var(--text-color-primary);
             border: 1px solid var(--button-border-color); border-radius: 4px; cursor: pointer;
             font-size: 0.85em; transition: background-color 0.15s ease, border-color 0.15s ease;
        }
        .chart-controls button:hover { background-color: var(--button-hover-bg-color); border-color: var(--button-hover-border-color); }
        .chart-controls button.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        #priceChart { max-height: 400px; width: 100%; } /* Limit chart height, ensure width */
        .chart-placeholder { /* Style for placeholder text */
             text-align: center; color: var(--text-color-secondary); padding: 60px; font-size: 1.05em;
             flex-grow: 1; display: flex; align-items: center; justify-content: center;
        }


        /* --- Footer --- */
        footer { text-align: center; margin-top: 40px; padding: 20px; font-size: 0.85em; color: var(--text-color-secondary); border-top: 1px solid var(--border-color); transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out; }
        footer a { color: var(--link-color); text-decoration: none; }
        footer a:hover { text-decoration: underline; color: var(--link-hover-color); }

        /* --- Utility --- */
        .loading-indicator, .error-message, .no-results-message { text-align: center; padding: 40px; font-size: 1.1em; color: var(--text-color-secondary); }
        .error-message { color: var(--negative-color); }
        .hidden { display: none; } /* Simple hide utility */

        /* Responsive adjustments if needed */
        @media (max-width: 768px) {
            .controls { flex-direction: column; align-items: stretch; }
            .controls-left, .controls-right { width: 100%; justify-content: center; }
            .search-form input[type="text"], .category-filter select { width: 100%; min-width: unset; }
            .chart-header { flex-direction: column; align-items: flex-start; }
            th, td { padding: 8px 10px; font-size: 0.9em;} /* Smaller padding on mobile */
            h1 { font-size: 1.5em; }
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Milky Way Idle Market Trends</h1>
        <div class="feedback-link-container">
             <a href="https://github.com/sporky/market-tracker-mwi/issues" target="_blank" rel="noopener noreferrer">Report an Issue / Feedback</a>
        </div>

        <div class="controls">
            <div class="controls-left">
                <form class="search-form" id="search-form" onsubmit="event.preventDefault();">
                    <input type="text" id="search-input" placeholder="Search item name...">
                </form>
                <div class="category-filter">
                    <select id="category-select">
                        <option value="">All Categories</option>
                        
                        <option value="Books">Books</option>
                        
                        <option value="Consumables">Consumables</option>
                        
                        <option value="Currencies">Currencies</option>
                        
                        <option value="Equipment / Back">Equipment / Back</option>
                        
                        <option value="Equipment / Body">Equipment / Body</option>
                        
                        <option value="Equipment / Feet">Equipment / Feet</option>
                        
                        <option value="Equipment / Hands">Equipment / Hands</option>
                        
                        <option value="Equipment / Head">Equipment / Head</option>
                        
                        <option value="Equipment / Legs">Equipment / Legs</option>
                        
                        <option value="Equipment / Main Hand">Equipment / Main Hand</option>
                        
                        <option value="Equipment / Off Hand">Equipment / Off Hand</option>
                        
                        <option value="Equipment / Pouch">Equipment / Pouch</option>
                        
                        <option value="Jewelry">Jewelry</option>
                        
                        <option value="Keys">Keys</option>
                        
                        <option value="Loots">Loots</option>
                        
                        <option value="Resources">Resources</option>
                        
                        <option value="Tools / Alchemy">Tools / Alchemy</option>
                        
                        <option value="Tools / Brewing">Tools / Brewing</option>
                        
                        <option value="Tools / Cheesesmithing">Tools / Cheesesmithing</option>
                        
                        <option value="Tools / Cooking">Tools / Cooking</option>
                        
                        <option value="Tools / Crafting">Tools / Crafting</option>
                        
                        <option value="Tools / Enhancing">Tools / Enhancing</option>
                        
                        <option value="Tools / Foraging">Tools / Foraging</option>
                        
                        <option value="Tools / Milking">Tools / Milking</option>
                        
                        <option value="Tools / Tailoring">Tools / Tailoring</option>
                        
                        <option value="Tools / Woodcutting">Tools / Woodcutting</option>
                        
                        <option value="Trinket">Trinket</option>
                        
                    </select>
                </div>
            </div>
            <div class="controls-right">
                 <button id="theme-toggle" title="Toggle Theme">
                     <i class="fas fa-moon"></i> <i class="fas fa-sun"></i>  </button>
                 </div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <div id="chart-title" class="chart-title">Select an item to view price history</div>
                <div class="chart-controls" id="chart-controls">
                    <button data-range="24h" class="active">24h</button>
                    <button data-range="48h">48h</button>
                    <button data-range="7d">7d</button>
                    <button data-range="30d">30d</button>
                </div>
            </div>
             <div id="chart-placeholder" class="chart-placeholder">Select an item from the table below.</div>
            <canvas id="priceChart" class="hidden"></canvas> <div id="chart-loading" class="loading-indicator hidden">Loading chart data...</div>
            <div id="chart-error" class="error-message hidden">Could not load chart data.</div>
        </div>

        <div class="table-container">
            <table id="market-table">
                <thead>
                    <tr>
                        <th data-sort="name">Name <span class="sort-icon fas fa-sort"></span></th>
                        <th data-sort="category">Category <span class="sort-icon fas fa-sort"></span></th>
                        <th data-sort="buy" class="number">Buy Price <span class="sort-icon fas fa-sort"></span></th>
                        <th data-sort="ask" class="number">Ask Price <span class="sort-icon fas fa-sort"></span></th>
                        <th data-sort="vendor" class="number">Vendor <span class="sort-icon fas fa-sort"></span></th>
                        <th data-sort="trend" class="number">24h Trend <span class="sort-icon fas fa-sort"></span></th>
                    </tr>
                </thead>
                <tbody id="market-body">
                    </tbody>
            </table>
            <div id="table-loading" class="loading-indicator">Loading market data...</div>
            <div id="table-error" class="error-message hidden">Could not load market data.</div>
            <div id="no-results" class="no-results-message hidden">No items match your search/filter.</div>
        </div>

        <div class="pagination" id="pagination">
            </div>

        <footer>
            Data generated: <span id="last-update">2025-04-11 16:39:12</span> |
            Created by Sporky with AI |
            Data source: <a href="https://github.com/holychikenz/MWIApi" target="_blank" rel="noopener noreferrer">holychikenz/MWIApi</a>
        </footer>
    </div>

    <script>
        // --- Constants and State ---
        const ITEMS_PER_PAGE = 20;
        let allItems = []; // Holds all fetched item data from market_summary.json
        let filteredItems = []; // Holds items after search/filter
        let sortedItems = []; // Holds items after sorting
        let currentPage = 1;
        let currentSort = { column: 'name', direction: 'asc' }; // Default sort
        let selectedItem = null; // Name of the item selected for charting
        let priceChart = null; // Chart.js instance
        let historicalDataCache = {}; // Cache for fetched historical data {itemName: data}
        let currentChartRange = '24h'; // Default chart range

        // --- DOM Elements ---
        const tableBody = document.getElementById('market-body');
        const paginationContainer = document.getElementById('pagination');
        const searchInput = document.getElementById('search-input');
        const categorySelect = document.getElementById('category-select');
        const tableLoading = document.getElementById('table-loading');
        const tableError = document.getElementById('table-error');
        const noResults = document.getElementById('no-results');
        const chartCanvas = document.getElementById('priceChart'); // Get canvas element
        const chartCtx = chartCanvas.getContext('2d'); // Get context
        const chartTitle = document.getElementById('chart-title');
        const chartControls = document.getElementById('chart-controls');
        const chartLoading = document.getElementById('chart-loading');
        const chartError = document.getElementById('chart-error');
        const chartPlaceholder = document.getElementById('chart-placeholder'); // Get placeholder element
        const themeToggleButton = document.getElementById('theme-toggle'); // Theme toggle button

        // --- Theme Switching Logic ---
        const THEME_KEY = 'mwi-market-theme';

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            localStorage.setItem(THEME_KEY, theme);
            // Update chart colors if chart exists
            if (priceChart) {
                updateChartTheme();
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.hasAttribute('data-theme') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        }

        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
            applyTheme(initialTheme);
        }

        // Add event listener for the theme toggle button
        themeToggleButton.addEventListener('click', toggleTheme);

        // Initialize theme on load (moved inside DOMContentLoaded)


        // --- Data Fetching ---
        async function fetchData() {
            tableLoading.classList.remove('hidden');
            tableError.classList.add('hidden');
            noResults.classList.add('hidden');
            tableBody.innerHTML = ''; // Clear table while loading
            paginationContainer.innerHTML = ''; // Clear pagination

            try {
                const response = await fetch('./data/market_summary.json?t=' + Date.now()); // Cache bust
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allItems = await response.json();
                // Initial processing
                filterAndSort(); // Apply default filters/sort
                //renderTablePage(); // Render first page - Called by filterAndSort
                //renderPagination(); // Render pagination controls - Called by filterAndSort
                tableLoading.classList.add('hidden');

            } catch (error) {
                console.error("Failed to fetch market data:", error);
                tableLoading.classList.add('hidden');
                tableError.textContent = `Error loading market data: ${error.message}. Please try again later.`;
                tableError.classList.remove('hidden');
            }
        }

        // ** ORIGINAL fetchHistoricalData ** (Assumes nested JSON structure)
        async function fetchHistoricalData(itemName) {
            if (historicalDataCache[itemName]) {
                console.log(`Using cached history for ${itemName}`);
                return historicalDataCache[itemName];
            }
            console.log(`Fetching history for ${itemName}...`);
            chartLoading.classList.remove('hidden');
            chartError.classList.add('hidden');
            chartPlaceholder.classList.add('hidden'); // Hide placeholder when loading
            chartCanvas.classList.add('hidden'); // Hide canvas when loading

            try {
                // Use a cache-busting query parameter
                const response = await fetch(`./data/market_history.json?t=${Date.now()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const allHistory = await response.json(); // Expects { "Item Name": { buy: [], ask: [] } } structure

                if (!allHistory || !allHistory[itemName]) {
                     console.warn(`No historical data found for ${itemName} in market_history.json`);
                     historicalDataCache[itemName] = { buy: [], ask: [] }; // Cache empty data
                     chartLoading.classList.add('hidden');
                     chartError.textContent = `No historical data available for ${itemName}.`;
                     chartError.classList.remove('hidden');
                     chartPlaceholder.classList.add('hidden'); // Keep placeholder hidden on error
                     chartCanvas.classList.add('hidden'); // Keep canvas hidden on error
                     return historicalDataCache[itemName];
                }

                // Convert timestamps (seconds since epoch) to Date objects for Chart.js
                const parseHistory = (history) => {
                     if (!Array.isArray(history)) {
                         console.warn(`Expected array for history, got:`, history);
                         return []; // Handle cases where buy/ask might not be arrays
                     }
                     return history.map(p => ({
                         x: new Date(p.timestamp * 1000),
                         y: p.price // Keep price as is (handle log scale issues later if needed)
                     })).sort((a, b) => a.x - b.x); // Ensure sorted by date
                };

                const itemData = {
                    buy: parseHistory(allHistory[itemName].buy),
                    ask: parseHistory(allHistory[itemName].ask)
                };
                console.log(`Successfully fetched and parsed history for ${itemName}. Buy points: ${itemData.buy.length}, Ask points: ${itemData.ask.length}`);
                historicalDataCache[itemName] = itemData; // Cache the data
                chartLoading.classList.add('hidden');
                chartCanvas.classList.remove('hidden'); // Show canvas now that data is loaded
                return itemData;
            } catch (error) {
                console.error(`Failed to fetch/process historical data for ${itemName}:`, error);
                chartLoading.classList.add('hidden');
                chartError.textContent = `Error loading chart data for ${itemName}.`;
                chartError.classList.remove('hidden');
                chartPlaceholder.classList.add('hidden'); // Keep placeholder hidden on error
                chartCanvas.classList.add('hidden'); // Keep canvas hidden on error
                return null; // Indicate error
            }
        }


        // --- Data Filtering and Sorting ---
        function filterAndSort() {
            // 1. Filter by search term
            const searchTerm = searchInput.value.toLowerCase().trim();
            let tempItems = allItems;
            if (searchTerm) {
                tempItems = tempItems.filter(item => item.name.toLowerCase().includes(searchTerm));
            }

            // 2. Filter by category
            const selectedCategory = categorySelect.value;
            if (selectedCategory) {
                tempItems = tempItems.filter(item => item.category === selectedCategory);
            }
            filteredItems = tempItems;

            // 3. Sort
            sortItems(); // Sorts filteredItems into sortedItems

            // 4. Reset to page 1 and re-render
            currentPage = 1;
            renderTablePage();
            renderPagination();

             // Show 'no results' message if applicable
            noResults.classList.toggle('hidden', sortedItems.length > 0); // Use sortedItems length
            // Hide/show table container based on results
            document.querySelector('.table-container').classList.toggle('hidden', sortedItems.length === 0);
            // Hide/show pagination based on results and total pages
            paginationContainer.classList.toggle('hidden', sortedItems.length === 0 || Math.ceil(sortedItems.length / ITEMS_PER_PAGE) <= 1);
        }

        function sortItems() {
            const { column, direction } = currentSort;
            // Sort the filteredItems array in place or create a new sorted array
            sortedItems = [...filteredItems].sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                // Handle null/undefined values (treat as lowest for asc, highest for desc)
                const ascSortNull = -Infinity;
                const descSortNull = Infinity;

                // Use Infinity for ascending nulls (want them last), -Infinity for descending
                if (valA === null || valA === undefined) valA = direction === 'asc' ? Infinity : -Infinity;
                if (valB === null || valB === undefined) valB = direction === 'asc' ? Infinity : -Infinity;


                // Handle numeric vs string comparison
                if (typeof valA === 'number' && typeof valB === 'number') {
                    // Handle potential NaN values if they sneak in
                     if (isNaN(valA)) valA = direction === 'asc' ? Infinity : -Infinity;
                     if (isNaN(valB)) valB = direction === 'asc' ? Infinity : -Infinity;
                    return direction === 'asc' ? valA - valB : valB - valA;
                } else {
                    // Ensure consistent string comparison (case-insensitive)
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                }
            });
        }

        function handleSort(event) {
            const th = event.target.closest('th'); // Get the header element
            if (!th || !th.dataset.sort) return; // Clicked outside a sortable header

            const newColumn = th.dataset.sort;
            let newDirection = 'asc';
            if (currentSort.column === newColumn && currentSort.direction === 'asc') {
                newDirection = 'desc';
            }

            currentSort = { column: newColumn, direction: newDirection };
            sortItems(); // Re-sort the currently filtered items
            currentPage = 1; // Go back to page 1 after sorting
            renderTablePage();
            renderPagination(); // Pagination might change if sorting affects order significantly (though usually not item count)
            updateSortIcons();
        }

        function updateSortIcons() {
            document.querySelectorAll('#market-table th[data-sort]').forEach(th => {
                const column = th.dataset.sort;
                const icon = th.querySelector('.sort-icon');
                th.classList.remove('sorted');
                icon.className = 'sort-icon fas fa-sort'; // Reset icon

                if (column === currentSort.column) {
                    th.classList.add('sorted');
                    icon.className = `sort-icon fas ${currentSort.direction === 'asc' ? 'fa-sort-up' : 'fa-sort-down'}`;
                }
            });
        }

        // --- Rendering ---
        function renderTablePage() {
            tableBody.innerHTML = ''; // Clear previous page
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = sortedItems.slice(start, end); // Use sortedItems

            if (pageItems.length === 0 && allItems.length > 0) {
                 // Handled by the 'no-results' div toggle in filterAndSort
                return;
            }

            const fragment = document.createDocumentFragment();
            pageItems.forEach(item => {
                const row = document.createElement('tr');
                row.dataset.itemName = item.name; // Store item name for chart selection
                row.classList.toggle('selected-row', item.name === selectedItem); // Highlight if selected

                // Trend display
                let trendHtml = '<span class="na-value">--</span>'; // Default: N/A
                if (typeof item.trend === 'number' && !isNaN(item.trend)) {
                    const trendClass = item.trend > 0 ? 'trend-positive' : (item.trend < 0 ? 'trend-negative' : 'trend-neutral');
                    const trendIcon = item.trend > 0 ? 'fa-arrow-up' : (item.trend < 0 ? 'fa-arrow-down' : '');
                    trendHtml = `<span class="${trendClass}">${item.trend.toFixed(1)}% ${trendIcon ? `<i class="fas ${trendIcon} trend-icon"></i>` : ''}</span>`;
                }

                // Format numbers nicely, handle nulls gracefully
                const formatPrice = (price) => (price === null || price === undefined) ? '<span class="na-value">--</span>' : price.toLocaleString();

                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.category || '<span class="na-value">N/A</span>'}</td>
                    <td class="number">${formatPrice(item.buy)}</td>
                    <td class="number">${formatPrice(item.ask)}</td>
                    <td class="number">${item.vendor === null ? '<span class="na-value">--</span>' : formatPrice(item.vendor)}</td>
                    <td class="trend number">${trendHtml}</td>
                `;
                // Add click listener for chart selection
                row.addEventListener('click', handleRowClick);
                fragment.appendChild(row);
            });
            tableBody.appendChild(fragment);
        }

        function renderPagination() {
            paginationContainer.innerHTML = ''; // Clear previous controls
            const totalPages = Math.ceil(sortedItems.length / ITEMS_PER_PAGE); // Use sortedItems length

            if (totalPages <= 1) {
                 paginationContainer.classList.add('hidden'); // Hide if 1 page or less
                 return;
            }
            paginationContainer.classList.remove('hidden'); // Show if more than 1 page


            const fragment = document.createDocumentFragment();

            // Previous Button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '&laquo; Prev';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTablePage();
                    renderPagination(); // Re-render to update button states
                }
            });
            fragment.appendChild(prevButton);

            // Page Info Span
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            fragment.appendChild(pageInfo);

            // Next Button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = 'Next &raquo;';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTablePage();
                    renderPagination(); // Re-render to update button states
                }
            });
            fragment.appendChild(nextButton);

            paginationContainer.appendChild(fragment);
        }

        // --- Charting ---

        // Function to get computed style for theme-aware colors
        function getCssVariable(varName) {
            return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }

        function getChartColors() {
             // Use CSS variables defined in the <style> block
            return {
                buyColor: getCssVariable('--positive-color') || 'rgba(40, 167, 69, 0.8)', // Greenish
                askColor: getCssVariable('--negative-color') || 'rgba(220, 53, 69, 0.8)', // Reddish
                gridColor: getCssVariable('--chart-grid-color') || 'rgba(0, 0, 0, 0.1)',
                tickColor: getCssVariable('--chart-tick-color') || '#6c757d',
                titleColor: getCssVariable('--chart-title-color') || '#212529',
                tooltipBgColor: getCssVariable('--chart-tooltip-bg') || 'rgba(0, 0, 0, 0.8)',
                tooltipTextColor: getCssVariable('--chart-tooltip-text-color') || '#ffffff'
            };
        }

         // ** ORIGINAL createOrUpdateChart ** (Assumes nested JSON structure from fetchHistoricalData)
         function createOrUpdateChart(itemName, historyData) {
            // Ensure placeholder is hidden and canvas is shown
            chartPlaceholder.classList.add('hidden');
            chartCanvas.classList.remove('hidden');
            chartError.classList.add('hidden'); // Hide any previous error

            if (!historyData || (!historyData.buy.length && !historyData.ask.length)) {
                 console.log(`No valid history data to plot for ${itemName}`);
                 chartTitle.textContent = `No price history available for ${itemName}`;
                 if (priceChart) {
                     priceChart.destroy();
                     priceChart = null;
                 }
                 chartCanvas.classList.add('hidden'); // Hide canvas if no data
                 chartPlaceholder.textContent = `No price history available for ${itemName}`;
                 chartPlaceholder.classList.remove('hidden'); // Show placeholder message
                 return;
            }

            chartTitle.textContent = `Price History: ${itemName}`;
            const colors = getChartColors();

            // Filter data based on the selected time range BEFORE creating datasets
            const now = new Date();
            let minTime;
            switch (currentChartRange) {
                case '48h': minTime = new Date(now.getTime() - 48 * 60 * 60 * 1000); break;
                case '7d': minTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); break;
                case '30d': minTime = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000); break;
                case '24h': // fallthrough default
                default: minTime = new Date(now.getTime() - 24 * 60 * 60 * 1000); break;
            }

            const filterDataByTime = (data) => data.filter(point => point.x >= minTime);

            const filteredBuyData = filterDataByTime(historyData.buy);
            const filteredAskData = filterDataByTime(historyData.ask);

            // Check if there's data AFTER filtering
            if (filteredBuyData.length === 0 && filteredAskData.length === 0) {
                 console.log(`No history data in range ${currentChartRange} for ${itemName}`);
                 chartTitle.textContent = `No data for ${itemName} in the last ${currentChartRange}`;
                 if (priceChart) { priceChart.destroy(); priceChart = null; }
                 chartCanvas.classList.add('hidden');
                 chartPlaceholder.textContent = `No data available for ${itemName} in the selected time range (${currentChartRange}).`;
                 chartPlaceholder.classList.remove('hidden');
                 return;
            }


            const datasets = [
                {
                    label: 'Buy Price',
                    data: filteredBuyData, // Use filtered data
                    borderColor: colors.buyColor,
                    backgroundColor: colors.buyColor,
                    tension: 0.1, pointRadius: 1, pointHoverRadius: 4, borderWidth: 1.5,
                    spanGaps: false // Do not connect across gaps where data is null/missing
                },
                {
                    label: 'Ask Price',
                    data: filteredAskData, // Use filtered data
                    borderColor: colors.askColor,
                    backgroundColor: colors.askColor,
                    tension: 0.1, pointRadius: 1, pointHoverRadius: 4, borderWidth: 1.5,
                    spanGaps: false // Do not connect across gaps
                }
            ];


            const chartConfig = {
                type: 'line',
                data: { datasets: datasets }, // Pass datasets with potentially filtered data
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: determineTimeUnit(minTime, now),
                                tooltipFormat: 'MMM d, HH:mm', // Adjusted format
                                displayFormats: {
                                    millisecond: 'HH:mm:ss.SSS', second: 'HH:mm:ss', minute: 'HH:mm',
                                    hour: 'HH:mm', // Simpler hour format
                                    day: 'MMM d', week: 'MMM d', month: 'MMM yyyy',
                                    quarter: 'QQQ yyyy', year: 'yyyy',
                                }
                            },
                            grid: { color: colors.gridColor },
                            ticks: { color: colors.tickColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 },
                            title: { display: false } // No need for x-axis title
                        },
                        y: {
                            type: 'logarithmic',
                            min: 1, // Set minimum for log scale to avoid issues with 0 or negatives if they sneak in
                            grid: { color: colors.gridColor },
                            ticks: {
                                color: colors.tickColor,
                                callback: function(value, index, values) {
                                    if (value <= 0) return null; // Explicitly hide non-positive ticks
                                    if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M'; // Add decimal for millions
                                    if (value >= 1000) return (value / 1000).toFixed(1) + 'k'; // Add decimal for thousands
                                    // Only show tick if it's a power of 10 or a small value for clarity
                                    const log10 = Math.log10(value);
                                    if (Math.abs(log10 - Math.round(log10)) < 0.01 || value < 10) { // Adjust threshold for small values
                                        return value.toLocaleString(); // Show small values directly
                                    }
                                    return null; // Hide intermediate ticks
                                }
                            },
                            title: { display: true, text: 'Price (Log Scale)', color: colors.titleColor },
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index', intersect: false,
                            backgroundColor: colors.tooltipBgColor, titleColor: colors.tooltipTextColor, bodyColor: colors.tooltipTextColor,
                        },
                        legend: { labels: { color: colors.titleColor } }
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false },
                    animation: { duration: 0 }, // Disable animation for potentially smoother updates
                }
            };

             // Wrap chart creation/update in try-catch
            try {
                if (priceChart) {
                    // Update existing chart instance
                    console.log(`Updating chart for ${itemName}`);
                    priceChart.data.datasets = datasets; // Update with potentially filtered data
                    priceChart.options.scales.x.time.unit = determineTimeUnit(minTime, now); // Update time unit
                    // Update colors (important for theme switching)
                     priceChart.options.scales.x.grid.color = colors.gridColor;
                     priceChart.options.scales.x.ticks.color = colors.tickColor;
                     priceChart.options.scales.y.grid.color = colors.gridColor;
                     priceChart.options.scales.y.ticks.color = colors.tickColor;
                     priceChart.options.scales.y.title.color = colors.titleColor;
                     priceChart.options.plugins.tooltip.backgroundColor = colors.tooltipBgColor;
                     priceChart.options.plugins.tooltip.titleColor = colors.tooltipTextColor;
                     priceChart.options.plugins.tooltip.bodyColor = colors.tooltipTextColor;
                     priceChart.options.plugins.legend.labels.color = colors.titleColor;
                     priceChart.data.datasets[0].borderColor = colors.buyColor;
                     priceChart.data.datasets[0].backgroundColor = colors.buyColor;
                     priceChart.data.datasets[1].borderColor = colors.askColor;
                     priceChart.data.datasets[1].backgroundColor = colors.askColor;

                    priceChart.update();
                } else {
                    // Create new chart instance
                    console.log(`Creating new chart for ${itemName}`);
                    priceChart = new Chart(chartCtx, chartConfig);
                }
            } catch (chartError) {
                 console.error(`Error creating/updating chart for ${itemName}:`, chartError);
                 chartError.textContent = `Failed to render chart: ${chartError.message}`;
                 chartError.classList.remove('hidden');
                 chartCanvas.classList.add('hidden');
                 chartPlaceholder.textContent = `Error rendering chart for ${itemName}.`;
                 chartPlaceholder.classList.remove('hidden');
                 if (priceChart) { priceChart.destroy(); priceChart = null; } // Clean up partial chart
            }
        }

        // Helper to determine appropriate time unit for x-axis based on range
        function determineTimeUnit(minTime, maxTime) {
            const diffHours = (maxTime - minTime) / (1000 * 60 * 60);
            if (diffHours <= 48) return 'hour';
            if (diffHours <= 7 * 24) return 'day';
            return 'day'; // Default to day for longer ranges
        }

        function updateChartTheme() {
            if (!priceChart) return;
            console.log("Updating chart theme...");
            const colors = getChartColors();
            // Update colors in options
            priceChart.options.scales.x.grid.color = colors.gridColor;
            priceChart.options.scales.x.ticks.color = colors.tickColor;
            // priceChart.options.scales.x.title.color = colors.titleColor; // Title hidden
            priceChart.options.scales.y.grid.color = colors.gridColor;
            priceChart.options.scales.y.ticks.color = colors.tickColor;
            priceChart.options.scales.y.title.color = colors.titleColor;
            priceChart.options.plugins.tooltip.backgroundColor = colors.tooltipBgColor;
            priceChart.options.plugins.tooltip.titleColor = colors.tooltipTextColor;
            priceChart.options.plugins.tooltip.bodyColor = colors.tooltipTextColor;
            priceChart.options.plugins.legend.labels.color = colors.titleColor;
            // Update dataset colors directly
            priceChart.data.datasets[0].borderColor = colors.buyColor;
            priceChart.data.datasets[0].backgroundColor = colors.buyColor;
            priceChart.data.datasets[1].borderColor = colors.askColor;
            priceChart.data.datasets[1].backgroundColor = colors.askColor;

            priceChart.update(); // Re-render the chart with new colors
        }


        // --- Event Handlers ---
        async function handleRowClick(event) {
            const row = event.currentTarget;
            const itemName = row.dataset.itemName;
            console.log(`Row clicked: ${itemName}`);

            if (selectedItem === itemName) {
                console.log("Item already selected, ignoring click.");
                return; // Don't reload if clicking the same item
            }

            // Update selected item state
            selectedItem = itemName;

            // Update row highlighting
            document.querySelectorAll('#market-body tr.selected-row').forEach(r => r.classList.remove('selected-row'));
            row.classList.add('selected-row');

            // Fetch and display chart data
            const historyData = await fetchHistoricalData(itemName); // Use the original function
            if (historyData) { // Only update chart if data fetch was successful
                 createOrUpdateChart(itemName, historyData); // Use the original function
            } else {
                 // Error handled within fetchHistoricalData, chart/placeholder visibility handled there too
                 console.error(`Failed to get history data for ${itemName} in handleRowClick`);
                 if (priceChart) {
                     priceChart.destroy();
                     priceChart = null;
                 }
                 chartTitle.textContent = `Could not load data for ${itemName}`;
                 // Ensure placeholder shows error
                 chartCanvas.classList.add('hidden');
                 chartPlaceholder.textContent = `Could not load data for ${itemName}.`;
                 chartPlaceholder.classList.remove('hidden');
                 chartError.classList.add('hidden'); // Hide specific error div if placeholder is shown
            }
        }

        function handleChartRangeChange(event) {
            if (event.target.tagName !== 'BUTTON') return; // Ignore clicks not on buttons

            const newRange = event.target.dataset.range;
            if (newRange === currentChartRange) return; // No change

            console.log(`Chart range changed to: ${newRange}`);
            currentChartRange = newRange;

            // Update button active state
            chartControls.querySelectorAll('button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range === newRange);
            });

            // Re-filter and update chart if an item is selected
            if (selectedItem) {
                console.log(`Re-rendering chart for ${selectedItem} with range ${newRange}`);
                const cachedData = historicalDataCache[selectedItem];
                if (cachedData) { // Use cached data if available
                    // We need to re-filter the cached data based on the new time range
                    createOrUpdateChart(selectedItem, cachedData); // createOrUpdateChart now handles filtering
                } else {
                    // This case might happen if cache was cleared or first load failed for item
                    // Re-trigger fetch, which will then call createOrUpdateChart
                    console.log(`Cache miss for ${selectedItem}, re-fetching...`);
                    fetchHistoricalData(selectedItem).then(historyData => {
                         if (historyData) createOrUpdateChart(selectedItem, historyData);
                    });
                }
            } else {
                 console.log("Range changed, but no item selected.");
            }
        }

        // Debounced search handler
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterAndSort, 300); // Apply filter after 300ms pause
        });

        // Category filter handler
        categorySelect.addEventListener('change', filterAndSort);

        // Table sort handler
        document.querySelector('#market-table thead').addEventListener('click', handleSort);

        // Chart range controls handler
        chartControls.addEventListener('click', handleChartRangeChange);

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM fully loaded and parsed");
             // Initialize theme first
            initTheme();
            // Initial data fetch for the table
            fetchData();
            // Add event listeners (already done above for inputs/buttons)
            // Initial sort icon update
            updateSortIcons();
        });

    </script>
</body>
</html>