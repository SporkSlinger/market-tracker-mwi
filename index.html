<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MWI Market Trends</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f0f2f5; /* Slightly different background */
            --card-bg-color: #ffffff;
            --text-color: #172b4d; /* Dark blue-grey text */
            --muted-text-color: #6b778c;
            --border-color: #dfe1e6;
            --accent-color: #0052cc; /* Atlassian blue */
            --accent-hover-color: #003f99;
            --positive-color: #006644; /* Dark green */
            --negative-color: #bf2600; /* Dark red */
            --button-bg-color: #f4f5f7;
            --button-hover-bg-color: #e9ecef;
            --button-active-bg-color: #dfe1e6;
            --shadow-color: rgba(9, 30, 66, 0.1); /* Subtle shadow based on text */
            --table-header-bg: #fafbfc;
            --table-row-hover-bg: #f8f9fa;
            --table-row-selected-bg: #e7f0ff;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5; /* Standard line height */
            font-size: 14px; /* Base font size for density */
        }
        .container {
            max-width: 95%; /* Use more screen width */
            margin: 20px auto;
            padding: 0 20px; /* Adjust padding */
            box-sizing: border-box;
        }
        h1 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 15px;
            font-weight: 600; /* Slightly less bold */
            font-size: 1.75em;
        }
        .status {
            text-align: center;
            margin-bottom: 25px;
            font-size: 0.85em; /* Smaller status */
            color: var(--muted-text-color);
        }

        /* Controls Area */
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-bg-color);
            padding: 12px 20px; /* Reduced padding */
            border-radius: 6px; /* Less rounded */
            box-shadow: 0 1px 3px var(--shadow-color);
            margin-bottom: 30px;
            gap: 15px;
            border: 1px solid var(--border-color);
        }
        .controls-left, .controls-right { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }

        .search-form input[type="text"], .category-filter select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-width: 200px;
            font-size: 0.9em;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .search-form input[type="text"]:focus, .category-filter select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 82, 204, 0.25);
            outline: none;
        }
        .sort-options span { font-weight: 600; color: var(--text-color); margin-right: 5px; font-size: 0.9em; }
        .sort-options button {
            padding: 6px 12px; /* Smaller buttons */
            background-color: var(--button-bg-color);
            color: var(--text-color);
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85em;
            transition: background-color 0.2s, border-color 0.2s;
            border: 1px solid transparent;
            cursor: pointer;
            font-weight: 500;
        }
        .sort-options button:hover { background-color: var(--button-hover-bg-color); }
        .sort-options button.current-sort {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            font-weight: 600;
        }

        /* Layout for Table and Chart */
        .main-layout { display: flex; flex-wrap: wrap; gap: 25px; }
        .item-table-container { flex: 3; min-width: 500px; /* Table takes more space */ }
        .chart-display-container { flex: 2; min-width: 400px; }

        /* Item Table Styling */
        .table-wrapper { max-height: 75vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 1px 3px var(--shadow-color); background-color: var(--card-bg-color); }
        #item-table { width: 100%; border-collapse: collapse; }
        #item-table th, #item-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        #item-table th { background-color: var(--table-header-bg); font-weight: 600; font-size: 0.85em; text-transform: uppercase; color: var(--muted-text-color); position: sticky; top: 0; z-index: 1; }
        #item-table tbody tr:hover { background-color: var(--table-row-hover-bg); }
        #item-table tbody tr.selected-item { background-color: var(--table-row-selected-bg); font-weight: 500; }
        #item-table td:nth-child(1) { font-weight: 500; cursor: pointer; color: var(--accent-color); } /* Product Name */
        #item-table td:nth-child(1):hover { text-decoration: underline; color: var(--accent-hover-color); }
        #item-table td:nth-child(2) { font-size: 0.9em; color: var(--muted-text-color); } /* Category */
        #item-table td:nth-child(n+3) { text-align: right; font-family: monospace; font-size: 0.95em; } /* Numeric columns */

        .trend-positive { color: var(--positive-color); }
        .trend-negative { color: var(--negative-color); }
        .vendor-price { color: #6f42c1; } /* Purple */
        .na-value { color: #ccc; } /* Style for N/A */

        /* Chart Area Styling */
        .chart-display { background-color: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 1px 3px var(--shadow-color); padding: 20px; min-height: 420px; position: relative; }
        .chart-placeholder { text-align: center; color: #aaa; padding: 60px; font-size: 1.1em; }
        .chart-plot canvas { max-width: 100%; max-height: 400px; }

        /* Pagination styling */
        .pagination { text-align: center; margin-top: 20px; padding-bottom: 20px; }
        .pagination button { margin: 0 3px; padding: 7px 14px; background-color: var(--card-bg-color); border: 1px solid var(--border-color); color: var(--accent-color); border-radius: 4px; transition: background-color 0.2s, color 0.2s, border-color 0.2s; cursor: pointer; font-weight: 500; font-size: 0.9em; }
        .pagination button:hover:not(:disabled) { background-color: #f1f3f5; border-color: #adb5bd; }
        .pagination button.current { background-color: var(--accent-color); color: white; border-color: var(--accent-color); font-weight: bold; cursor: default; }
        .pagination button:disabled { color: #adb5bd; background-color: #f8f9fa; cursor: not-allowed; border-color: #e9ecef; }

        .loading-message, .error-message { text-align: center; padding: 30px; font-size: 1.1em; color: var(--muted-text-color); }
        .error-message { color: var(--negative-color); }

        /* Footer */
        footer { text-align: center; margin-top: 40px; padding: 20px 0; font-size: 0.9em; color: var(--muted-text-color); border-top: 1px solid var(--border-color); }

    </style>
</head>
<body>

    <div class="container">
        <h1>MWI Market Trends</h1>
        <div class="status"> Data Generated: <span id="last-update">2025-04-10 16:39:26</span> </div>

        <div class="controls">
            <div class="controls-left">
                 <div class="search-form">
                    <input type="text" id="search-input" placeholder="Search Product Name...">
                </div>
                <div class="category-filter">
                     <select id="category-filter">
                         <option value="All">All Categories</option>
                         
                         <option value="Unknown / Acrobatic Hood">Unknown / Acrobatic Hood</option>
                         
                         <option value="Unknown / Body">Unknown / Body</option>
                         
                         <option value="Unknown / Crushed Sunstone">Unknown / Crushed Sunstone</option>
                         
                         <option value="Unknown / Earrings Of Gathering">Unknown / Earrings Of Gathering</option>
                         
                         <option value="Unknown / Earrings Of Resistance">Unknown / Earrings Of Resistance</option>
                         
                         <option value="Unknown / Feet">Unknown / Feet</option>
                         
                         <option value="Unknown / Flaming Cloth">Unknown / Flaming Cloth</option>
                         
                         <option value="Unknown / Griffin Talon">Unknown / Griffin Talon</option>
                         
                         <option value="Unknown / Legs">Unknown / Legs</option>
                         
                         <option value="Unknown / Loots">Unknown / Loots</option>
                         
                         <option value="Unknown / Luna Robe Bottoms">Unknown / Luna Robe Bottoms</option>
                         
                         <option value="Unknown / Luna Robe Top">Unknown / Luna Robe Top</option>
                         
                         <option value="Unknown / Magnifying Glass">Unknown / Magnifying Glass</option>
                         
                         <option value="Unknown / Medium Treasure Chest">Unknown / Medium Treasure Chest</option>
                         
                         <option value="Unknown / Necklace Of Speed">Unknown / Necklace Of Speed</option>
                         
                         <option value="Unknown / Ring Of Gathering">Unknown / Ring Of Gathering</option>
                         
                         <option value="Unknown / Ring Of Resistance">Unknown / Ring Of Resistance</option>
                         
                         <option value="Unknown / Royal Cloth">Unknown / Royal Cloth</option>
                         
                         <option value="Unknown / Small Treasure Chest">Unknown / Small Treasure Chest</option>
                         
                         <option value="Unknown / Sunstone">Unknown / Sunstone</option>
                         
                         <option value="Unknown / Tome Of Healing">Unknown / Tome Of Healing</option>
                         
                         <option value="Unknown / Toxic Pollen">Unknown / Toxic Pollen</option>
                         
                         <option value="Unknown / Vampire Fang Dirk">Unknown / Vampire Fang Dirk</option>
                         
                         <option value="Unknown / Watchful Relic">Unknown / Watchful Relic</option>
                         
                     </select>
                </div>
            </div>
            <div class="controls-right">
                <div class="sort-options" id="sort-options">
                    <span>Sort By:</span>
                    <button data-sort="name_asc" class="current-sort">Name</button>
                    <button data-sort="category_asc">Category</button>
                    <button data-sort="buy_desc">Buy</button>
                    <button data-sort="ask_asc">Ask</button>
                    <button data-sort="vendor_desc">Vendor</button>
                    <button data-sort="trend_dec">Trend %</button>
                </div>
            </div>
        </div>

        <div class="main-layout">
            <div class="item-table-container">
                <div id="loading-message" class="loading-message">Loading market data...</div>
                <div id="error-message" class="error-message" style="display: none;"></div>
                <div class="table-wrapper" style="display: none;">
                    <table id="item-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Buy</th>
                                <th>Ask</th>
                                <th>Vendor</th>
                                <th>Trend (24h)</th>
                            </tr>
                        </thead>
                        <tbody id="item-table-body">
                            </tbody>
                    </table>
                </div>
                <div class="pagination" id="pagination" style="display: none;">
                    <button id="prev-page" disabled>&laquo; Previous</button>
                    <span id="page-info">Page 1 of 1</span>
                    <button id="next-page" disabled>Next &raquo;</button>
                </div>
            </div>

            <div class="chart-display-container">
                <div class="chart-display" id="chart-display">
                    <div class="chart-placeholder" id="chart-placeholder">Select an item name from the table to view its chart.</div>
                    <div class="chart-plot" style="display: none;">
                        <canvas id="single-chart-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div> <footer>
        Created by Sporky
    </footer>

    <script>
        // --- Global State ---
        let allMarketData = []; // Holds raw history [{product, timestamp, buy, ask}, ...]
        let marketSummary = []; // Holds summary [{name, category, buy, ask, vendor, trend}, ...]
        let filteredAndSortedSummary = [];
        let currentChart = null;
        let currentPage = 1;
        const itemsPerPage = 20; // Keep consistent
        let currentSort = 'name_asc';
        let currentSearch = '';
        let currentCategoryFilter = 'All';
        let selectedTableRow = null; // Keep track of selected table row TR element

        // --- DOM Elements ---
        const tableBodyEl = document.getElementById('item-table-body');
        const tableWrapperEl = document.querySelector('.table-wrapper');
        const paginationEl = document.getElementById('pagination');
        const pageInfoEl = document.getElementById('page-info');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        const searchInput = document.getElementById('search-input');
        const categoryFilterEl = document.getElementById('category-filter');
        const sortOptionsEl = document.getElementById('sort-options');
        const chartCanvas = document.getElementById('single-chart-canvas');
        const chartPlotContainer = document.querySelector('.chart-plot');
        const chartPlaceholder = document.getElementById('chart-placeholder');
        const loadingMessageEl = document.getElementById('loading-message');
        const errorMessageEl = document.getElementById('error-message');

        // --- Utility Functions ---
        function formatPrice(price) {
            if (price === null || price === undefined || isNaN(price)) return '<span class="na-value">N/A</span>';
            return price.toLocaleString();
        }

        function formatTrend(trend) {
            if (trend === null || trend === undefined || isNaN(trend)) return '<span class="na-value">N/A</span>';
            const arrow = trend > 0 ? '▲' : trend < 0 ? '▼' : '';
            const trendClass = trend > 0 ? 'trend-positive' : trend < 0 ? 'trend-negative' : '';
            return `<span class="${trendClass}">${arrow} ${trend.toFixed(2)}%</span>`;
        }

        // --- Data Fetching ---
        async function loadData() {
            try {
                loadingMessageEl.style.display = 'block';
                errorMessageEl.style.display = 'none';
                tableWrapperEl.style.display = 'none';
                paginationEl.style.display = 'none';

                console.log("Fetching data files...");
                // Fetch data files generated by build_site.py
                const [historyRes, summaryRes] = await Promise.all([
                    fetch('./data/market_history.json'), // Contains [{product, timestamp, buy, ask}, ...]
                    fetch('./data/market_summary.json') // Contains [{name, category, buy, ask, vendor, trend}, ...]
                ]);
                console.log("Fetch responses received.");

                if (!historyRes.ok) throw new Error(`Failed to fetch market_history.json (Status: ${historyRes.status})`);
                if (!summaryRes.ok) throw new Error(`Failed to fetch market_summary.json (Status: ${summaryRes.status})`);

                console.log("Parsing JSON data...");
                allMarketData = await historyRes.json();
                marketSummary = await summaryRes.json();
                console.log(`Loaded ${allMarketData.length} history points and ${marketSummary.length} summary items.`);

                loadingMessageEl.style.display = 'none';
                tableWrapperEl.style.display = 'block'; // Show table wrapper
                paginationEl.style.display = 'block';
                applyFiltersAndSort(); // Initial display

            } catch (error) {
                console.error("Error loading data:", error);
                loadingMessageEl.style.display = 'none';
                errorMessageEl.textContent = `Error loading market data: ${error.message}. Please check file paths and network connection.`;
                errorMessageEl.style.display = 'block';
            }
        }

        // --- Filtering and Sorting ---
        function applyFiltersAndSort() {
            console.log(`Applying filter: "${currentSearch}", category: "${currentCategoryFilter}", sort: "${currentSort}"`);
            let result = [...marketSummary];

            // Apply category filter
            if (currentCategoryFilter !== 'All') {
                result = result.filter(item => item.category === currentCategoryFilter);
            }

            // Apply search filter
            const searchTerm = currentSearch.toLowerCase();
            if (searchTerm) {
                result = result.filter(item => item.name.toLowerCase().includes(searchTerm));
            }

            // Apply sorting
            result.sort((a, b) => {
                try {
                    // Helper for sorting numbers (nulls last)
                    const sortNum = (valA, valB, ascending = true) => {
                        const numA = valA ?? (ascending ? Infinity : -Infinity);
                        const numB = valB ?? (ascending ? Infinity : -Infinity);
                        return ascending ? numA - numB : numB - numA;
                    };
                    // Helper for sorting strings (nulls last)
                    const sortStr = (valA, valB, ascending = true) => {
                        const strA = valA ?? ''; const strB = valB ?? '';
                        const compare = strA.localeCompare(strB);
                        return ascending ? compare : -compare;
                    };

                    switch (currentSort) {
                        case 'name_desc': return sortStr(a.name, b.name, false);
                        case 'category_asc': return sortStr(a.category, b.category, true);
                        case 'buy_desc': return sortNum(a.buy, b.buy, false);
                        case 'ask_asc': return sortNum(a.ask, b.ask, true);
                        case 'vendor_desc': return sortNum(a.vendor, b.vendor, false);
                        case 'trend_inc': return sortNum(a.trend, b.trend, true);
                        case 'trend_dec': return sortNum(a.trend, b.trend, false);
                        case 'name_asc': default: return sortStr(a.name, b.name, true);
                    }
                } catch (e) { console.error("Sort comparison error:", e); return 0; }
            });

            filteredAndSortedSummary = result;
            console.log(`Filtered/Sorted result size: ${filteredAndSortedSummary.length}`);
            currentPage = 1;
            renderCurrentPage();
        }

        // --- Rendering ---
        function renderCurrentPage() {
            console.log(`Rendering page ${currentPage}`);
            tableBodyEl.innerHTML = ''; // Clear previous rows
            selectedTableRow = null; // Clear selection when page changes

            const totalItems = filteredAndSortedSummary.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            currentPage = Math.max(1, Math.min(currentPage, totalPages || 1));

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const itemsToDisplay = filteredAndSortedSummary.slice(startIndex, endIndex);
            console.log(`Displaying items ${startIndex} to ${endIndex-1}`);

            if (itemsToDisplay.length === 0) {
                 const message = currentSearch || currentCategoryFilter !== 'All' ? 'No items match your filters.' : 'No market data available.';
                 const tr = document.createElement('tr');
                 const td = document.createElement('td');
                 td.colSpan = 6; // Span all columns
                 td.textContent = message;
                 td.style.textAlign = 'center';
                 td.style.padding = '20px';
                 td.style.color = 'var(--muted-text-color)';
                 tr.appendChild(td);
                 tableBodyEl.appendChild(tr);
            } else {
                itemsToDisplay.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td data-product="${encodeURIComponent(item.name)}"><a>${item.name}</a></td>
                        <td>${item.category || 'N/A'}</td>
                        <td>${formatPrice(item.buy)}</td>
                        <td>${formatPrice(item.ask)}</td>
                        <td><span class="vendor-price">${formatPrice(item.vendor)}</span></td>
                        <td>${formatTrend(item.trend)}</td>
                    `;
                    // Add click listener to the first cell (product name)
                    tr.querySelector('td:first-child').addEventListener('click', handleProductClick);
                    tableBodyEl.appendChild(tr);
                });
            }
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            pageInfoEl.textContent = `Page ${currentPage} of ${totalPages || 1}`;
            prevButton.disabled = currentPage <= 1;
            nextButton.disabled = currentPage >= totalPages;
        }

        // --- Charting ---
        function displayChart(productName, clickedTrElement) { // Accept the TR element
            console.log("Requesting chart for:", productName);
            chartPlaceholder.style.display = 'none';
            chartPlotContainer.style.display = 'block';

            // --- Highlight selected item ---
            if (selectedTableRow) {
                selectedTableRow.classList.remove('selected-item');
            }
            if (clickedTrElement) {
                clickedTrElement.classList.add('selected-item');
                selectedTableRow = clickedTrElement;
            }
            // --- End Highlight ---

            const productHistory = allMarketData.filter(d => d.product === productName);

            if (!productHistory || productHistory.length < 1) {
                 if (currentChart) { currentChart.destroy(); currentChart = null; }
                 chartPlotContainer.innerHTML = `<p style="text-align:center; color: orange;">No historical data available for this item.</p><canvas id="single-chart-canvas" style="display:none;"></canvas>`;
                return;
            }

            productHistory.sort((a, b) => (a.timestamp < b.timestamp ? -1 : 1));
            const labels = productHistory.map(d => d.timestamp);
            const buyData = productHistory.map(d => d.buy);
            const askData = productHistory.map(d => d.ask);

            const chartData = {
                labels: labels,
                datasets: [
                    { label: 'Buy', data: buyData, borderColor: 'rgb(54, 162, 235)', tension: 0.1, pointRadius: 1, pointHoverRadius: 4, spanGaps: true, borderWidth: 1.5 },
                    { label: 'Ask', data: askData, borderColor: 'rgb(255, 99, 132)', tension: 0.1, pointRadius: 1, pointHoverRadius: 4, spanGaps: true, borderWidth: 1.5 }
                ]
            };

            if (currentChart) { currentChart.destroy(); }

            let canvasEl = document.getElementById('single-chart-canvas');
             if (!canvasEl) {
                 chartPlotContainer.innerHTML = '';
                 canvasEl = document.createElement('canvas');
                 canvasEl.id = 'single-chart-canvas';
                 chartPlotContainer.appendChild(canvasEl);
             }
             canvasEl.style.display = '';
             const errorP = chartPlotContainer.querySelector('p');
             if(errorP) errorP.remove();

            try {
                currentChart = new Chart(canvasEl, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: `Market Trend for ${productName}`, font: { size: 16, weight: '600' }, padding: { bottom: 15 } },
                            legend: { position: 'top' },
                            tooltip: { mode: 'index', intersect: false, bodySpacing: 4, titleSpacing: 6, padding: 10 }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Time' }, grid: { display: false } },
                            y: { beginAtZero: false, title: { display: true, text: 'Price' }, grid: { color: '#e9ecef' } }
                        },
                        interaction: { mode: 'nearest', axis: 'x', intersect: false },
                    }
                });
            } catch(e) {
                 console.error("Error creating Chart.js instance:", e);
                 chartPlotContainer.innerHTML = '<p style="text-align:center; color: red;">Error rendering chart.</p>';
            }
        }


        // --- Event Handlers ---
        function handleProductClick(event) {
            // Use currentTarget to get the TD, then parent TR
            const clickedTr = event.currentTarget.closest('tr');
            const productName = decodeURIComponent(event.currentTarget.dataset.product);
            displayChart(productName, clickedTr); // Pass the TR element
        }

        let searchTimeout;
        searchInput.addEventListener('input', (event) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = event.target.value;
                applyFiltersAndSort();
            }, 300);
        });

        categoryFilterEl.addEventListener('change', (event) => {
             currentCategoryFilter = event.target.value;
             applyFiltersAndSort();
        });

        sortOptionsEl.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON' && event.target.dataset.sort) {
                const newSort = event.target.dataset.sort;
                // Allow clicking same sort button to reverse (optional)
                // if (newSort === currentSort) { ... handle reverse ... }
                currentSort = newSort; // Simple set for now
                sortOptionsEl.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('current-sort', btn.dataset.sort === currentSort);
                });
                applyFiltersAndSort();
            }
        });

        prevButton.addEventListener('click', () => {
            if (currentPage > 1) { currentPage--; renderCurrentPage(); }
        });

        nextButton.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredAndSortedSummary.length / itemsPerPage);
            if (currentPage < totalPages) { currentPage++; renderCurrentPage(); }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', loadData);

    </script>

</body>
</html>